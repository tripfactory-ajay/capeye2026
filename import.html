<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Import | Auto Capital</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="./firebase-config.js"></script>
<script src="./ac-data.js"></script>
<style>
:root{--bg:#f4f6f9;--bg2:#fff;--bg3:#f0f2f6;--border:#e2e6ed;--border2:#c8d0dc;--red:#C8102E;--red2:#a00d24;--red-light:rgba(200,16,46,.07);--blue:#003DA5;--blue2:#002d7a;--blue-light:rgba(0,61,165,.07);--gold:#d4980a;--green:#1a7f37;--green-light:rgba(26,127,55,.07);--orange:#d4600a;--text:#0f1923;--text2:#3d4d5c;--muted:#7a8fa6;--shadow:0 1px 3px rgba(0,0,0,.07),0 4px 16px rgba(0,0,0,.04);--shadow-md:0 4px 12px rgba(0,0,0,.1),0 12px 40px rgba(0,0,0,.07);--card-radius:12px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;-webkit-font-smoothing:antialiased}
.header{background:#fff;border-bottom:2px solid var(--border);padding:0 24px;height:68px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:200;box-shadow:0 2px 8px rgba(0,0,0,.06)}
.logo-area{display:flex;align-items:center;gap:14px;flex-shrink:0}
.logo-img{height:44px;width:auto;object-fit:contain}
.logo-divider{width:1px;height:34px;background:var(--border);flex-shrink:0}
.system-name{font-size:11px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:var(--blue);white-space:nowrap}
.nav{display:flex;gap:2px;overflow-x:auto}
.nav a{padding:8px 11px;border-radius:7px;font-size:12px;font-weight:500;color:var(--muted);text-decoration:none;transition:all .18s;display:flex;align-items:center;gap:5px;white-space:nowrap}
.nav a i{font-size:11px}
.nav a:hover{background:var(--bg3);color:var(--text)}
.nav a.active{background:var(--red);color:#fff;font-weight:700}
.toolbar{display:flex;gap:4px;align-items:center;flex-shrink:0;border-left:1px solid var(--border);border-right:1px solid var(--border);padding:0 12px;margin:0 8px}
.tlink{padding:6px 10px;border-radius:6px;font-size:11px;font-weight:700;color:var(--muted);text-decoration:none;transition:all .18s;display:flex;align-items:center;gap:5px;white-space:nowrap;border:1px solid transparent}
.tlink:hover{background:var(--blue);color:#fff;border-color:var(--blue)}
.last-import{font-size:10px;color:var(--muted);background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:4px 9px;display:flex;align-items:center;gap:5px;white-space:nowrap}
.last-import.fresh{color:var(--green);border-color:var(--green);background:var(--green-light)}
.last-import.stale{color:var(--orange);border-color:var(--orange);background:rgba(212,96,10,.07)}
.header-right{display:flex;align-items:center;gap:10px;flex-shrink:0}
.user-badge{background:var(--blue);color:#fff;font-weight:700;font-size:11px;padding:5px 12px;border-radius:20px;letter-spacing:1px;text-transform:uppercase}
.btn-logout{background:transparent;border:1px solid var(--border2);color:var(--muted);padding:6px 10px;border-radius:7px;cursor:pointer;font-size:12px;font-family:'DM Sans',sans-serif}
.btn-logout:hover{color:var(--red);border-color:var(--red)}
.main{max-width:1400px;margin:0 auto;padding:28px}
.page-hdr{margin-bottom:24px;display:flex;align-items:flex-end;justify-content:space-between;flex-wrap:wrap;gap:14px}
.page-hdr h1{font-size:26px;font-weight:800}
.page-hdr h1 .r{color:var(--red)}
.page-hdr p{color:var(--muted);font-size:13px;margin-top:3px}
/* IMPORT TYPE TABS */
.import-tabs{display:flex;gap:8px;margin-bottom:24px}
.itab{padding:14px 24px;border-radius:12px;font-size:14px;font-weight:700;cursor:pointer;border:2px solid var(--border);background:#fff;color:var(--muted);transition:all .2s;display:flex;align-items:center;gap:10px;flex:1;max-width:280px}
.itab i{font-size:18px}
.itab.active{border-color:var(--blue);color:var(--blue);background:var(--blue-light)}
.itab-panel{display:none}.itab-panel.active{display:block}
/* DROP ZONE */
.drop-zone{border:2px dashed var(--border2);border-radius:16px;padding:48px 32px;text-align:center;cursor:pointer;transition:all .2s;background:#fff;margin-bottom:20px}
.drop-zone:hover,.drop-zone.drag-over{border-color:var(--blue);background:var(--blue-light)}
.drop-icon{font-size:48px;color:var(--border2);margin-bottom:16px;transition:color .2s}
.drop-zone:hover .drop-icon,.drop-zone.drag-over .drop-icon{color:var(--blue)}
.drop-title{font-size:18px;font-weight:700;margin-bottom:6px}
.drop-sub{font-size:13px;color:var(--muted);margin-bottom:18px}
/* SUMMARY */
.summary-row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px}
.sum-card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:16px 20px;text-align:center;border-top:3px solid var(--c,var(--border))}
.sum-val{font-size:36px;font-weight:800;line-height:1;margin-bottom:4px}
.sum-label{font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--muted)}
/* CARD */
.card{background:#fff;border:1px solid var(--border);border-radius:var(--card-radius);overflow:hidden;margin-bottom:16px;box-shadow:var(--shadow)}
.card-header{padding:14px 18px;border-bottom:1px solid var(--border);background:var(--bg3);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px}
.card-title{font-size:14px;font-weight:700;color:var(--text2)}
/* TABLE */
.ac-table{width:100%;border-collapse:collapse;font-size:12px}
.ac-table th{padding:9px 12px;text-align:left;font-size:10px;letter-spacing:1px;text-transform:uppercase;color:var(--muted);font-weight:700;border-bottom:1px solid var(--border);background:var(--bg3);white-space:nowrap;position:sticky;top:0}
.ac-table td{padding:9px 12px;border-bottom:1px solid var(--border);vertical-align:middle}
.ac-table tr:last-child td{border-bottom:none}
.ac-table tbody tr:hover td{background:var(--blue-light)}
/* BADGES */
.badge{display:inline-flex;align-items:center;padding:3px 8px;border-radius:6px;font-size:10px;font-weight:800;letter-spacing:.5px;white-space:nowrap}
.b-new{background:rgba(26,127,55,.12);color:var(--green)}
.b-update{background:rgba(212,152,10,.12);color:var(--gold)}
.b-same{background:var(--bg3);color:var(--muted)}
.b-flag{background:var(--red-light);color:var(--red)}
/* FLAG */
.flag-section{background:var(--red-light);border:1px solid rgba(200,16,46,.15);border-radius:12px;padding:16px 20px;margin-bottom:16px}
.flag-title{font-weight:700;color:var(--red);margin-bottom:8px;display:flex;align-items:center;gap:8px}
/* HISTORY */
.hist-row{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border);font-size:13px}
.hist-row:last-child{border-bottom:none}
.hist-icon{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
/* BUTTONS */
.btn{padding:9px 18px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;border:none;font-family:'DM Sans',sans-serif;transition:all .2s;display:inline-flex;align-items:center;gap:7px}
.btn-primary{background:var(--blue);color:#fff}.btn-primary:hover{background:var(--blue2)}
.btn-ghost{background:var(--bg3);border:1px solid var(--border);color:var(--muted)}.btn-ghost:hover{color:var(--text)}
.btn-accent{background:var(--green);color:#fff}.btn-accent:hover{opacity:.9}
.btn-danger{background:var(--red-light);color:var(--red);border:1px solid rgba(200,16,46,.2)}.btn-danger:hover{background:rgba(200,16,46,.2)}
.btn-sm{padding:6px 12px;font-size:12px;border-radius:6px}
/* TOAST */
.toast{position:fixed;bottom:24px;right:24px;color:#fff;border-radius:10px;z-index:9999;font-size:13px;font-weight:600;padding:12px 20px;animation:slideUp .2s ease;box-shadow:var(--shadow-md);display:flex;align-items:center;gap:10px}
@keyframes slideUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
</style>
</head>
<body>

<header class="header">
  <div class="logo-area">
    <img class="logo-img" src="./auto-capital-logo.png" alt="Auto Capital" onerror="this.style.opacity=0">
    <div class="logo-divider"></div>
    <span class="system-name">Back Office</span>
  </div>
  <nav class="nav">
    <a href="./index.html"><i class="fas fa-th-large"></i> Dashboard</a>
    <a href="./inventory.html"><i class="fas fa-car"></i> Inventory</a>
    <a href="./workflow.html"><i class="fas fa-tasks"></i> Workflow</a>
    <a href="./alerts.html"><i class="fas fa-bell"></i> Alerts</a>
    <a href="./analytics.html"><i class="fas fa-chart-bar"></i> Analytics</a>
    <a href="./marketing.html"><i class="fas fa-chart-line"></i> Marketing</a>
    <a href="./keys.html"><i class="fas fa-key"></i> Keys</a>
    <a href="./import.html" class="active"><i class="fas fa-upload"></i> Import</a>
    <a href="./team.html"><i class="fas fa-users"></i> Team</a>
    <a href="./admin.html"><i class="fas fa-cog"></i> Admin</a>
  </nav>
  <div class="toolbar">
    <a href="https://trade.hpi.co.uk/trade/preLogin.do" target="_blank" class="tlink"><i class="fas fa-search-dollar"></i> HPI</a>
    <a href="https://www.autocapital.co.uk/" target="_blank" class="tlink"><i class="fas fa-globe"></i> Website</a>
    <a href="https://www.autocapital.co.uk/finance.php" target="_blank" class="tlink"><i class="fas fa-file-invoice-pound"></i> Finance</a>
  </div>
  <div class="header-right">
    <div class="last-import" id="lastImportBadge"><i class="fas fa-database"></i> <span id="lastImportTime">No import</span></div>
    <span id="userBadge" class="user-badge">Auto Capital</span>
    <button class="btn-logout" onclick="doLogout()"><i class="fas fa-sign-out-alt"></i></button>
  </div>
</header>

<main class="main">
  <div class="page-hdr">
    <div>
      <h1>Data <span class="r">Import</span></h1>
      <p>Upload daily exports to keep stock and keys data current &middot; Smart merge: new vehicles added, existing updated, duplicates skipped</p>
    </div>
  </div>

  <!-- IMPORT TYPE TABS -->
  <div class="import-tabs">
    <div class="itab active" id="itab-stock" onclick="setImportTab('stock')">
      <i class="fas fa-car" style="color:var(--blue)"></i>
      <div><div style="font-size:14px;font-weight:700">ClickDealer Stock</div><div style="font-size:11px;font-weight:400;color:var(--muted);margin-top:2px">Vehicle inventory CSV</div></div>
    </div>
    <div class="itab" id="itab-etrack" onclick="setImportTab('etrack')">
      <i class="fas fa-key" style="color:var(--gold)"></i>
      <div><div style="font-size:14px;font-weight:700">eTrack Keys</div><div style="font-size:11px;font-weight:400;color:var(--muted);margin-top:2px">Key management CSV</div></div>
    </div>
  </div>

  <!-- â•â• STOCK IMPORT PANEL â•â• -->
  <div class="itab-panel active" id="panel-stock">
    <div class="drop-zone" id="stockDropZone"
         ondragover="event.preventDefault();this.classList.add('drag-over')"
         ondragleave="this.classList.remove('drag-over')"
         ondrop="handleStockDrop(event)"
         onclick="document.getElementById('stockCsvInput').click()">
      <div class="drop-icon"><i class="fas fa-car"></i></div>
      <div class="drop-title">Drop ClickDealer CSV here</div>
      <div class="drop-sub">Daily vehicle stock export &middot; CSV format &middot; Smart merge applied automatically</div>
      <button class="btn btn-primary" onclick="event.stopPropagation();document.getElementById('stockCsvInput').click()"><i class="fas fa-folder-open"></i> Choose File</button>
      <input type="file" id="stockCsvInput" accept=".csv" style="display:none" onchange="handleStockFile(this)">
    </div>

    <!-- PREVIEW (hidden until loaded) -->
    <div id="stockPreviewArea" style="display:none">
      <div class="summary-row">
        <div class="sum-card" style="--c:var(--green)"><div class="sum-val" id="sNew" style="color:var(--green)">0</div><div class="sum-label">âœ¦ New Vehicles</div></div>
        <div class="sum-card" style="--c:var(--gold)"><div class="sum-val" id="sUpdate" style="color:var(--gold)">0</div><div class="sum-label">â†» Updated</div></div>
        <div class="sum-card" style="--c:var(--muted)"><div class="sum-val" id="sUnchanged" style="color:var(--muted)">0</div><div class="sum-label">â€” Unchanged</div></div>
        <div class="sum-card" style="--c:var(--red)"><div class="sum-val" id="sFlagged" style="color:var(--red)">0</div><div class="sum-label">âš‘ Not in CSV</div></div>
      </div>
      <div class="flag-section" id="stockFlagSection" style="display:none">
        <div class="flag-title"><i class="fas fa-exclamation-triangle"></i> In system but NOT in new CSV â€” not deleted, review manually</div>
        <div style="overflow-x:auto;margin-top:10px"><table class="ac-table" id="stockFlagTable"></table></div>
      </div>
      <div class="card">
        <div class="card-header">
          <span class="card-title">Import Preview &mdash; <span id="stockFilename" style="color:var(--blue);font-weight:400"></span></span>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <span class="badge b-new">âœ¦ New</span>
            <span class="badge b-update">â†» Updated</span>
            <span class="badge b-same">â€” Same</span>
            <button class="btn btn-ghost btn-sm" onclick="cancelStockImport()"><i class="fas fa-times"></i> Cancel</button>
            <button class="btn btn-accent btn-sm" onclick="doStockImport()"><i class="fas fa-check"></i> Apply Import</button>
          </div>
        </div>
        <div style="overflow-x:auto;max-height:460px;overflow-y:auto">
          <table class="ac-table">
            <thead><tr><th>Status</th><th>Stock No</th><th>Reg</th><th>Make / Model</th><th>Colour</th><th>Fuel</th><th>Mileage</th><th>Price</th><th>Location</th></tr></thead>
            <tbody id="stockPreviewBody"></tbody>
          </table>
        </div>
        <div style="padding:10px 16px;border-top:1px solid var(--border);font-size:12px;color:var(--muted)" id="stockPreviewFooter"></div>
      </div>
    </div>

    <!-- IMPORT HISTORY -->
    <div class="card">
      <div class="card-header"><span class="card-title"><i class="fas fa-history" style="color:var(--blue);margin-right:6px"></i>Stock Import History</span></div>
      <div style="padding:16px 20px" id="stockHistoryList">
        <div style="color:var(--muted);font-size:13px;text-align:center;padding:20px 0">No imports yet</div>
      </div>
    </div>

    <!-- HOW IT WORKS -->
    <div class="card">
      <div class="card-header"><span class="card-title">ðŸ“‹ How Smart Merge Works</span></div>
      <div style="padding:20px;display:grid;grid-template-columns:repeat(4,1fr);gap:16px;font-size:13px">
        <div><div style="font-size:20px;margin-bottom:6px">âœ¦</div><div style="font-weight:700;color:var(--green);margin-bottom:4px">New Vehicle</div><div style="color:var(--muted)">Stock number not seen before â€” added to the system</div></div>
        <div><div style="font-size:20px;margin-bottom:6px">â†»</div><div style="font-weight:700;color:var(--gold);margin-bottom:4px">Updated</div><div style="color:var(--muted)">Exists but CSV has different data â€” fields updated</div></div>
        <div><div style="font-size:20px;margin-bottom:6px">â€”</div><div style="font-weight:700;color:var(--muted);margin-bottom:4px">Unchanged</div><div style="color:var(--muted)">Exists and matches â€” no changes made</div></div>
        <div><div style="font-size:20px;margin-bottom:6px">âš‘</div><div style="font-weight:700;color:var(--red);margin-bottom:4px">Not in CSV</div><div style="color:var(--muted)">In system but missing â€” flagged, not deleted</div></div>
      </div>
    </div>
  </div>

  <!-- â•â• ETRACK IMPORT PANEL â•â• -->
  <div class="itab-panel" id="panel-etrack">
    <div class="drop-zone" id="etrackDropZone"
         ondragover="event.preventDefault();this.classList.add('drag-over')"
         ondragleave="this.classList.remove('drag-over')"
         ondrop="handleEtrackDrop(event)"
         onclick="document.getElementById('etrackCsvInput').click()">
      <div class="drop-icon"><i class="fas fa-key" style="color:var(--gold)"></i></div>
      <div class="drop-title">Drop eTrack Keys CSV here</div>
      <div class="drop-sub">eTrack daily export &middot; Automatically detects Keys Out / Keys In / Staff / Audit tabs &middot; Multiple files supported</div>
      <button class="btn btn-primary" onclick="event.stopPropagation();document.getElementById('etrackCsvInput').click()"><i class="fas fa-folder-open"></i> Choose File(s)</button>
      <input type="file" id="etrackCsvInput" accept=".csv" style="display:none" multiple onchange="handleEtrackFiles(this)">
    </div>

    <div id="etrackPreviewArea" style="display:none">
      <div class="summary-row">
        <div class="sum-card" style="--c:var(--blue)"><div class="sum-val" id="etKeys" style="color:var(--blue)">0</div><div class="sum-label">Keys Loaded</div></div>
        <div class="sum-card" style="--c:var(--red)"><div class="sum-val" id="etOut" style="color:var(--red)">0</div><div class="sum-label">Keys Out</div></div>
        <div class="sum-card" style="--c:var(--green)"><div class="sum-val" id="etIn" style="color:var(--green)">0</div><div class="sum-label">Keys In</div></div>
        <div class="sum-card" style="--c:var(--gold)"><div class="sum-val" id="etStaff" style="color:var(--gold)">0</div><div class="sum-label">Staff Records</div></div>
      </div>
      <div class="card">
        <div class="card-header">
          <span class="card-title">eTrack Preview &mdash; <span id="etrackFilename" style="color:var(--gold);font-weight:400"></span></span>
          <div style="display:flex;gap:8px">
            <button class="btn btn-ghost btn-sm" onclick="cancelEtrackImport()"><i class="fas fa-times"></i> Cancel</button>
            <button class="btn btn-accent btn-sm" onclick="doEtrackImport()"><i class="fas fa-check"></i> Apply Keys Import</button>
          </div>
        </div>
        <div style="overflow-x:auto;max-height:400px;overflow-y:auto">
          <table class="ac-table">
            <thead><tr><th>Reg / Key</th><th>Description</th><th>Position</th><th>Status</th><th>Last Action</th><th>Date</th></tr></thead>
            <tbody id="etrackPreviewBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ETRACK HISTORY -->
    <div class="card">
      <div class="card-header"><span class="card-title"><i class="fas fa-history" style="color:var(--gold);margin-right:6px"></i>Keys Import History</span></div>
      <div style="padding:16px 20px" id="etrackHistoryList">
        <div style="color:var(--muted);font-size:13px;text-align:center;padding:20px 0">No imports yet</div>
      </div>
    </div>
  </div>

</main>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   IMPORT PAGE â€” Full JS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ TAB SWITCHING â”€â”€ */
function setImportTab(t) {
  ['stock','etrack'].forEach(id => {
    document.getElementById('itab-'+id).classList.toggle('active', id===t);
    document.getElementById('panel-'+id).classList.toggle('active', id===t);
  });
}

/* â”€â”€ HELPERS â”€â”€ */
function parseCSV(text) {
  const lines = text.trim().split(/\r?\n/);
  if (!lines.length) return [];
  const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g,'').trim());
  return lines.slice(1).filter(l=>l.trim()).map(line => {
    const cols = [];
    let cur='', inQ=false;
    for (let i=0;i<line.length;i++) {
      const ch=line[i];
      if(ch==='"'){inQ=!inQ;}
      else if(ch===','&&!inQ){cols.push(cur.trim());cur='';}
      else{cur+=ch;}
    }
    cols.push(cur.trim());
    const obj={};
    headers.forEach((h,i) => { obj[h]=cols[i]||''; });
    return obj;
  });
}

function toast(msg, bg) {
  document.querySelectorAll('.toast').forEach(t=>t.remove());
  const t=document.createElement('div'); t.className='toast';
  t.style.background=bg||'var(--blue)'; t.innerHTML=msg;
  document.body.appendChild(t); setTimeout(()=>t.remove(),4000);
}

function fmtDate(d) { return new Date(d).toLocaleString('en-GB',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'}); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STOCK / CLICKDEALER IMPORT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let stockParsed = [];
let stockCurrent = [];

/* Map ClickDealer CSV columns to our internal fields */
function mapStockRow(row) {
  // Try many possible column name variants from ClickDealer exports
  const get = (...keys) => { for(const k of keys){ if(row[k]!==undefined&&row[k]!=='') return row[k]; } return ''; };
  return {
    stockNo:      get('Stock No','StockNo','stock_no','Stock Number','stockNo','Reference','Ref'),
    registration: get('Registration','Reg','VRM','Plate','registration'),
    regDate:      get('Reg Date','RegDate','First Reg','First Registration','reg_date'),
    make:         get('Make','Manufacturer','make'),
    model:        get('Model','model'),
    variant:      get('Variant','Derivative','Version','variant','Description'),
    colour:       get('Colour','Color','colour','color'),
    mileage:      get('Mileage','Miles','mileage'),
    body:         get('Body','Body Style','body','Body Type'),
    doors:        get('Doors','doors'),
    fuel:         get('Fuel','Fuel Type','fuel'),
    gearbox:      get('Gearbox','Transmission','gearbox'),
    fsh:          get('FSH','Service History','Full Service History','fsh'),
    rfl:          get('Road Tax','RFL','Tax','rfl'),
    mot:          get('MOT','MOT Expiry','mot'),
    price:        parseFloat(get('Price','Retail Price','Asking Price','price','Sale Price')||0)||0,
    status:       get('Status','Vehicle Status','status')||'In Stock',
    location:     get('Location','Site','location'),
    dateAdded:    get('Date Added','Added','Purchase Date','dateAdded')||new Date().toISOString().slice(0,10),
  };
}

function vehiclesMatch(a, b) {
  const fields = ['registration','make','model','colour','mileage','price','status','location'];
  return fields.every(f => String(a[f]||'').trim() === String(b[f]||'').trim());
}

function handleStockDrop(e) {
  e.preventDefault();
  document.getElementById('stockDropZone').classList.remove('drag-over');
  const file = e.dataTransfer.files[0];
  if(file) processStockFile(file);
}
function handleStockFile(input) { if(input.files[0]) processStockFile(input.files[0]); }

function processStockFile(file) {
  document.getElementById('stockFilename').textContent = file.name;
  const reader = new FileReader();
  reader.onload = e => {
    const rows = parseCSV(e.target.result);
    stockParsed = rows.map(mapStockRow).filter(r => r.stockNo || r.registration);
    stockCurrent = getVehicles();
    analyseSockImport();
  };
  reader.readAsText(file);
}

function analyseSockImport() {
  if(!stockParsed.length) { toast('<i class="fas fa-exclamation-triangle"></i> No valid rows found â€” check CSV format','var(--orange)'); return; }
  const currentMap = {};
  stockCurrent.forEach(v => { currentMap[v.stockNo] = v; });
  const csvKeys = new Set(stockParsed.map(r => r.stockNo).filter(Boolean));
  let newCount=0, updateCount=0, sameCount=0;
  const rows = stockParsed.map(r => {
    const existing = currentMap[r.stockNo];
    if(!existing) { newCount++; return {...r, _status:'new'}; }
    if(vehiclesMatch(existing, r)) { sameCount++; return {...r, _status:'same'}; }
    updateCount++; return {...r, _status:'update'};
  });
  const flagged = stockCurrent.filter(v => v.stockNo && !csvKeys.has(v.stockNo));
  document.getElementById('sNew').textContent = newCount;
  document.getElementById('sUpdate').textContent = updateCount;
  document.getElementById('sUnchanged').textContent = sameCount;
  document.getElementById('sFlagged').textContent = flagged.length;

  // Flag table
  const fs = document.getElementById('stockFlagSection');
  if(flagged.length) {
    fs.style.display='block';
    document.getElementById('stockFlagTable').innerHTML =
      '<thead><tr><th>Stock No</th><th>Reg</th><th>Make/Model</th><th>Status</th><th>Location</th></tr></thead><tbody>' +
      flagged.map(v=>`<tr><td style="font-weight:700;color:var(--blue)">${v.stockNo}</td><td><span style="font-family:'DM Mono',monospace;background:#fff9db;color:#7a5c00;padding:2px 6px;border-radius:4px;border:1px solid #e6d080">${v.registration}</span></td><td>${v.make} ${v.model}</td><td>${v.status||'â€”'}</td><td style="color:var(--muted)">${v.location||'â€”'}</td></tr>`).join('') +
      '</tbody>';
  } else { fs.style.display='none'; }

  // Preview table
  const statusCfg = {new:{cls:'b-new',txt:'âœ¦ New'},update:{cls:'b-update',txt:'â†» Updated'},same:{cls:'b-same',txt:'â€” Same'}};
  document.getElementById('stockPreviewBody').innerHTML = rows.map(r => {
    const sc=statusCfg[r._status]||statusCfg.same;
    return `<tr>
      <td><span class="badge ${sc.cls}">${sc.txt}</span></td>
      <td style="font-weight:700;color:var(--blue);font-size:11px">${r.stockNo||'â€”'}</td>
      <td><span style="font-family:'DM Mono',monospace;font-size:11px;background:#fff9db;color:#7a5c00;padding:2px 6px;border-radius:4px;border:1px solid #e6d080">${r.registration||'â€”'}</span></td>
      <td>${r.make} ${r.model}<span style="color:var(--muted);font-size:11px;margin-left:4px">${r.variant||''}</span></td>
      <td style="font-size:12px">${r.colour||'â€”'}</td>
      <td style="font-size:12px">${r.fuel||'â€”'}</td>
      <td style="font-size:12px">${r.mileage?Number(r.mileage).toLocaleString()+'mi':'â€”'}</td>
      <td style="font-weight:700">${r.price?'Â£'+Number(r.price).toLocaleString():'â€”'}</td>
      <td style="font-size:12px;color:var(--muted)">${r.location||'â€”'}</td>
    </tr>`;
  }).join('');
  document.getElementById('stockPreviewFooter').textContent = `${rows.length} vehicles in CSV Â· ${flagged.length} flagged as missing`;
  document.getElementById('stockPreviewArea').style.display='block';
  document.getElementById('stockPreviewArea').scrollIntoView({behavior:'smooth',block:'start'});
}

function doStockImport() {
  if(!stockParsed.length) return;
  const currentMap = {};
  stockCurrent.forEach(v => { if(v.stockNo) currentMap[v.stockNo]=v; });
  const merged = [];
  let newC=0, upC=0;
  stockParsed.forEach(r => {
    const existing = currentMap[r.stockNo];
    if(!existing) { newC++; merged.push({...r,daysInStock:0,dateAdded:r.dateAdded||new Date().toISOString().slice(0,10)}); }
    else { upC++; merged.push({...existing,...r}); }
    delete currentMap[r.stockNo];
  });
  // Keep flagged vehicles
  Object.values(currentMap).forEach(v => merged.push(v));
  localStorage.setItem('ac_vehicles', JSON.stringify(merged));
  const ts = Date.now();
  localStorage.setItem('ac_import_clickdealer_ts', ts);
  // Save to history
  const hist = JSON.parse(localStorage.getItem('ac_import_stock_history')||'[]');
  hist.unshift({ts, filename:document.getElementById('stockFilename').textContent, newCount:newC, updateCount:upC, total:stockParsed.length});
  localStorage.setItem('ac_import_stock_history', JSON.stringify(hist.slice(0,20)));
  toast(`<i class="fas fa-check-circle"></i> Import complete Â· ${newC} new Â· ${upC} updated Â· ${merged.length} total`, 'var(--green)');
  cancelStockImport();
  renderStockHistory();
  updateLastImportBadge();
}

function cancelStockImport() {
  document.getElementById('stockPreviewArea').style.display='none';
  document.getElementById('stockCsvInput').value='';
  stockParsed=[];
}

function renderStockHistory() {
  const hist = JSON.parse(localStorage.getItem('ac_import_stock_history')||'[]');
  const el = document.getElementById('stockHistoryList');
  if(!hist.length) { el.innerHTML='<div style="color:var(--muted);font-size:13px;text-align:center;padding:20px 0">No imports yet</div>'; return; }
  el.innerHTML = hist.map(h=>`
    <div class="hist-row">
      <div class="hist-icon" style="background:var(--blue-light);color:var(--blue)"><i class="fas fa-car"></i></div>
      <div style="flex:1"><div style="font-weight:700;font-size:13px">${h.filename||'ClickDealer CSV'}</div>
      <div style="font-size:12px;color:var(--muted)">${h.total} vehicles Â· <span style="color:var(--green)">${h.newCount} new</span> Â· <span style="color:var(--gold)">${h.updateCount} updated</span></div></div>
      <div style="font-size:11px;color:var(--muted);text-align:right">${fmtDate(h.ts)}</div>
    </div>`).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ETRACK IMPORT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let etrackData = {keys:[],staff:[],audit:[]};

function handleEtrackDrop(e) {
  e.preventDefault();
  document.getElementById('etrackDropZone').classList.remove('drag-over');
  handleEtrackFiles({files: e.dataTransfer.files});
}
function handleEtrackFiles(input) {
  if(!input.files||!input.files.length) return;
  const files = Array.from(input.files);
  const names = files.map(f=>f.name).join(', ');
  document.getElementById('etrackFilename').textContent = names;
  etrackData = {keys:[],staff:[],audit:[]};
  let loaded = 0;
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = e => {
      classifyEtrackCSV(file.name, e.target.result);
      loaded++;
      if(loaded===files.length) renderEtrackPreview();
    };
    reader.readAsText(file);
  });
}

function classifyEtrackCSV(filename, text) {
  const rows = parseCSV(text);
  if(!rows.length) return;
  const headers = Object.keys(rows[0]).map(h=>h.toLowerCase());
  // Detect type by headers
  const isAudit = headers.some(h=>h.includes('action')||h.includes('audit')||h.includes('event'));
  const isStaff = headers.some(h=>h.includes('name')||h.includes('staff')||h.includes('employee')) && rows.length < 50;
  const isKeys  = headers.some(h=>h.includes('reg')||h.includes('key')||h.includes('position')||h.includes('description'));
  if(isAudit) etrackData.audit.push(...rows);
  else if(isStaff && !isKeys) etrackData.staff.push(...rows);
  else etrackData.keys.push(...rows);
}

function mapEtrackKey(row) {
  const get = (...keys) => { for(const k of keys){ const found=Object.keys(row).find(r=>r.toLowerCase().includes(k.toLowerCase())); if(found&&row[found]!==undefined&&row[found]!=='')return row[found]; } return ''; };
  const status = get('Status','In Out','Out In','Key Status');
  return {
    registration: get('Reg','Registration','VRM','Vehicle','Plate'),
    description:  get('Description','Key Desc','Notes','Details','Make Model','Vehicle Desc'),
    position:     get('Position','Box','Location','Key Position','Bay'),
    status:       /out/i.test(status)?'Out':'In',
    staff:        get('Staff','Person','Name','Taken By','Signed By','User'),
    date:         get('Date','Time','DateTime','Last Action','Date Out','Date In','Timestamp'),
  };
}

function renderEtrackPreview() {
  const keys = etrackData.keys.map(mapEtrackKey).filter(k=>k.registration||k.description);
  const out = keys.filter(k=>k.status==='Out').length;
  const inK = keys.filter(k=>k.status==='In').length;
  document.getElementById('etKeys').textContent = keys.length;
  document.getElementById('etOut').textContent = out;
  document.getElementById('etIn').textContent = inK;
  document.getElementById('etStaff').textContent = etrackData.staff.length;
  document.getElementById('etrackPreviewBody').innerHTML = keys.slice(0,100).map(k=>`<tr>
    <td><span style="font-family:'DM Mono',monospace;font-size:11px;background:#fff9db;color:#7a5c00;padding:2px 6px;border-radius:4px;border:1px solid #e6d080">${k.registration||'â€”'}</span></td>
    <td style="font-size:12px">${k.description||'â€”'}</td>
    <td style="font-size:12px;color:var(--muted)">${k.position||'â€”'}</td>
    <td><span class="badge ${k.status==='Out'?'b-flag':'b-new'}">${k.status}</span></td>
    <td style="font-size:12px;color:var(--muted)">${k.staff||'â€”'}</td>
    <td style="font-size:12px;color:var(--muted)">${k.date||'â€”'}</td>
  </tr>`).join('') || '<tr><td colspan="6" style="text-align:center;padding:24px;color:var(--muted)">No key records found â€” check CSV format</td></tr>';
  if(keys.length>100) document.getElementById('etrackPreviewBody').innerHTML += `<tr><td colspan="6" style="text-align:center;padding:10px;color:var(--muted);font-size:12px">Showing 100 of ${keys.length} rows</td></tr>`;
  document.getElementById('etrackPreviewArea').style.display='block';
  document.getElementById('etrackPreviewArea').scrollIntoView({behavior:'smooth',block:'start'});
}

function doEtrackImport() {
  const keys = etrackData.keys.map(mapEtrackKey).filter(k=>k.registration||k.description);
  if(!keys.length) { toast('<i class="fas fa-exclamation-triangle"></i> No key data found','var(--orange)'); return; }
  localStorage.setItem('ac_keys_data', JSON.stringify(keys));
  if(etrackData.staff.length) localStorage.setItem('ac_etrack_staff', JSON.stringify(etrackData.staff));
  if(etrackData.audit.length) localStorage.setItem('ac_etrack_audit', JSON.stringify(etrackData.audit));
  const ts = Date.now();
  localStorage.setItem('ac_import_etrack_ts', ts);
  const hist = JSON.parse(localStorage.getItem('ac_import_etrack_history')||'[]');
  hist.unshift({ts, filename:document.getElementById('etrackFilename').textContent, total:keys.length, out:keys.filter(k=>k.status==='Out').length});
  localStorage.setItem('ac_import_etrack_history', JSON.stringify(hist.slice(0,20)));
  toast(`<i class="fas fa-check-circle"></i> Keys imported Â· ${keys.length} records Â· ${keys.filter(k=>k.status==='Out').length} out`, 'var(--green)');
  cancelEtrackImport();
  renderEtrackHistory();
  updateLastImportBadge();
}

function cancelEtrackImport() {
  document.getElementById('etrackPreviewArea').style.display='none';
  document.getElementById('etrackCsvInput').value='';
  etrackData={keys:[],staff:[],audit:[]};
}

function renderEtrackHistory() {
  const hist = JSON.parse(localStorage.getItem('ac_import_etrack_history')||'[]');
  const el = document.getElementById('etrackHistoryList');
  if(!hist.length) { el.innerHTML='<div style="color:var(--muted);font-size:13px;text-align:center;padding:20px 0">No imports yet</div>'; return; }
  el.innerHTML = hist.map(h=>`
    <div class="hist-row">
      <div class="hist-icon" style="background:rgba(212,152,10,.12);color:var(--gold)"><i class="fas fa-key"></i></div>
      <div style="flex:1"><div style="font-weight:700;font-size:13px">${h.filename||'eTrack CSV'}</div>
      <div style="font-size:12px;color:var(--muted)">${h.total} keys Â· <span style="color:var(--red)">${h.out} out</span></div></div>
      <div style="font-size:11px;color:var(--muted);text-align:right">${fmtDate(h.ts)}</div>
    </div>`).join('');
}

/* LAST IMPORT BADGE */
function updateLastImportBadge() {
  const cd=localStorage.getItem('ac_import_clickdealer_ts');
  const et=localStorage.getItem('ac_import_etrack_ts');
  const ts=[cd,et].filter(Boolean).map(Number).sort((a,b)=>b-a)[0];
  const badge=document.getElementById('lastImportBadge');
  const span=document.getElementById('lastImportTime');
  if(!ts||!badge||!span) return;
  const age=(Date.now()-ts)/3600000;
  const d=new Date(ts);
  const label=d.toLocaleDateString('en-GB',{day:'2-digit',month:'short'})+' '+d.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
  span.textContent=label;
  badge.className='last-import '+(age<24?'fresh':age>48?'stale':'');
}

/* INIT */
renderStockHistory();
renderEtrackHistory();
updateLastImportBadge();
</script>

<script>
document.addEventListener('DOMContentLoaded',function(){var b=document.getElementById('userBadge');if(b)b.textContent='AUTO CAPITAL';});
function doLogout(){window.location.href='./login.html';}
</script>
</body>
</html>
