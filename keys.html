<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Key Dashboard | CapeEye Auto Capital</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow:wght@300;400;500;600;700;800;900&family=Barlow+Condensed:wght@400;500;600;700;800;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
  --bg:#0b0e15; --bg2:#111622; --bg3:#1a2035; --bg4:#1e2640;
  --border:rgba(255,255,255,0.07); --border2:rgba(255,255,255,0.12);
  --accent:#e8b84b; --accent2:#3b7ff5; --green:#22c55e;
  --red:#ef4444; --orange:#f97316; --purple:#a855f7;
  --text:#f1f5f9; --muted:#64748b;
  --card-radius:14px;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Barlow',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}

/* â”€â”€ HEADER â”€â”€ */
.header{background:var(--bg2);border-bottom:1px solid var(--border);padding:0 28px;height:64px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:200}
.logo-area{display:flex;align-items:center;gap:14px}
.logo-area img{height:40px;width:auto}
.logo-divider{width:1px;height:32px;background:var(--border)}
.system-name{font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:700;letter-spacing:2px;color:var(--accent)}
.nav{display:flex;gap:4px}
.nav a{padding:8px 14px;border-radius:8px;font-size:13px;font-weight:500;color:var(--muted);text-decoration:none;transition:all .2s}
.nav a:hover,.nav a.active{background:var(--bg3);color:var(--text)}
.nav a.active{color:var(--accent)}

/* â”€â”€ MAIN â”€â”€ */
.main{max-width:1500px;margin:0 auto;padding:28px}
.page-header{display:flex;align-items:flex-end;justify-content:space-between;margin-bottom:28px;flex-wrap:wrap;gap:16px}
.page-header h1{font-family:'Barlow Condensed',sans-serif;font-size:38px;font-weight:900;letter-spacing:1px}
.page-header h1 span{color:var(--accent)}
.last-import{font-size:12px;color:var(--muted);margin-top:4px}

/* â”€â”€ KPI ROW â”€â”€ */
.kpi-row{display:grid;grid-template-columns:repeat(6,1fr);gap:14px;margin-bottom:24px}
.kpi{background:var(--bg2);border:1px solid var(--border);border-radius:var(--card-radius);padding:16px 18px;position:relative;overflow:hidden;transition:border-color .2s}
.kpi::after{content:'';position:absolute;top:0;left:0;width:3px;height:100%;background:var(--c,var(--accent))}
.kpi:hover{border-color:var(--border2)}
.kpi-label{font-size:10px;font-weight:700;letter-spacing:1.5px;color:var(--muted);text-transform:uppercase;margin-bottom:8px}
.kpi-val{font-family:'Barlow Condensed',sans-serif;font-size:38px;font-weight:900;line-height:1;color:var(--c,var(--text))}
.kpi-sub{font-size:11px;color:var(--muted);margin-top:4px}
.kpi-icon{position:absolute;top:12px;right:14px;font-size:22px;opacity:.1}

/* â”€â”€ SECTION TITLE â”€â”€ */
.sec-title{font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:800;letter-spacing:1px;text-transform:uppercase;color:var(--muted);margin-bottom:14px;display:flex;align-items:center;gap:10px}
.sec-title::after{content:'';flex:1;height:1px;background:var(--border)}

/* â”€â”€ TABS â”€â”€ */
.tabs{display:flex;gap:6px;margin-bottom:20px;flex-wrap:wrap}
.tab{padding:9px 18px;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;border:1px solid var(--border);background:var(--bg2);color:var(--muted);transition:all .2s;display:flex;align-items:center;gap:7px}
.tab.active{background:var(--bg4);border-color:var(--border2);color:var(--text)}
.tab .dot{width:8px;height:8px;border-radius:50%;background:var(--dc,var(--muted))}
.tab .cnt{font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:800;margin-left:2px}

/* â”€â”€ KEYS GRID â”€â”€ */
.keys-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;margin-bottom:28px}
.key-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--card-radius);padding:0;overflow:hidden;transition:all .25s;cursor:default}
.key-card:hover{border-color:var(--border2);transform:translateY(-2px);box-shadow:0 12px 32px rgba(0,0,0,.3)}
.key-card.out{border-left:3px solid var(--red)}
.key-card.in{border-left:3px solid var(--green)}
.key-card.out-long{border-left:3px solid var(--orange);animation:pulse-border 2s ease infinite}
@keyframes pulse-border{0%,100%{border-left-color:var(--orange)}50%{border-left-color:#f97316cc}}
.kc-top{padding:14px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border)}
.kc-reg{font-family:'Share Tech Mono',monospace;font-size:15px;font-weight:400;letter-spacing:1.5px;background:var(--reg-bg,rgba(232,184,75,.12));color:var(--reg-color,var(--accent));padding:4px 10px;border-radius:6px;border:1px solid var(--reg-border,rgba(232,184,75,.2))}
.key-card.out .kc-reg{--reg-bg:rgba(239,68,68,.1);--reg-color:#fca5a5;--reg-border:rgba(239,68,68,.2)}
.key-card.in .kc-reg{--reg-bg:rgba(34,197,94,.08);--reg-color:#86efac;--reg-border:rgba(34,197,94,.15)}
.status-pill{display:flex;align-items:center;gap:5px;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:800;letter-spacing:.5px;flex-shrink:0}
.status-pill.out{background:rgba(239,68,68,.12);color:var(--red)}
.status-pill.in{background:rgba(34,197,94,.12);color:var(--green)}
.status-pill.out-long{background:rgba(249,115,22,.12);color:var(--orange)}
.kc-body{padding:12px 16px}
.kc-pos{font-size:11px;color:var(--muted);margin-bottom:6px;display:flex;align-items:center;gap:5px}
.kc-desc{font-size:13px;font-weight:600;color:var(--text);margin-bottom:8px;min-height:18px}
.kc-time{font-size:11px;color:var(--muted);display:flex;align-items:center;gap:5px}
.kc-time.warn{color:var(--orange)}
.kc-time.crit{color:var(--red)}
.kc-user{font-size:12px;margin-top:6px;display:flex;align-items:center;gap:6px;color:var(--muted)}
.user-dot{width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:800;flex-shrink:0}

/* â”€â”€ STAFF SECTION â”€â”€ */
.staff-row{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin-bottom:28px}
.staff-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--card-radius);padding:16px;display:flex;align-items:center;gap:12px;transition:border-color .2s}
.staff-card:hover{border-color:var(--border2)}
.staff-avatar{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:800;flex-shrink:0}
.staff-name{font-size:13px;font-weight:700;line-height:1.3}
.staff-company{font-size:10px;color:var(--muted);margin-top:1px}
.key-count-badge{font-family:'Barlow Condensed',sans-serif;font-size:24px;font-weight:900;margin-left:auto;flex-shrink:0}

/* â”€â”€ AUDIT TABLE â”€â”€ */
.card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--card-radius);overflow:hidden;margin-bottom:20px}
.card-header{padding:14px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:var(--bg3)}
.card-title{font-family:'Barlow Condensed',sans-serif;font-size:15px;font-weight:800;letter-spacing:.5px;text-transform:uppercase}
.ac-table{width:100%;border-collapse:collapse;font-size:12px}
.ac-table th{padding:9px 14px;text-align:left;font-size:10px;letter-spacing:1px;text-transform:uppercase;color:var(--muted);font-weight:700;border-bottom:1px solid var(--border)}
.ac-table td{padding:9px 14px;border-bottom:1px solid rgba(255,255,255,.04)}
.ac-table tr:last-child td{border-bottom:none}
.ac-table tr:hover td{background:rgba(255,255,255,.02)}
.mono{font-family:'Share Tech Mono',monospace;font-size:12px;letter-spacing:1px}

/* â”€â”€ IMPORT â”€â”€ */
.import-zone{border:2px dashed var(--border);border-radius:var(--card-radius);padding:36px;text-align:center;cursor:pointer;transition:all .3s;background:var(--bg2);margin-bottom:28px}
.import-zone:hover,.import-zone.drag-over{border-color:var(--accent2);background:rgba(59,127,245,.04)}
.import-actions{display:flex;gap:10px;justify-content:center;margin-top:14px;flex-wrap:wrap}
.btn{padding:10px 20px;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;border:none;font-family:'Barlow',sans-serif;transition:all .2s;display:inline-flex;align-items:center;gap:8px}
.btn-primary{background:var(--accent2);color:#fff}
.btn-accent{background:var(--accent);color:#000}
.btn-ghost{background:var(--bg3);border:1px solid var(--border);color:var(--muted)}
.btn-ghost:hover{color:var(--text)}
.chip{display:inline-flex;align-items:center;padding:3px 9px;border-radius:10px;font-size:10px;font-weight:800;letter-spacing:.3px;white-space:nowrap}

/* â”€â”€ SEARCH â”€â”€ */
.toolbar{display:flex;gap:10px;align-items:center;margin-bottom:16px;flex-wrap:wrap}
.search-input{background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:9px 14px;color:var(--text);font-size:13px;font-family:'Barlow',sans-serif;outline:none;width:240px;transition:border-color .2s}
.search-input:focus{border-color:var(--accent2)}
.search-input::placeholder{color:var(--muted)}
.filter-btn{padding:8px 14px;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;border:1px solid var(--border);background:var(--bg2);color:var(--muted);transition:all .2s;font-family:'Barlow',sans-serif}
.filter-btn.active{background:var(--bg4);color:var(--text);border-color:var(--border2)}

/* â”€â”€ ALERT BANNER â”€â”€ */
.alert-banner{background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.2);border-radius:var(--card-radius);padding:14px 18px;margin-bottom:20px;display:flex;align-items:center;gap:12px}
.alert-banner i{color:var(--red);font-size:18px;flex-shrink:0}
.alert-banner-text{font-size:13px;color:var(--text)}
.alert-banner-text strong{color:var(--red)}

/* â”€â”€ TOAST â”€â”€ */
.toast{position:fixed;bottom:24px;right:24px;border-radius:10px;z-index:9999;font-size:14px;font-weight:700;padding:13px 22px;display:flex;align-items:center;gap:10px;animation:slideUp .2s ease}
@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}

/* â”€â”€ EMPTY â”€â”€ */
.empty{text-align:center;padding:48px;color:var(--muted)}
.empty i{font-size:32px;display:block;margin-bottom:10px;opacity:.3}

/* â”€â”€ RESPONSIVE â”€â”€ */
@media(max-width:1200px){.kpi-row{grid-template-columns:repeat(3,1fr)}}
@media(max-width:700px){.kpi-row{grid-template-columns:repeat(2,1fr)}.keys-grid{grid-template-columns:1fr}}
</style>
</head>
<body>

<header class="header">
  <div class="logo-area">
    <img src="./autocapital-logo.png" alt="Auto Capital" onerror="this.style.display='none'">
    <div class="logo-divider"></div>
    <span class="system-name">CAPEYE</span>
  </div>
  <nav class="nav">
    <a href="./index.html"><i class="fas fa-th-large"></i> Dashboard</a>
    <a href="./inventory.html"><i class="fas fa-car"></i> Inventory</a>
    <a href="./workflow.html"><i class="fas fa-tasks"></i> Workflow</a>
    <a href="./alerts.html"><i class="fas fa-bell"></i> Alerts</a>
    <a href="./marketing.html"><i class="fas fa-chart-line"></i> Marketing</a>
    <a href="./team.html"><i class="fas fa-users"></i> Team</a>
    <a href="./keys.html" class="active"><i class="fas fa-key"></i> Keys</a>
    <a href="./admin.html"><i class="fas fa-cog"></i> Admin</a>
  </nav>
</header>

<main class="main">

  <!-- PAGE HEADER -->
  <div class="page-header">
    <div>
      <h1><i class="fas fa-key" style="color:var(--accent);margin-right:10px;font-size:32px"></i>Key <span>Dashboard</span></h1>
      <div class="last-import" id="lastImport">No data imported yet â€” upload your e-Track CSV files below</div>
    </div>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn btn-ghost" onclick="clearData()"><i class="fas fa-trash-alt"></i> Clear Data</button>
      <button class="btn btn-primary" onclick="document.getElementById('csvInput').click()"><i class="fas fa-cloud-upload-alt"></i> Import CSV</button>
      <input type="file" id="csvInput" accept=".csv" multiple style="display:none" onchange="handleFiles(this)">
    </div>
  </div>

  <!-- KPI ROW -->
  <div class="kpi-row">
    <div class="kpi" style="--c:var(--red)"><i class="fas fa-key kpi-icon"></i><div class="kpi-label">Keys Out</div><div class="kpi-val" id="kOut">â€”</div><div class="kpi-sub">Currently removed</div></div>
    <div class="kpi" style="--c:var(--green)"><i class="fas fa-box kpi-icon"></i><div class="kpi-label">Keys In Box</div><div class="kpi-val" id="kIn">â€”</div><div class="kpi-sub">Secured in key room</div></div>
    <div class="kpi" style="--c:var(--orange)"><i class="fas fa-clock kpi-icon"></i><div class="kpi-label">Out 24h+</div><div class="kpi-val" id="kLong">â€”</div><div class="kpi-sub">Attention needed</div></div>
    <div class="kpi" style="--c:var(--accent)"><i class="fas fa-users kpi-icon"></i><div class="kpi-label">Staff w/ Keys</div><div class="kpi-val" id="kStaff">â€”</div><div class="kpi-sub">People holding keys</div></div>
    <div class="kpi" style="--c:var(--accent2)"><i class="fas fa-database kpi-icon"></i><div class="kpi-label">Total Tracked</div><div class="kpi-val" id="kTotal">â€”</div><div class="kpi-sub">All registered keys</div></div>
    <div class="kpi" style="--c:var(--purple)"><i class="fas fa-history kpi-icon"></i><div class="kpi-label">Audit Events</div><div class="kpi-val" id="kAudit">â€”</div><div class="kpi-sub">Log entries</div></div>
  </div>

  <!-- ALERT BANNER (if many keys out too long) -->
  <div class="alert-banner" id="alertBanner" style="display:none">
    <i class="fas fa-exclamation-triangle"></i>
    <div class="alert-banner-text" id="alertBannerText"></div>
  </div>

  <!-- IMPORT ZONE -->
  <div class="import-zone" id="dropZone"
    ondragover="event.preventDefault();this.classList.add('drag-over')"
    ondragleave="this.classList.remove('drag-over')"
    ondrop="handleDrop(event)">
    <div style="font-size:40px;color:var(--muted);margin-bottom:12px"><i class="fas fa-cloud-upload-alt"></i></div>
    <div style="font-size:17px;font-weight:700;margin-bottom:6px">Import e-Track CSV Exports</div>
    <div style="font-size:13px;color:var(--muted);margin-bottom:4px">Drop one or multiple CSV files â€” the system recognises each file type automatically</div>
    <div style="font-size:12px;color:var(--muted);margin-bottom:14px">Supports: Key Status, Key Positions, Who Has Keys, Audit Log</div>
    <div class="import-actions">
      <button class="btn btn-primary" onclick="event.stopPropagation();document.getElementById('csvInput').click()"><i class="fas fa-folder-open"></i> Choose Files</button>
      <button class="btn btn-ghost" onclick="event.stopPropagation();loadSampleData()"><i class="fas fa-database"></i> Load Sample Data</button>
    </div>
  </div>

  <!-- MAIN CONTENT (hidden until data loaded) -->
  <div id="mainContent" style="display:none">

    <!-- TABS -->
    <div class="tabs" id="mainTabs">
      <div class="tab active" onclick="setView('out')" id="tab-out"><div class="dot" style="--dc:var(--red)"></div>Keys Out <span class="cnt" id="tc-out" style="color:var(--red)">0</span></div>
      <div class="tab" onclick="setView('in')" id="tab-in"><div class="dot" style="--dc:var(--green)"></div>Keys In <span class="cnt" id="tc-in" style="color:var(--green)">0</span></div>
      <div class="tab" onclick="setView('all')" id="tab-all"><div class="dot"></div>All Keys <span class="cnt" id="tc-all">0</span></div>
      <div class="tab" onclick="setView('staff')" id="tab-staff"><div class="dot" style="--dc:var(--accent)"></div>By Staff <span class="cnt" id="tc-staff" style="color:var(--accent)">0</span></div>
      <div class="tab" onclick="setView('audit')" id="tab-audit"><div class="dot" style="--dc:var(--accent2)"></div>Audit Log <span class="cnt" id="tc-audit" style="color:var(--accent2)">0</span></div>
    </div>

    <!-- TOOLBAR -->
    <div class="toolbar" id="toolbar">
      <input class="search-input" id="searchInput" placeholder="ðŸ” Search registration, position, description..." oninput="renderCurrentView()">
      <div id="filterBtns" style="display:flex;gap:6px;flex-wrap:wrap"></div>
    </div>

    <!-- KEYS GRID -->
    <div class="keys-grid" id="keysGrid"></div>

    <!-- STAFF SECTION -->
    <div id="staffSection" style="display:none">
      <div class="sec-title"><i class="fas fa-users"></i> Staff â€” Keys Currently Held</div>
      <div class="staff-row" id="staffGrid"></div>
    </div>

    <!-- AUDIT LOG -->
    <div id="auditSection" style="display:none">
      <div class="card">
        <div class="card-header">
          <span class="card-title"><i class="fas fa-history" style="color:var(--accent2);margin-right:8px"></i>Audit Log</span>
          <span style="font-size:12px;color:var(--muted)" id="auditCount"></span>
        </div>
        <div style="overflow-x:auto;max-height:600px;overflow-y:auto">
          <table class="ac-table">
            <thead><tr><th>Date / Time</th><th>Event</th><th>User</th><th>Details</th></tr></thead>
            <tbody id="auditBody"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</main>

<script>
// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let state = {
  keys: [],       // from key status CSV (Web__1_)
  positions: [],  // from positions CSV (Web.csv)
  staff: [],      // from who-has-keys CSV (Web__3_)
  users: [],      // from users CSV (Web__2_)
  audit: [],      // from audit log CSV (Web__4_)
  importedFiles: [],
  lastImport: null
};
let currentView = 'out';
let currentFilter = 'all';

// â”€â”€ PALETTE for staff avatars â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const COLORS = ['#3b7ff5','#22c55e','#f97316','#a855f7','#e8b84b','#06b6d4','#ec4899','#14b8a6','#f43f5e','#8b5cf6','#10b981'];
function staffColor(name) {
  let h = 0; for (const c of name) h = (h * 31 + c.charCodeAt(0)) & 0xffffffff;
  return COLORS[Math.abs(h) % COLORS.length];
}
function initials(name) { return name.split(' ').map(n=>n[0]||'').join('').slice(0,2).toUpperCase(); }

// â”€â”€ CSV PARSING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseCSV(text) {
  const lines = text.trim().split(/\r?\n/);
  if (lines.length < 2) return [];
  function parseLine(line) {
    const cols = []; let cur = '', inQ = false;
    for (const c of line) {
      if (c === '"') inQ = !inQ;
      else if (c === ',' && !inQ) { cols.push(cur.trim()); cur = ''; }
      else cur += c;
    }
    cols.push(cur.trim());
    return cols.map(v => v.replace(/^"|"$/g, '').trim());
  }
  const headers = parseLine(lines[0]);
  return lines.slice(1).filter(l=>l.trim()).map(line => {
    const vals = parseLine(line);
    const obj = {};
    headers.forEach((h,i) => { obj[h] = vals[i] || ''; });
    return obj;
  });
}

function detectFileType(headers, rows) {
  const h = headers.join(',').toLowerCase();
  if (h.includes('key position') && h.includes('status')) return 'status';
  if (h.includes('position') && !h.includes('status') && !h.includes('user')) return 'positions';
  if (h.includes('no. of keys') || h.includes('no of keys')) return 'staffkeys';
  if (h.includes('full name') && h.includes('username') && h.includes('email')) return 'users';
  if (h.includes('date/time') && h.includes('event')) return 'audit';
  return 'unknown';
}

function parseDateTime(raw) {
  // e-Track format: '177194863824/02/2026 15:57' â€” strip leading digits
  const match = raw.match(/(\d{2}\/\d{2}\/\d{4}\s+\d{2}:\d{2})/);
  return match ? match[1] : raw;
}

function dateToMs(str) {
  if (!str) return 0;
  const m = str.match(/(\d{2})\/(\d{2})\/(\d{4})(?:\s+(\d{2}):(\d{2}))?/);
  if (!m) return 0;
  return new Date(+m[3], +m[2]-1, +m[1], +(m[4]||0), +(m[5]||0)).getTime();
}

function hoursAgo(dateStr) {
  const ms = dateToMs(dateStr);
  if (!ms) return 0;
  return Math.floor((Date.now() - ms) / 3600000);
}

function formatDuration(hours) {
  if (hours < 1) return 'Just now';
  if (hours < 24) return `${hours}h`;
  const d = Math.floor(hours / 24), h = hours % 24;
  return `${d}d${h ? ' '+h+'h' : ''}`;
}

// â”€â”€ FILE HANDLING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.handleDrop = function(e) {
  e.preventDefault();
  document.getElementById('dropZone').classList.remove('drag-over');
  processFiles(Array.from(e.dataTransfer.files));
};

window.handleFiles = function(input) {
  if (input.files) processFiles(Array.from(input.files));
};

function processFiles(files) {
  let processed = 0;
  files.forEach(file => {
    if (!file.name.endsWith('.csv')) return;
    const reader = new FileReader();
    reader.onload = e => {
      processCSV(e.target.result, file.name);
      processed++;
      if (processed === files.length) {
        state.lastImport = new Date().toLocaleString('en-GB');
        saveState();
        renderAll();
        showToast(`âœ“ ${processed} file${processed>1?'s':''} imported`);
      }
    };
    reader.readAsText(file);
  });
}

function processCSV(text, filename) {
  const rows = parseCSV(text);
  if (!rows.length) return;
  const headers = Object.keys(rows[0]);
  const type = detectFileType(headers, rows);

  if (type === 'status') {
    state.keys = rows.map(r => ({
      position: r['Key Position'] || '0',
      reg: r['Key Name'] || '',
      description: r['Description'] || '',
      system: r['System'] || '',
      status: (r['Status'] || '').trim(),
      dateAdded: r['Date Added'] || ''
    })).filter(k => k.reg && !['test','test fob'].includes(k.reg.toLowerCase()));
    state.importedFiles = [...new Set([...state.importedFiles, filename])];
  }
  else if (type === 'positions') {
    state.positions = rows.map(r => ({
      position: r['Position'] || '0',
      reg: r['Key Name'] || '',
      description: r['Description'] || '',
      system: r['System'] || '',
      dateAdded: r['Date Added'] || ''
    })).filter(k => k.reg);
    state.importedFiles = [...new Set([...state.importedFiles, filename])];
  }
  else if (type === 'staffkeys') {
    state.staff = rows.map(r => ({
      name: r['Name'] || '',
      username: r['Username'] || '',
      company: r['Company'] || '',
      keyCount: parseInt(r['No. of Keys'] || r['No of Keys'] || '0') || 0
    })).filter(s => s.name);
    state.importedFiles = [...new Set([...state.importedFiles, filename])];
  }
  else if (type === 'users') {
    state.users = rows.map(r => ({
      name: r['Full Name'] || '',
      username: r['Username'] || '',
      email: r['Email'] || '',
      company: r['Company'] || '',
      dept: r['Department'] || ''
    })).filter(u => u.name);
    state.importedFiles = [...new Set([...state.importedFiles, filename])];
  }
  else if (type === 'audit') {
    const newAudit = rows.map(r => ({
      datetime: parseDateTime(r['Date/Time'] || ''),
      event: r['Event'] || '',
      user: r['User'] || '',
      comments: r['Comments'] || ''
    })).filter(a => a.datetime);
    // Merge, deduplicate by datetime+event+user
    const existing = new Set(state.audit.map(a => a.datetime+a.event+a.user));
    newAudit.forEach(a => { if (!existing.has(a.datetime+a.event+a.user)) state.audit.push(a); });
    state.audit.sort((a,b) => dateToMs(b.datetime) - dateToMs(a.datetime));
    state.importedFiles = [...new Set([...state.importedFiles, filename])];
  }
}

// â”€â”€ SAMPLE DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.loadSampleData = function() {
  // Load from uploaded files via fetch
  const files = [
    {url:'e-Track__Web__1_.csv', name:'e-Track__Web__1_.csv'},
    {url:'e-Track__Web__3_.csv', name:'e-Track__Web__3_.csv'},
    {url:'e-Track__Web__4_.csv', name:'e-Track__Web__4_.csv'},
    {url:'e-Track__Web.csv',     name:'e-Track__Web.csv'}
  ];
  showToast('Loading sample data...','#3b7ff5');
  // We'll use the embedded sample data below
  loadEmbeddedSample();
};

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAll() {
  updateKPIs();
  updateTabs();
  updateAlertBanner();
  renderCurrentView();
  document.getElementById('mainContent').style.display = 'block';
  document.getElementById('dropZone').style.display = 'none';
  document.getElementById('lastImport').textContent =
    state.lastImport
      ? `Last import: ${state.lastImport} Â· Files: ${state.importedFiles.join(', ')}`
      : 'No data imported';
}

function updateKPIs() {
  const keys = state.keys;
  const out = keys.filter(k => k.status === 'Out');
  const inBox = keys.filter(k => k.status === 'In');
  const longOut = out.filter(k => hoursAgo(k.dateAdded) >= 24);
  document.getElementById('kOut').textContent    = out.length;
  document.getElementById('kIn').textContent     = inBox.length;
  document.getElementById('kLong').textContent   = longOut.length;
  document.getElementById('kStaff').textContent  = state.staff.length || 'â€”';
  document.getElementById('kTotal').textContent  = keys.length;
  document.getElementById('kAudit').textContent  = state.audit.length;
}

function updateTabs() {
  const keys = state.keys;
  document.getElementById('tc-out').textContent   = keys.filter(k=>k.status==='Out').length;
  document.getElementById('tc-in').textContent    = keys.filter(k=>k.status==='In').length;
  document.getElementById('tc-all').textContent   = keys.length;
  document.getElementById('tc-staff').textContent = state.staff.length;
  document.getElementById('tc-audit').textContent = state.audit.length;
}

function updateAlertBanner() {
  const longOut = state.keys.filter(k => k.status==='Out' && hoursAgo(k.dateAdded) >= 48);
  const banner = document.getElementById('alertBanner');
  if (longOut.length > 0) {
    document.getElementById('alertBannerText').innerHTML =
      `<strong>${longOut.length} key${longOut.length>1?'s':''} out for 48+ hours</strong> â€” ${longOut.map(k=>`<span class="chip" style="background:rgba(239,68,68,.15);color:#fca5a5;margin:0 3px">${k.reg}</span>`).join('')}`;
    banner.style.display = 'flex';
  } else {
    banner.style.display = 'none';
  }
}

window.setView = function(view) {
  currentView = view;
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('tab-'+view).classList.add('active');
  renderCurrentView();
};

window.renderCurrentView = function() {
  const search = (document.getElementById('searchInput').value || '').toLowerCase();
  const keysGrid = document.getElementById('keysGrid');
  const staffSection = document.getElementById('staffSection');
  const auditSection = document.getElementById('auditSection');
  const toolbar = document.getElementById('toolbar');

  keysGrid.style.display = 'none';
  staffSection.style.display = 'none';
  auditSection.style.display = 'none';

  if (currentView === 'staff') {
    toolbar.style.display = 'none';
    staffSection.style.display = 'block';
    renderStaff();
    return;
  }
  if (currentView === 'audit') {
    toolbar.style.display = 'flex';
    auditSection.style.display = 'block';
    renderAudit(search);
    return;
  }

  toolbar.style.display = 'flex';
  keysGrid.style.display = 'grid';

  let keys = state.keys;
  if (currentView === 'out') keys = keys.filter(k => k.status === 'Out');
  if (currentView === 'in')  keys = keys.filter(k => k.status === 'In');

  // Filter buttons for Out view
  if (currentView === 'out') {
    document.getElementById('filterBtns').innerHTML = `
      <button class="filter-btn ${currentFilter==='all'?'active':''}" onclick="setFilter('all')">All Out</button>
      <button class="filter-btn ${currentFilter==='critical'?'active':''}" onclick="setFilter('critical')" style="color:var(--red)">48h+ Critical</button>
      <button class="filter-btn ${currentFilter==='warning'?'active':''}" onclick="setFilter('warning')" style="color:var(--orange)">24â€“48h Warning</button>
      <button class="filter-btn ${currentFilter==='normal'?'active':''}" onclick="setFilter('normal')">Under 24h</button>
      <button class="filter-btn ${currentFilter==='inbox'?'active':''}" onclick="setFilter('inbox')">In Key Boxes</button>`;
    if (currentFilter === 'critical') keys = keys.filter(k => hoursAgo(k.dateAdded) >= 48);
    else if (currentFilter === 'warning') keys = keys.filter(k => { const h=hoursAgo(k.dateAdded); return h>=24&&h<48; });
    else if (currentFilter === 'normal') keys = keys.filter(k => hoursAgo(k.dateAdded) < 24);
    else if (currentFilter === 'inbox') keys = keys.filter(k => k.position !== '0');
  } else {
    document.getElementById('filterBtns').innerHTML = '';
  }

  if (search) {
    keys = keys.filter(k =>
      k.reg.toLowerCase().includes(search) ||
      k.description.toLowerCase().includes(search) ||
      k.position.includes(search)
    );
  }

  // Sort: by hours out descending for Out view
  if (currentView === 'out') {
    keys.sort((a,b) => dateToMs(a.dateAdded) - dateToMs(b.dateAdded));
  }

  renderKeyCards(keys);
};

window.setFilter = function(f) {
  currentFilter = f;
  renderCurrentView();
};

function renderKeyCards(keys) {
  if (!keys.length) {
    document.getElementById('keysGrid').innerHTML = `<div class="empty" style="grid-column:1/-1"><i class="fas fa-key"></i>No keys match this filter</div>`;
    return;
  }
  document.getElementById('keysGrid').innerHTML = keys.map(k => {
    const hours = hoursAgo(k.dateAdded);
    const isOut = k.status === 'Out';
    const isCritical = isOut && hours >= 48;
    const isWarning  = isOut && hours >= 24 && hours < 48;
    let cardClass = isOut ? (isCritical ? 'out-long' : 'out') : 'in';
    let statusLabel = isOut ? (isCritical ? 'âš  CRITICAL' : isWarning ? 'âš  WARNING' : 'OUT') : 'IN';
    let pillClass = isOut ? (isCritical || isWarning ? 'out-long' : 'out') : 'in';
    const hasBox = k.position !== '0';
    const timeClass = isCritical ? 'crit' : isWarning ? 'warn' : '';

    return `<div class="key-card ${cardClass}">
      <div class="kc-top">
        <span class="kc-reg">${k.reg}</span>
        <span class="status-pill ${pillClass}">${isOut ? `<i class="fas fa-circle" style="font-size:6px"></i>` : `<i class="fas fa-check" style="font-size:9px"></i>`} ${statusLabel}</span>
      </div>
      <div class="kc-body">
        <div class="kc-pos">
          <i class="fas fa-box" style="font-size:9px"></i>
          ${hasBox ? `Box Position <strong style="color:var(--text)">#${k.position}</strong>` : `<span style="color:var(--muted)">No box position</span>`}
        </div>
        <div class="kc-desc">${k.description || 'â€”'}</div>
        <div class="kc-time ${timeClass}">
          <i class="fas fa-clock" style="font-size:9px"></i>
          ${isOut
            ? (hours > 0 ? `Out for <strong>${formatDuration(hours)}</strong>` : 'Just removed')
            : `Added ${k.dateAdded}`}
        </div>
      </div>
    </div>`;
  }).join('');
}

function renderStaff() {
  if (!state.staff.length) {
    document.getElementById('staffGrid').innerHTML = `<div class="empty" style="grid-column:1/-1"><i class="fas fa-users"></i>No staff data â€” import the "Who Has Keys" CSV</div>`;
    return;
  }
  const sorted = [...state.staff].sort((a,b) => b.keyCount - a.keyCount);
  document.getElementById('staffGrid').innerHTML = sorted.map(s => {
    const col = staffColor(s.name);
    const countColor = s.keyCount > 10 ? 'var(--orange)' : s.keyCount > 5 ? 'var(--accent)' : 'var(--green)';
    return `<div class="staff-card">
      <div class="staff-avatar" style="background:${col}22;color:${col}">${initials(s.name)}</div>
      <div style="min-width:0;flex:1">
        <div class="staff-name">${s.name}</div>
        <div class="staff-company">${s.company || s.username || 'â€”'}</div>
      </div>
      <div class="key-count-badge" style="color:${countColor}">${s.keyCount}</div>
    </div>`;
  }).join('');
}

function renderAudit(search) {
  let events = state.audit;
  if (search) {
    events = events.filter(a =>
      a.user.toLowerCase().includes(search) ||
      a.event.toLowerCase().includes(search) ||
      a.comments.toLowerCase().includes(search)
    );
  }
  document.getElementById('auditCount').textContent = events.length + ' events';

  const eventColors = {
    'Fob Added':       {bg:'rgba(34,197,94,.1)', color:'var(--green)'},
    'Fob Deleted':     {bg:'rgba(239,68,68,.1)', color:'var(--red)'},
    'User Login (Web)':{bg:'rgba(59,127,245,.1)',color:'var(--accent2)'},
    'User Logout':     {bg:'rgba(100,116,139,.1)',color:'var(--muted)'},
    'User Group Edited':{bg:'rgba(168,85,247,.1)',color:'var(--purple)'}
  };

  // Extract reg from comments for fob events
  function extractReg(comments) {
    const m = comments.match(/Key[:\s]+([A-Z0-9]{6,10})/i) || comments.match(/- ([A-Z0-9]{6,10})$/i);
    return m ? m[1].toUpperCase() : null;
  }

  document.getElementById('auditBody').innerHTML = events.map(a => {
    const ec = eventColors[a.event] || {bg:'rgba(100,116,139,.1)',color:'var(--muted)'};
    const col = staffColor(a.user);
    const reg = extractReg(a.comments);
    return `<tr>
      <td class="mono" style="color:var(--muted);white-space:nowrap">${a.datetime}</td>
      <td><span class="chip" style="background:${ec.bg};color:${ec.color}">${a.event}</span></td>
      <td>
        <div style="display:flex;align-items:center;gap:8px">
          <div class="user-dot" style="background:${col}22;color:${col};width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:800;flex-shrink:0">${initials(a.user)}</div>
          <span style="font-size:12px;font-weight:600">${a.user.split(' (')[0]}</span>
        </div>
      </td>
      <td style="color:var(--muted);font-size:12px">
        ${reg ? `<span class="kc-reg" style="font-size:11px;padding:2px 7px;margin-right:6px">${reg}</span>` : ''}
        ${a.comments.split('|')[0].trim()}
      </td>
    </tr>`;
  }).join('') || `<tr><td colspan="4" style="text-align:center;padding:32px;color:var(--muted)">No events found</td></tr>`;
}

// â”€â”€ PERSISTENCE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveState() {
  try { localStorage.setItem('ce_keys', JSON.stringify(state)); } catch(e) {}
}
function loadState() {
  try {
    const s = localStorage.getItem('ce_keys');
    if (s) { state = { ...state, ...JSON.parse(s) }; }
  } catch(e) {}
}

window.clearData = function() {
  if (!confirm('Clear all imported key data?')) return;
  state = { keys:[], positions:[], staff:[], users:[], audit:[], importedFiles:[], lastImport:null };
  saveState();
  location.reload();
};

// â”€â”€ EMBEDDED SAMPLE (from uploaded files) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadEmbeddedSample() {
  // Use the real data we analysed â€” key status snapshot
  const sampleStatus = `"Key Position","Key Name","Description","System","Status","Date Added"
"306","KS21JZN","","Key Room","Out","27/01/2026 09:37"
"304","ND21WVU","","Key Room","In","07/01/2026 10:52"
"303","NK71YFP","","Key Room","In","07/01/2026 08:03"
"301","YC72VUO","","Key Room","In","29/10/2025 12:10"
"290","RO75HGD","","Key Room","In","15/12/2025 12:06"
"289","RO75HDU","","Key Room","In","06/01/2026 11:59"
"281","CN21LRL","","Key Room","Out","01/07/2025 13:18"
"280","RO75HDN","","Key Room","In","06/01/2026 11:58"
"276","RO75HDJ","","Key Room","In","10/12/2025 09:28"
"275","AE74VYX","","Key Room","In","12/12/2025 14:15"
"274","RO75HDV","","Key Room","In","10/12/2025 11:00"
"253","RF66UBC","Audi","Key Room","In","23/10/2025 14:05"
"232","CA22ZDG","","Key Room","Out","13/01/2026 17:58"
"110","WR23RGO","","Key Room","Out","27/11/2025 10:51"
"94","MD71ZWV","Peugeot","Key Room","Out","06/02/2026 14:10"
"93","DL22DLU","","Key Room","Out","23/02/2026 10:23"
"90","MA71VRF","","Key Room","Out","03/02/2026 11:04"
"87","EN72GOP","","Key Room","Out","23/02/2026 10:00"
"76","EJ72XAV","","Key Room","Out","23/02/2026 08:38"
"74","DL22DKO","","Key Room","Out","23/02/2026 10:24"
"69","SL22NZN","Maxus","Key Room","Out","14/01/2026 16:51"
"60","BL71HZH","","Key Room","Out","16/02/2026 09:18"
"58","CV22ODG","Toyota","Key Room","Out","03/02/2026 11:04"
"51","FL19NMA","Ford","Key Room","Out","24/11/2025 15:33"
"47","WV73YPJ","","Key Room","Out","29/01/2026 15:17"
"46","KS71NZA","Vito","Key Room","Out","18/02/2026 16:03"
"43","CV22LVJ","","Key Room","Out","18/02/2026 11:40"
"41","MM21YGA","Ford","Key Room","Out","17/02/2026 17:23"
"33","MA71VRM","","Key Room","Out","09/02/2026 08:54"
"32","WR23PZS","Ford","Key Room","Out","24/02/2026 06:47"
"29","MA71WRR","","Key Room","Out","09/02/2026 07:53"
"27","LF22ZRE","","Key Room","Out","12/02/2026 10:54"
"26","BX69LLV","Ford","Key Room","Out","20/02/2026 13:57"
"24","ND21VOV","","Key Room","Out","08/01/2026 13:45"`;

  const sampleStaff = `"Name","Username","Company","No. of Keys"
"Ali Soleimani","Jonesali","Auto Capital","4"
"David Lupu","","Autocapital","3"
"Georgino Barnes","","Auto Capital","12"
"Germaine Dua","","Auto Capital","2"
"ISAAC ADOMAH","","BRIGHT VALET","19"
"Keith Hardy","keith@autocapital.co.uk","Auto Capital","3"
"Marcin Kiljan","","Auto Capital","1"
"Moamel Al Ameri","Moamel","Auto Capital","3"
"Morteza Rahamian","","","7"
"Musafa Naaama","","Auto Capital","11"
"Stanislaw Marzec","Stash","Auto Capital","7"`;

  const sampleAudit = `"Date/Time","Event","User","Comments"
"177194863824/02/2026 15:57","User Login (Web)","Keith Hardy (keith@autocapital.co.uk)","User: Keith Hardy (keith@autocapital.co.uk) | Logged In (Web)"
"177194787324/02/2026 15:44","User Logout","Musafa Naaama","User Logout"
"177194784824/02/2026 15:44","Fob Deleted","AbuAmar","Key Deleted - LL71ZPM"
"177194784124/02/2026 15:44","Fob Deleted","AbuAmar","Key Deleted - SL22NZU"
"177194783424/02/2026 15:43","User Login (Web)","Faiz Roumi (AbuAmar)","User: Faiz Roumi (AbuAmar) | Logged In (Web)"
"177194761324/02/2026 15:40","Fob Added","Stash","Key: WR23PKZ | Added by: Stash"
"177194746424/02/2026 15:37","User Logout","Georgino Barnes","User Logout"
"177194632824/02/2026 15:18","Fob Added","Stash","Key: MD71ZWW | Added by: Stash"
"177194629624/02/2026 15:18","User Login (Web)","Stanislaw Marzec (Stash)","User: Stanislaw Marzec (Stash) | Logged In (Web)"
"177194475124/02/2026 14:52","Fob Deleted","AbuAmar","Key Deleted - DX72ZXC"
"177194474624/02/2026 14:52","User Login (Web)","Faiz Roumi (AbuAmar)","User: Faiz Roumi (AbuAmar) | Logged In (Web)"
"177194429624/02/2026 14:44","User Logout","ISAAC ADOMAH","User Logout"
"177194382124/02/2026 14:37","User Logout","David Lupu","User Logout"
"177194276724/02/2026 14:19","User Logout","Marcin Kiljan","User Logout"
"177194181124/02/2026 14:03","User Logout","Hayder ahmed","User Logout"`;

  processCSV(sampleStatus, 'e-Track__Web__1_.csv');
  processCSV(sampleStaff,  'e-Track__Web__3_.csv');
  processCSV(sampleAudit,  'e-Track__Web__4_.csv');
  state.lastImport = new Date().toLocaleString('en-GB');
  saveState();
  renderAll();
  showToast('âœ“ Sample data loaded from your e-Track exports');
}

// â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg, bg='#22c55e') {
  document.querySelectorAll('.toast').forEach(t=>t.remove());
  const t = document.createElement('div');
  t.className = 'toast';
  t.style.cssText = `background:${bg};color:${bg==='#22c55e'?'#000':'#fff'}`;
  t.innerHTML = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 3500);
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadState();
if (state.keys.length || state.audit.length) {
  state.lastImport = state.lastImport || 'Previously imported';
  renderAll();
}
</script>
</body>
</html>
