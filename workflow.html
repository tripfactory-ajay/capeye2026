<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Workflow | Auto Capital</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="./firebase-config.js"></script>
<script src="./ac-data.js"></script>
<style>
:root{--bg:#f4f6f9;--bg2:#fff;--bg3:#f0f2f6;--border:#e2e6ed;--border2:#c8d0dc;--red:#C8102E;--red2:#a00d24;--red-light:rgba(200,16,46,.07);--blue:#003DA5;--blue2:#002d7a;--blue-light:rgba(0,61,165,.07);--gold:#d4980a;--green:#1a7f37;--green-light:rgba(26,127,55,.07);--orange:#d4600a;--text:#0f1923;--text2:#3d4d5c;--muted:#7a8fa6;--shadow:0 1px 3px rgba(0,0,0,.07),0 4px 16px rgba(0,0,0,.04);--shadow-md:0 4px 12px rgba(0,0,0,.1),0 12px 40px rgba(0,0,0,.07);--card-radius:12px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:"DM Sans",sans-serif;background:var(--bg);color:var(--text);min-height:100vh;-webkit-font-smoothing:antialiased}
.header{background:var(--blue);padding:0 24px;height:68px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:200;box-shadow:0 2px 16px rgba(0,61,165,.25)}
.logo-area{display:flex;align-items:center;gap:14px;flex-shrink:0}
.logo-img{height:40px;width:auto;object-fit:contain}
.logo-divider{width:1px;height:34px;background:rgba(255,255,255,.2);flex-shrink:0}
.system-name{font-size:11px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:rgba(255,255,255,.8);white-space:nowrap}
.nav{display:flex;gap:1px;overflow-x:auto}
.nav a{padding:8px 11px;border-radius:7px;font-size:12px;font-weight:500;color:rgba(255,255,255,.72);text-decoration:none;transition:all .18s;display:flex;align-items:center;gap:5px;white-space:nowrap}
.nav a i{font-size:11px}
.nav a:hover{background:rgba(255,255,255,.13);color:#fff}
.nav a.active{background:var(--red);color:#fff;font-weight:700}
.header-right{display:flex;align-items:center;gap:10px;flex-shrink:0}
.user-badge{background:rgba(255,255,255,.15);color:#fff;font-weight:600;font-size:11px;padding:5px 12px;border-radius:20px;letter-spacing:1px;text-transform:uppercase;border:1px solid rgba(255,255,255,.2);white-space:nowrap}
.btn-logout{background:transparent;border:1px solid rgba(255,255,255,.25);color:rgba(255,255,255,.8);padding:6px 10px;border-radius:7px;cursor:pointer;font-size:12px;font-family:"DM Sans",sans-serif}
.main{max-width:1600px;margin:0 auto;padding:28px}
.page-hdr{margin-bottom:24px;display:flex;align-items:flex-end;justify-content:space-between;flex-wrap:wrap;gap:14px}
.page-hdr h1{font-size:26px;font-weight:800;letter-spacing:-.3px}
.page-hdr h1 .r{color:var(--red)}
.page-hdr p{color:var(--muted);font-size:13px;margin-top:3px}
.kpi-strip{display:grid;grid-template-columns:repeat(7,1fr);gap:12px;margin-bottom:24px}
.kpi{background:var(--bg2);border:1px solid var(--border);border-top:3px solid var(--kc,var(--blue));border-radius:var(--card-radius);padding:16px 18px;box-shadow:var(--shadow);position:relative;overflow:hidden}
.kpi-label{font-size:10px;font-weight:700;letter-spacing:1.5px;color:var(--muted);text-transform:uppercase;margin-bottom:6px}
.kpi-val{font-size:28px;font-weight:800;line-height:1;color:var(--kc,var(--text))}
.kpi-sub{font-size:11px;color:var(--muted);margin-top:3px}
.kpi i.bg-i{position:absolute;right:12px;top:50%;transform:translateY(-50%);font-size:26px;opacity:.06}
.loc-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px}
.loc-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--card-radius);padding:16px 20px;box-shadow:var(--shadow);border-left:4px solid var(--lc,var(--blue))}
.loc-name{font-size:11px;font-weight:700;color:var(--text2);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px}
.loc-count{font-size:32px;font-weight:800;color:var(--lc,var(--blue))}
.loc-sub{font-size:11px;color:var(--muted);margin-top:3px}
.loc-chips{margin-top:8px;display:flex;flex-wrap:wrap;gap:4px}
.loc-chip{font-family:"DM Mono",monospace;font-size:10px;background:var(--bg3);color:var(--text2);padding:2px 6px;border-radius:4px;letter-spacing:.5px}
.flow-wrap{overflow-x:auto;margin-bottom:4px}
.flow-stages{display:flex;gap:0;min-width:max-content;border:1px solid var(--border);border-radius:var(--card-radius);overflow:hidden;box-shadow:var(--shadow)}
.flow-stage{min-width:120px;border-right:1px solid var(--border);background:var(--bg2)}
.flow-stage:last-child{border-right:none}
.fs-hdr{padding:10px 12px;border-bottom:1px solid var(--border);background:var(--bg3)}
.fs-name{font-size:10px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.5px}
.fs-count{font-size:22px;font-weight:800;color:var(--blue);margin-top:2px}
.fs-body{padding:8px;min-height:50px}
.fs-chip{font-family:"DM Mono",monospace;font-size:10px;background:var(--blue-light);color:var(--blue);padding:3px 6px;border-radius:4px;margin:2px;display:inline-block;letter-spacing:.5px;cursor:default}
.fs-chip.b{background:var(--red-light);color:var(--red)}
.fs-chip.w{background:rgba(212,96,10,.1);color:var(--orange)}
.dept-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px}
.dept-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--card-radius);overflow:hidden;box-shadow:var(--shadow)}
.dept-hdr{padding:12px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border)}
.dept-name{font-size:13px;font-weight:700;display:flex;align-items:center;gap:8px}
.dept-num{font-size:22px;font-weight:800}
.dept-meta{font-size:11px;color:var(--muted);padding:8px 16px;border-bottom:1px solid var(--border);display:flex;gap:14px}
.dept-vehicles{max-height:190px;overflow-y:auto}
.dv{padding:7px 16px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--border)}
.dv:last-child{border-bottom:none}
.dv:hover{background:var(--blue-light)}
.dv .reg{font-family:"DM Mono",monospace;font-size:11px;background:#fff9db;color:#7a5c00;padding:2px 7px;border-radius:4px;border:1px solid #e6d080;letter-spacing:1px;flex-shrink:0}
.dv.blk .reg{background:var(--red-light);color:var(--red);border-color:rgba(200,16,46,.2)}
.dv-name{font-size:12px;font-weight:600;flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.dv-days{font-size:11px;font-weight:700;flex-shrink:0}
.card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--card-radius);overflow:hidden;box-shadow:var(--shadow);margin-bottom:20px}
.card-hdr{padding:14px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:var(--bg3)}
.card-title{font-size:12px;font-weight:700;color:var(--text2);letter-spacing:.5px;text-transform:uppercase;display:flex;align-items:center;gap:8px}
.card-title i{color:var(--blue)}
.ac-table{width:100%;border-collapse:collapse;font-size:13px}
.ac-table th{padding:10px 14px;text-align:left;font-size:10px;letter-spacing:1.2px;text-transform:uppercase;color:var(--muted);font-weight:700;border-bottom:2px solid var(--border);background:var(--bg3)}
.ac-table td{padding:10px 14px;border-bottom:1px solid var(--border);vertical-align:middle}
.ac-table tr:last-child td{border-bottom:none}
.ac-table tbody tr:hover td{background:var(--blue-light)}
.rp{font-family:"DM Mono",monospace;font-size:11px;background:#fff9db;color:#7a5c00;padding:3px 8px;border-radius:5px;border:1px solid #e6d080;letter-spacing:1.5px}
.badge{display:inline-flex;align-items:center;padding:3px 9px;border-radius:7px;font-size:11px;font-weight:700}
.b-red{background:var(--red-light);color:var(--red)}
.b-blue{background:var(--blue-light);color:var(--blue)}
.b-green{background:var(--green-light);color:var(--green)}
.b-orange{background:rgba(212,96,10,.08);color:var(--orange)}
.b-grey{background:var(--bg3);color:var(--muted)}
.sec{font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin:24px 0 14px;display:flex;align-items:center;gap:10px}
.sec::after{content:"";flex:1;height:1px;background:var(--border)}
.btn{padding:8px 16px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;border:none;font-family:"DM Sans",sans-serif;transition:all .2s;display:inline-flex;align-items:center;gap:6px}
.btn-ghost{background:var(--bg3);border:1px solid var(--border);color:var(--muted)}
.btn-ghost:hover{color:var(--text)}
@media(max-width:1200px){.dept-grid{grid-template-columns:1fr 1fr}.kpi-strip{grid-template-columns:repeat(4,1fr)}.loc-grid{grid-template-columns:1fr 1fr}}
@media(max-width:700px){.kpi-strip{grid-template-columns:1fr 1fr}}
</style>
</head>
<body>
<header class="header">
  <div class="logo-area">
    <img class="logo-img" src="./auto-capital-logo.png" alt="Auto Capital" onerror="this.style.opacity=0">
    <div class="logo-divider"></div>
    <span class="system-name">Back Office</span>
  </div>
  <nav class="nav">
    <a href="./index.html"><i class="fas fa-th-large"></i> Dashboard</a>
    <a href="./inventory.html"><i class="fas fa-car"></i> Inventory</a>
    <a href="./workflow.html" class="active"><i class="fas fa-tasks"></i> Workflow</a>
    <a href="./alerts.html"><i class="fas fa-bell"></i> Alerts</a>
    <a href="./analytics.html"><i class="fas fa-chart-bar"></i> Analytics</a>
    <a href="./marketing.html"><i class="fas fa-chart-line"></i> Marketing</a>
    <a href="./keys.html"><i class="fas fa-key"></i> Keys</a>
    <a href="./team.html"><i class="fas fa-users"></i> Team</a>
    <a href="./admin.html"><i class="fas fa-cog"></i> Admin</a>
  </nav>
  <div class="header-right">
    <span id="userBadge" class="user-badge">Auto Capital</span>
    <button class="btn-logout" onclick="doLogout()"><i class="fas fa-sign-out-alt"></i></button>
  </div>
</header>

<main class="main">
  <div class="page-hdr">
    <div>
      <h1>Workflow <span class="r">Dashboard</span></h1>
      <p id="wfSub">Loading...</p>
    </div>
    <button class="btn btn-ghost" onclick="buildAll()"><i class="fas fa-sync-alt"></i> Refresh</button>
  </div>

  <!-- KPIs -->
  <div class="kpi-strip">
    <div class="kpi" style="--kc:var(--blue)"><i class="fas fa-car bg-i"></i><div class="kpi-label">Total Active</div><div class="kpi-val" id="kTotal">—</div><div class="kpi-sub">In pipeline</div></div>
    <div class="kpi" style="--kc:var(--red)"><i class="fas fa-lock bg-i"></i><div class="kpi-label">Blocked</div><div class="kpi-val" id="kBlocked">—</div><div class="kpi-sub">Need action</div></div>
    <div class="kpi" style="--kc:var(--orange)"><i class="fas fa-hourglass-half bg-i"></i><div class="kpi-label">60+ Days</div><div class="kpi-val" id="kOld">—</div><div class="kpi-sub">Aged stock</div></div>
    <div class="kpi" style="--kc:var(--gold)"><i class="fas fa-clock bg-i"></i><div class="kpi-label">Stage 7d+</div><div class="kpi-val" id="kLongStage">—</div><div class="kpi-sub">Stuck in dept</div></div>
    <div class="kpi" style="--kc:var(--green)"><i class="fas fa-check bg-i"></i><div class="kpi-label">Ready to Sell</div><div class="kpi-val" id="kReady">—</div><div class="kpi-sub">Advertising</div></div>
    <div class="kpi" style="--kc:var(--blue)"><i class="fas fa-pound-sign bg-i"></i><div class="kpi-label">Stock Value</div><div class="kpi-val" id="kValue">—</div><div class="kpi-sub">Priced vehicles</div></div>
    <div class="kpi" style="--kc:var(--text2)"><i class="fas fa-chart-line bg-i"></i><div class="kpi-label">Avg Days</div><div class="kpi-val" id="kAvg">—</div><div class="kpi-sub">In stock avg</div></div>
  </div>

  <!-- WHERE IS OUR STOCK -->
  <div class="sec"><i class="fas fa-map-marker-alt" style="color:var(--blue)"></i> Where Is Our Stock Right Now</div>
  <div class="loc-grid" id="locGrid"></div>

  <!-- PIPELINE FLOW -->
  <div class="sec"><i class="fas fa-stream" style="color:var(--blue)"></i> Pipeline by Stage</div>
  <div class="flow-wrap"><div class="flow-stages" id="flowStages"></div></div>

  <!-- DEPT BREAKDOWN -->
  <div class="sec" style="margin-top:24px"><i class="fas fa-sitemap" style="color:var(--blue)"></i> By Department</div>
  <div class="dept-grid" id="deptGrid"></div>

  <!-- BLOCKED -->
  <div class="sec"><i class="fas fa-lock" style="color:var(--red)"></i> Blocked Vehicles — Immediate Action Required</div>
  <div class="card">
    <div class="card-hdr">
      <span class="card-title"><i class="fas fa-exclamation-triangle"></i> Blocked</span>
      <span id="blockedCount" style="font-size:12px;color:var(--muted)"></span>
    </div>
    <table class="ac-table"><thead><tr><th>Reg</th><th>Make / Model</th><th>Stage</th><th>Dept</th><th>Days in Stage</th><th>Total Days</th><th>Location</th><th>Price</th></tr></thead>
    <tbody id="blockedBody"></tbody></table>
  </div>

  <!-- AGED STOCK -->
  <div class="sec"><i class="fas fa-hourglass-end" style="color:var(--orange)"></i> Aged Stock — 60+ Days</div>
  <div class="card">
    <div class="card-hdr">
      <span class="card-title"><i class="fas fa-hourglass-half"></i> Aged Stock</span>
      <span id="agedCount" style="font-size:12px;color:var(--muted)"></span>
    </div>
    <table class="ac-table"><thead><tr><th>Reg</th><th>Make / Model</th><th>Days in Stock</th><th>Current Stage</th><th>Days in Stage</th><th>Location</th><th>Price</th></tr></thead>
    <tbody id="agedBody"></tbody></table>
  </div>

  <!-- ALL STOCK -->
  <div class="sec"><i class="fas fa-list" style="color:var(--blue)"></i> All Active Stock</div>
  <div class="card">
    <div class="card-hdr">
      <span class="card-title"><i class="fas fa-car"></i> Full Pipeline</span>
      <input id="stockSearch" placeholder="Search reg, make, model..." oninput="filterTable()" style="padding:6px 12px;border:1px solid var(--border);border-radius:7px;font-size:12px;font-family:inherit;outline:none;width:220px">
    </div>
    <div style="overflow-x:auto;max-height:500px;overflow-y:auto">
    <table class="ac-table"><thead><tr><th>Reg</th><th>Make / Model</th><th>Status</th><th>Stage</th><th>Dept</th><th>Stage Days</th><th>Total Days</th><th>Location</th><th>Price</th><th>Blocked</th></tr></thead>
    <tbody id="allBody"></tbody></table>
    </div>
  </div>
</main>

<script>
const V=getVehicles();
const LOC_C={"Stanmore Retail":"var(--blue)","Stanmore 2":"var(--green)","ACL":"var(--orange)","With Supplier":"var(--gold)"};
const DEPT_C={"Intake":"#0891b2","Workshop":"#7c3aed","Bodyshop":"#be185d","Valeting":"#0369a1","Marketing":"var(--blue)","Sales":"var(--green)","Finance":"var(--orange)","Management":"var(--red)"};
const DEPT_I={"Intake":"fa-sign-in-alt","Workshop":"fa-wrench","Bodyshop":"fa-paint-brush","Valeting":"fa-spray-can","Marketing":"fa-chart-line","Sales":"fa-handshake","Finance":"fa-file-invoice-dollar","Management":"fa-user-tie"};
const STAGE_ORDER=["Intake","Mechanical","External Work","Paint","Bodyshop","Valeting","Accounts","Legal & Docs","Management","Advertising","Delivery Prep"];

function dc(d){return d>=14?"var(--red)":d>=7?"var(--orange)":d>=4?"var(--gold)":"var(--green)";}
function fgbp(n){return n?"£"+new Intl.NumberFormat("en-GB").format(n):"—";}
function row(x){
  const sc=x.status==="In Stock"?"b-green":x.status==="In Transit"?"b-blue":"b-grey";
  return "<tr><td><span class=rp>"+x.registration+"</span></td><td><strong>"+x.make+"</strong> "+x.model+"</td><td><span class='badge "+sc+"'>"+x.status+"</span></td><td><span class='badge b-blue' style='font-size:10px'>"+x.workflowStage+"</span></td><td>"+x.workflowDept+"</td><td style='color:"+dc(x.daysInStage)+";font-weight:700'>"+x.daysInStage+"d</td><td style='color:"+(x.daysInStock>=60?"var(--red)":x.daysInStock>=30?"var(--orange)":"inherit")+";font-weight:"+(x.daysInStock>=60?"700":"400")+"'>"+x.daysInStock+"d</td><td>"+x.location+"</td><td>"+fgbp(x.price)+"</td><td>"+(x.blocked?"<i class='fas fa-lock' style='color:var(--red)'></i>":"<i class='fas fa-check' style='color:var(--green)'></i>")+"</td></tr>";
}

function buildAll(){
  const blocked=V.filter(x=>x.blocked);
  const aged=V.filter(x=>x.daysInStock>=60);
  const ls=V.filter(x=>x.daysInStage>=7);
  const ready=V.filter(x=>x.workflowStage==="Advertising");
  const priced=V.filter(x=>x.price>0);
  const tv=priced.reduce((s,x)=>s+x.price,0);
  const avg=Math.round(V.reduce((s,x)=>s+(x.daysInStock||0),0)/V.length);

  document.getElementById("wfSub").textContent=V.length+" vehicles in pipeline · "+blocked.length+" blocked · "+ls.length+" stuck in stage · Avg "+avg+" days";
  document.getElementById("kTotal").textContent=V.length;
  document.getElementById("kBlocked").textContent=blocked.length;
  document.getElementById("kOld").textContent=aged.length;
  document.getElementById("kLongStage").textContent=ls.length;
  document.getElementById("kReady").textContent=ready.length;
  document.getElementById("kValue").textContent="£"+Math.round(tv/1000)+"k";
  document.getElementById("kAvg").textContent=avg+"d";

  // LOCATIONS
  const locs={};V.forEach(x=>{const l=x.location||"Unknown";if(!locs[l])locs[l]=[];locs[l].push(x);});
  document.getElementById("locGrid").innerHTML=Object.entries(locs).sort((a,b)=>b[1].length-a[1].length).map(([loc,vs])=>
    "<div class=loc-card style='--lc:"+( LOC_C[loc]||"var(--blue)")+
    "'><div class=loc-name><i class='fas fa-map-marker-alt' style='margin-right:6px;opacity:.5'></i>"+loc+
    "</div><div class=loc-count>"+vs.length+
    "</div><div class=loc-sub>"+vs.filter(x=>x.price>0).length+" priced &middot; "+vs.filter(x=>x.blocked).length+" blocked</div>"+
    "<div class=loc-chips>"+vs.slice(0,14).map(x=>"<span class=loc-chip>"+x.registration+"</span>").join("")+(vs.length>14?"<span style='font-size:10px;color:var(--muted)'>+"+( vs.length-14)+" more</span>":"")+"</div></div>"
  ).join("");

  // PIPELINE FLOW
  const sm={};V.forEach(x=>{const s=x.workflowStage||"Unknown";if(!sm[s])sm[s]=[];sm[s].push(x);});
  const stages=STAGE_ORDER.filter(s=>sm[s]).concat(Object.keys(sm).filter(s=>!STAGE_ORDER.includes(s)));
  document.getElementById("flowStages").innerHTML=stages.map(s=>{
    const vs=sm[s]||[];
    return "<div class=flow-stage><div class=fs-hdr><div class=fs-name>"+s+"</div><div class=fs-count>"+vs.length+"</div></div>"+
           "<div class=fs-body>"+vs.map(x=>"<span class='fs-chip"+(x.blocked?" b":x.daysInStage>=7?" w":"")+"' title='"+x.make+" "+x.model+" · "+x.daysInStage+"d'>"+x.registration+"</span>").join("")+"</div></div>";
  }).join("");

  // DEPTS
  const depts={};V.forEach(x=>{const d=x.workflowDept||"Unknown";if(!depts[d])depts[d]=[];depts[d].push(x);});
  document.getElementById("deptGrid").innerHTML=Object.entries(depts).sort((a,b)=>b[1].length-a[1].length).map(([dept,vs])=>{
    const avg=(vs.reduce((s,x)=>s+(x.daysInStage||0),0)/vs.length).toFixed(1);
    const bl=vs.filter(x=>x.blocked).length;
    const col=DEPT_C[dept]||"var(--blue)";
    const icon=DEPT_I[dept]||"fa-cogs";
    return "<div class=dept-card><div class=dept-hdr>"+
      "<div class=dept-name style='color:"+col+"'><i class='fas "+icon+"' style='font-size:12px;opacity:.7'></i>"+dept+"</div>"+
      "<div class=dept-num style='color:"+col+"'>"+vs.length+"</div></div>"+
      "<div class=dept-meta><span><i class='fas fa-clock' style='opacity:.5;margin-right:3px'></i>Avg "+avg+"d</span>"+
      (bl?"<span style='color:var(--red)'><i class='fas fa-lock' style='opacity:.7;margin-right:3px'></i>"+bl+" blocked</span>":"<span style='color:var(--green)'><i class='fas fa-check' style='opacity:.7;margin-right:3px'></i>No blocks</span>")+"</div>"+
      "<div class=dept-vehicles>"+vs.sort((a,b)=>(b.daysInStage||0)-(a.daysInStage||0)).map(x=>
        "<div class='dv"+(x.blocked?" blk":"")+"'>"+
        "<span class=reg>"+x.registration+"</span>"+
        "<span class=dv-name>"+x.make+" "+x.model+"</span>"+
        "<span class=dv-days style='color:"+dc(x.daysInStage)+"'>"+x.daysInStage+"d</span>"+
        (x.blocked?"<i class='fas fa-lock' style='color:var(--red);font-size:10px'></i>":"")+"</div>"
      ).join("")+"</div></div>";
  }).join("");

  // BLOCKED TABLE
  document.getElementById("blockedCount").textContent=blocked.length+" vehicles";
  document.getElementById("blockedBody").innerHTML=blocked.length?blocked.map(x=>
    "<tr><td><span class=rp>"+x.registration+"</span></td><td><strong>"+x.make+"</strong> "+x.model+"</td>"+
    "<td><span class='badge b-blue'>"+x.workflowStage+"</span></td><td>"+x.workflowDept+"</td>"+
    "<td><strong style='color:"+dc(x.daysInStage)+"'>"+x.daysInStage+"d</strong></td>"+
    "<td><strong style='color:"+(x.daysInStock>=60?"var(--red)":"var(--orange)")+"'>"+x.daysInStock+"d</strong></td>"+
    "<td>"+x.location+"</td><td>"+fgbp(x.price)+"</td></tr>"
  ).join(""):"<tr><td colspan=8 style='text-align:center;padding:24px;color:var(--muted)'><i class='fas fa-check-circle' style='color:var(--green);margin-right:8px'></i>No blocked vehicles</td></tr>";

  // AGED
  const aged2=aged.sort((a,b)=>b.daysInStock-a.daysInStock);
  document.getElementById("agedCount").textContent=aged.length+" vehicles";
  document.getElementById("agedBody").innerHTML=aged2.map(x=>
    "<tr><td><span class=rp>"+x.registration+"</span></td><td><strong>"+x.make+"</strong> "+x.model+"</td>"+
    "<td><strong style='color:"+(x.daysInStock>=90?"var(--red)":"var(--orange)")+"'>"+x.daysInStock+"d</strong></td>"+
    "<td><span class='badge b-blue'>"+x.workflowStage+"</span></td>"+
    "<td style='color:"+dc(x.daysInStage)+";font-weight:600'>"+x.daysInStage+"d</td>"+
    "<td>"+x.location+"</td><td>"+fgbp(x.price)+"</td></tr>"
  ).join("")||"<tr><td colspan=7 style='text-align:center;padding:24px;color:var(--muted)'>No aged stock</td></tr>";

  buildAllTable(V);
}

function buildAllTable(v){
  document.getElementById("allBody").innerHTML=v.map(x=>row(x)).join("");
}
function filterTable(){
  const q=document.getElementById("stockSearch").value.toLowerCase();
  buildAllTable(V.filter(x=>!q||(x.registration+x.make+x.model+x.workflowStage).toLowerCase().includes(q)));
}
buildAll();
</script>
<script>
document.addEventListener("DOMContentLoaded",function(){var b=document.getElementById("userBadge");if(b)b.textContent="AUTO CAPITAL";});
function doLogout(){window.location.href="./login.html";}
</script>
</body>
</html>