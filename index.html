<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CapeEye | Auto Capital Command Centre</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="./firebase-config.js"></script>
<script src="./ac-data.js"></script>
<style>
:root{
  --bg:#f4f6f9;--bg2:#fff;--bg3:#f0f2f6;--bg4:#eef0f5;
  --border:#e2e6ed;--border2:#c8d0dc;
  --red:#C8102E;--red2:#a00d24;--red-light:rgba(200,16,46,.07);
  --blue:#003DA5;--blue2:#002d7a;--blue-light:rgba(0,61,165,.07);
  --gold:#d4980a;--green:#1a7f37;--green-light:rgba(26,127,55,.07);
  --orange:#d4600a;--purple:#6d28d9;
  --text:#0f1923;--text2:#3d4d5c;--muted:#7a8fa6;
  --shadow:0 1px 3px rgba(0,0,0,.07),0 4px 16px rgba(0,0,0,.04);
  --shadow-md:0 4px 12px rgba(0,0,0,.1),0 12px 40px rgba(0,0,0,.07);
  --card-radius:12px;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;-webkit-font-smoothing:antialiased}
.header{background:#fff;border-bottom:2px solid var(--border);padding:0 24px;height:68px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:200;box-shadow:0 2px 8px rgba(0,0,0,.06)}
.logo-img{height:40px;width:auto;object-fit:contain;flex-shrink:0}
.logo-divider{width:1px;height:34px;background:var(--border);flex-shrink:0}
.logo-area{display:flex;align-items:center;gap:16px}
.logo-area img{height:42px;filter:none}
.logo-divider{width:1px;height:34px;background:var(--border);flex-shrink:0}
.system-name{font-size:11px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:var(--blue);white-space:nowrap}
.nav{display:flex;gap:2px}
.nav a{padding:8px 11px;border-radius:7px;font-size:12px;font-weight:500;color:var(--muted);text-decoration:none;transition:all .18s;display:flex;align-items:center;gap:5px;white-space:nowrap}
.nav a i{font-size:12px}
.nav a:hover{background:var(--bg3);color:var(--text)}
.nav a.active{background:var(--red);color:#fff;font-weight:700}
.header-right{display:flex;align-items:center;gap:12px}
.user-badge{background:var(--blue);color:#fff;font-weight:700;font-size:11px;padding:5px 12px;border-radius:20px;letter-spacing:1px;text-transform:uppercase}
.btn-logout{background:transparent;border:1px solid var(--border2);color:var(--muted);padding:6px 10px;border-radius:7px;cursor:pointer;font-size:12px;font-family:"DM Sans",sans-serif}
.btn-logout:hover{color:var(--red);border-color:var(--red)}


* { margin:0; padding:0; box-sizing:border-box; }


/* HEADER */


.logo-area img { height:40px; width:auto; }
.logo-divider { width:1px; height:32px; background:var(--border); }




.nav a.active { color:var(--gold); }
.header-right { display:flex; align-items:center; gap:12px; }

.btn-sm { padding:7px 14px; border-radius:8px; font-size:13px; font-weight:600; cursor:pointer; border:none; font-family:'Barlow',sans-serif; }
.btn-outline { background:transparent; border:1px solid var(--border); color:var(--muted); transition:all .2s; }
.btn-outline:hover { border-color:var(--gold); color:var(--gold); }

/* MAIN */
.main { max-width:1600px; margin:0 auto; padding:28px; }

/* PAGE TITLE */
.page-title { margin-bottom:24px; }
.page-title h1 { font-family:'Barlow Condensed',sans-serif; font-size:32px; font-weight:800; letter-spacing:1px; }
.page-title p { color:var(--muted); font-size:14px; margin-top:4px; }

/* KPI GRID */
.kpi-grid { display:grid; grid-template-columns:repeat(6,1fr); gap:16px; margin-bottom:24px; }
.kpi-card {
  background:var(--bg2); border:1px solid var(--border); border-radius:var(--card-radius);
  padding:20px; position:relative; overflow:hidden; transition:border-color .2s;
}
.kpi-card:hover { border-color:rgba(255,255,255,0.15); }
.kpi-card::before {
  content:''; position:absolute; top:0; left:0; right:0; height:3px;
  background:var(--kpi-color, var(--gold));
}
.kpi-label { font-size:11px; font-weight:600; letter-spacing:1.5px; color:var(--muted); text-transform:uppercase; margin-bottom:10px; }
.kpi-value { font-family:'Barlow Condensed',sans-serif; font-size:36px; font-weight:800; line-height:1; }
.kpi-sub { font-size:12px; color:var(--muted); margin-top:6px; }
.kpi-icon { position:absolute; top:16px; right:16px; font-size:20px; opacity:0.15; }

/* CONTENT GRID */
.content-grid { display:grid; grid-template-columns:2fr 1fr; gap:20px; margin-bottom:20px; }
.content-grid-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:20px; margin-bottom:20px; }

/* CARDS */
.card {
  background:var(--bg2); border:1px solid var(--border); border-radius:var(--card-radius);
  overflow:hidden;
}
.card-header {
  padding:16px 20px; border-bottom:1px solid var(--border);
  display:flex; align-items:center; justify-content:space-between;
}
.card-title { font-family:'Barlow Condensed',sans-serif; font-size:16px; font-weight:700; letter-spacing:.5px; text-transform:uppercase; }
.card-body { padding:20px; }

/* CHART */
.chart-wrap { position:relative; height:220px; }

/* TABLE */
.ac-table { width:100%; border-collapse:collapse; font-size:13px; }
.ac-table th { padding:10px 12px; text-align:left; font-size:11px; letter-spacing:1px; text-transform:uppercase; color:var(--muted); font-weight:600; border-bottom:1px solid var(--border); }
.ac-table td { padding:11px 12px; border-bottom:1px solid rgba(255,255,255,0.04); }
.ac-table tr:last-child td { border-bottom:none; }
.ac-table tr:hover td { background:rgba(255,255,255,0.02); }

/* BADGES */
.badge { display:inline-flex; align-items:center; gap:5px; padding:3px 10px; border-radius:20px; font-size:11px; font-weight:700; letter-spacing:.5px; }
.badge-green { background:rgba(34,197,94,.15); color:var(--green); }
.badge-red { background:rgba(239,68,68,.15); color:var(--red); }
.badge-orange { background:rgba(249,115,22,.15); color:var(--orange); }
.badge-blue { background:rgba(59,127,245,.15); color:var(--blue); }
.badge-yellow { background:rgba(232,184,75,.15); color:var(--gold); }
.badge-gray { background:rgba(100,116,139,.15); color:var(--muted); }

/* STOCK REG */
.reg-plate { font-family:'Barlow Condensed',sans-serif; font-weight:700; font-size:14px; letter-spacing:1px; background:#f5c518; color:#000; padding:2px 8px; border-radius:4px; display:inline-block; }

/* ALERTS STRIP */
.alerts-strip { background:rgba(239,68,68,0.08); border:1px solid rgba(239,68,68,0.2); border-radius:var(--card-radius); padding:14px 20px; margin-bottom:20px; display:flex; gap:24px; align-items:center; flex-wrap:wrap; }
.alert-item { display:flex; align-items:center; gap:8px; font-size:13px; }
.alert-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }

/* STATUS ROW */
.status-row { display:flex; gap:16px; margin-bottom:20px; }
.status-pill { flex:1; background:var(--bg2); border:1px solid var(--border); border-radius:var(--card-radius); padding:14px 18px; display:flex; align-items:center; gap:12px; }
.status-pill-icon { width:36px; height:36px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:16px; }
.status-pill-label { font-size:12px; color:var(--muted); font-weight:500; }
.status-pill-val { font-family:'Barlow Condensed',sans-serif; font-size:24px; font-weight:800; line-height:1; }

/* SEARCH BAR */
.search-bar { display:flex; gap:10px; margin-bottom:20px; }
.search-input { flex:1; background:var(--bg2); border:1px solid var(--border); border-radius:8px; padding:10px 16px; color:var(--text); font-size:14px; font-family:'Barlow',sans-serif; outline:none; }
.search-input:focus { border-color:var(--blue); }
.search-input::placeholder { color:var(--muted); }
.filter-select { background:var(--bg2); border:1px solid var(--border); border-radius:8px; padding:10px 14px; color:var(--text); font-size:13px; font-family:'Barlow',sans-serif; outline:none; cursor:pointer; }

/* QUICK ACTIONS */
.quick-actions { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; }
.qa-btn { background:var(--bg3); border:1px solid var(--border); border-radius:10px; padding:16px; text-align:center; cursor:pointer; text-decoration:none; color:var(--text); transition:all .2s; display:block; }
.qa-btn:hover { border-color:var(--gold); transform:translateY(-1px); }
.qa-btn i { font-size:22px; color:var(--gold); display:block; margin-bottom:8px; }
.qa-btn span { font-size:12px; font-weight:600; letter-spacing:.5px; }

/* MOT WARNING */
.mot-item { display:flex; align-items:center; gap:10px; padding:8px 0; border-bottom:1px solid var(--border); }
.mot-item:last-child { border-bottom:none; }

@media (max-width:1200px) {
  .kpi-grid { grid-template-columns:repeat(3,1fr); }
  .content-grid { grid-template-columns:1fr; }
  .content-grid-3 { grid-template-columns:1fr 1fr; }
}

/* ── TOOLBAR ── */
.toolbar{display:flex;gap:4px;align-items:center;flex-shrink:0;border-left:1px solid var(--border);border-right:1px solid var(--border);padding:0 12px;margin:0 8px}
.tlink{padding:6px 10px;border-radius:6px;font-size:11px;font-weight:700;color:var(--muted);text-decoration:none;transition:all .18s;display:flex;align-items:center;gap:5px;white-space:nowrap;border:1px solid transparent}
.tlink:hover{background:var(--blue);color:#fff;border-color:var(--blue)}
.tlink i{font-size:11px}
.last-import{font-size:10px;color:var(--muted);background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:4px 9px;display:flex;align-items:center;gap:5px;white-space:nowrap;cursor:default}
.last-import.fresh{color:var(--green);border-color:var(--green);background:var(--green-light)}
.last-import.stale{color:var(--orange);border-color:var(--orange);background:rgba(212,96,10,.07)}

</style>
</head>
<body>

<header class="header">
  <div class="logo-area">
    <img class="logo-img" src="./auto-capital-logo.png" alt="Auto Capital" onerror="this.style.opacity=0">
    <div class="logo-divider"></div>
    <span class="system-name">Back Office</span>
  </div>
  <nav class="nav">
    <a href="./index.html" class="active"><i class="fas fa-th-large"></i> Dashboard</a>
    <a href="./inventory.html" class=""><i class="fas fa-car"></i> Inventory</a>
    <a href="./workflow.html" class=""><i class="fas fa-tasks"></i> Workflow</a>
    <a href="./alerts.html" class=""><i class="fas fa-bell"></i> Alerts</a>
    <a href="./analytics.html" class=""><i class="fas fa-chart-bar"></i> Analytics</a>
    <a href="./marketing.html" class=""><i class="fas fa-chart-line"></i> Marketing</a>
    <a href="./keys.html" class=""><i class="fas fa-key"></i> Keys</a>
    <a href="./import.html" class=""><i class="fas fa-upload"></i> Import</a>
    <a href="./team.html" class=""><i class="fas fa-users"></i> Team</a>
    <a href="./admin.html" class=""><i class="fas fa-cog"></i> Admin</a>
  </nav>
  <!-- QUICK LINKS TOOLBAR -->
  <div class="toolbar">
    <a href="https://trade.hpi.co.uk/trade/preLogin.do" target="_blank" class="tlink" title="HPI Check"><i class="fas fa-search-dollar"></i> HPI</a>
    <a href="https://www.autocapital.co.uk/" target="_blank" class="tlink" title="Auto Capital Website"><i class="fas fa-globe"></i> Website</a>
    <a href="https://www.autocapital.co.uk/finance.php" target="_blank" class="tlink" title="Finance Application"><i class="fas fa-file-invoice-pound"></i> Finance</a>
  </div>
  <div class="header-right">
    <div class="last-import" id="lastImportBadge" title="Last data import"><i class="fas fa-database"></i> <span id="lastImportTime">No import</span></div>
    <span id="userBadge" class="user-badge">Auto Capital</span>
    <button class="btn-logout" onclick="doLogout()"><i class="fas fa-sign-out-alt"></i></button>
  </div>
</header>

<main class="main">
  <div class="page-title">
    <h1>Command Centre</h1>
    <p id="lastUpdate">Loading live data...</p>
  </div>

  <!-- ALERTS -->
  <div class="alerts-strip" id="alertsStrip" style="display:none">
    <i class="fas fa-exclamation-triangle" style="color:var(--red)"></i>
    <strong style="font-size:13px;color:var(--red)">ATTENTION REQUIRED</strong>
    <div id="alertItems" style="display:flex;gap:20px;flex-wrap:wrap;"></div>
  </div>

  <!-- STATUS PILLS -->
  <div class="status-row">
    <div class="status-pill">
      <div class="status-pill-icon" style="background:rgba(59,127,245,.15);color:var(--blue)"><i class="fas fa-car"></i></div>
      <div><div class="status-pill-label">Total Stock</div><div class="status-pill-val" id="kTotal">—</div></div>
    </div>
    <div class="status-pill">
      <div class="status-pill-icon" style="background:rgba(34,197,94,.15);color:var(--green)"><i class="fas fa-check-circle"></i></div>
      <div><div class="status-pill-label">In Stock</div><div class="status-pill-val" id="kInStock">—</div></div>
    </div>
    <div class="status-pill">
      <div class="status-pill-icon" style="background:rgba(249,115,22,.15);color:var(--orange)"><i class="fas fa-truck"></i></div>
      <div><div class="status-pill-label">In Transit</div><div class="status-pill-val" id="kTransit">—</div></div>
    </div>
    <div class="status-pill">
      <div class="status-pill-icon" style="background:rgba(239,68,68,.15);color:var(--red)"><i class="fas fa-tools"></i></div>
      <div><div class="status-pill-label">Off-site</div><div class="status-pill-val" id="kOffsite">—</div></div>
    </div>
    <div class="status-pill">
      <div class="status-pill-icon" style="background:rgba(139,92,246,.15);color:#a78bfa"><i class="fas fa-handshake"></i></div>
      <div><div class="status-pill-label">Subject To</div><div class="status-pill-val" id="kSubject">—</div></div>
    </div>
    <div class="status-pill">
      <div class="status-pill-icon" style="background:rgba(232,184,75,.15);color:var(--gold)"><i class="fas fa-pound-sign"></i></div>
      <div><div class="status-pill-label">Total Value</div><div class="status-pill-val" id="kValue" style="font-size:20px">—</div></div>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="content-grid">
    <!-- STOCK TABLE -->
    <div class="card">
      <div class="card-header">
        <span class="card-title"><i class="fas fa-car" style="color:var(--blue);margin-right:8px"></i>Live Stock</span>
        <div style="display:flex;gap:8px">
          <input class="search-input" style="width:200px;padding:6px 12px;font-size:12px" id="stockSearch" placeholder="Search reg, make, model..." oninput="filterTable()">
          <select class="filter-select" id="statusFilter" onchange="filterTable()" style="font-size:12px;padding:6px 10px">
            <option value="">All Status</option>
            <option>In Stock</option>
            <option>In Transit</option>
            <option>Off-site R</option>
            <option>Subject to</option>
          </select>
          <a href="./inventory.html" style="padding:6px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;font-size:12px;color:var(--muted);text-decoration:none;white-space:nowrap">View All →</a>
        </div>
      </div>
      <div style="overflow-x:auto;max-height:480px;overflow-y:auto">
        <table class="ac-table" id="stockTable">
          <thead style="position:sticky;top:0;background:var(--bg2);z-index:1">
            <tr>
              <th>Stock No</th>
              <th>Registration</th>
              <th>Vehicle</th>
              <th>Location</th>
              <th>Price</th>
              <th>MOT</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="stockBody"></tbody>
        </table>
      </div>
    </div>

    <!-- RIGHT COLUMN -->
    <div style="display:flex;flex-direction:column;gap:20px">
      <!-- MAKE CHART -->
      <div class="card">
        <div class="card-header">
          <span class="card-title"><i class="fas fa-chart-pie" style="color:var(--gold);margin-right:8px"></i>Stock by Make</span>
        </div>
        <div class="card-body">
          <div class="chart-wrap"><canvas id="makeChart"></canvas></div>
        </div>
      </div>

      <!-- QUICK ACTIONS -->
      <div class="card">
        <div class="card-header"><span class="card-title">Quick Actions</span></div>
        <div class="card-body">
          <div class="quick-actions">
            <a href="./workflow.html" class="qa-btn"><i class="fas fa-tasks"></i><span>WORKFLOW</span></a>
            <a href="./inventory.html" class="qa-btn"><i class="fas fa-search"></i><span>INVENTORY</span></a>
            <a href="./analytics.html" class="qa-btn"><i class="fas fa-chart-line"></i><span>ANALYTICS</span></a>
            <a href="./import.html" class="qa-btn"><i class="fas fa-upload"></i><span>IMPORT</span></a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- BOTTOM ROW -->
  <div class="content-grid-3">
    <!-- STATUS CHART -->
    <div class="card">
      <div class="card-header"><span class="card-title"><i class="fas fa-chart-doughnut" style="color:var(--gold);margin-right:8px"></i>Status Split</span></div>
      <div class="card-body">
        <div class="chart-wrap"><canvas id="statusChart"></canvas></div>
      </div>
    </div>

    <!-- LOCATION CHART -->
    <div class="card">
      <div class="card-header"><span class="card-title"><i class="fas fa-map-marker-alt" style="color:var(--blue);margin-right:8px"></i>By Location</span></div>
      <div class="card-body">
        <div class="chart-wrap"><canvas id="locationChart"></canvas></div>
      </div>
    </div>

    <!-- MOT ALERTS -->
    <div class="card">
      <div class="card-header">
        <span class="card-title"><i class="fas fa-calendar-times" style="color:var(--red);margin-right:8px"></i>MOT Expiring Soon</span>
        <span id="motCount" class="badge badge-red">0</span>
      </div>
      <div class="card-body" style="max-height:260px;overflow-y:auto">
        <div id="motList"></div>
      </div>
    </div>
  </div>

</main>

<script>
let vehicles = getVehicles();
let filtered = [...vehicles];

function statusBadge(s) {
  const m = {'In Stock':'badge-green','In Transit':'badge-orange','Off-site R':'badge-red','Subject to':'badge-yellow','Sold':'badge-gray'};
  return `<span class="badge ${m[s]||'badge-gray'}">${s||'Unknown'}</span>`;
}

function motDays(motStr) {
  if (!motStr) return null;
  const parts = motStr.split('/');
  if (parts.length !== 3) return null;
  const d = new Date(parts[2], parts[1]-1, parts[0]);
  return Math.ceil((d - Date.now()) / 86400000);
}

function buildKPIs() {
  const v = vehicles;
  document.getElementById('kTotal').textContent = v.length;
  document.getElementById('kInStock').textContent = v.filter(x=>x.status==='In Stock').length;
  document.getElementById('kTransit').textContent = v.filter(x=>x.status==='In Transit').length;
  document.getElementById('kOffsite').textContent = v.filter(x=>x.status==='Off-site R').length;
  document.getElementById('kSubject').textContent = v.filter(x=>x.status==='Subject to').length;
  const total = v.reduce((s,x)=>s+(x.price||0),0);
  document.getElementById('kValue').textContent = formatGBP(total);
  document.getElementById('lastUpdate').textContent = `Live data · ${v.length} vehicles · Updated ${new Date().toLocaleTimeString('en-GB')}`;
}

function buildAlerts() {
  const alerts = [];
  // MOT expiring in 30 days
  const motSoon = vehicles.filter(v => { const d = motDays(v.mot); return d !== null && d <= 30 && d >= 0; });
  if (motSoon.length) alerts.push({color:'var(--red)', text:`${motSoon.length} MOT expiring within 30 days`});
  // No price
  const noPrice = vehicles.filter(v => !v.price && v.status !== 'Sold');
  if (noPrice.length) alerts.push({color:'var(--orange)', text:`${noPrice.length} vehicles with no retail price`});

  const strip = document.getElementById('alertsStrip');
  const items = document.getElementById('alertItems');
  if (alerts.length) {
    strip.style.display = 'flex';
    items.innerHTML = alerts.map(a => `<div class="alert-item"><div class="alert-dot" style="background:${a.color}"></div><span>${a.text}</span></div>`).join('');
  }
}

function buildTable() {
  const search = document.getElementById('stockSearch').value.toLowerCase();
  const status = document.getElementById('statusFilter').value;
  filtered = vehicles.filter(v => {
    const matchSearch = !search || [v.stockNo,v.registration,v.make,v.model,v.location].some(f => f && f.toLowerCase().includes(search));
    const matchStatus = !status || v.status === status;
    return matchSearch && matchStatus;
  });
  const tbody = document.getElementById('stockBody');
  tbody.innerHTML = filtered.slice(0,100).map(v => {
    const days = motDays(v.mot);
    const motColor = days === null ? '' : days < 0 ? 'color:var(--red)' : days < 30 ? 'color:var(--orange)' : 'color:var(--muted)';
    return `<tr>
      <td style="font-weight:600;color:var(--blue)">${v.stockNo}</td>
      <td><span class="reg-plate">${v.registration}</span></td>
      <td><div style="font-weight:600">${v.make} ${v.model}</div><div style="font-size:11px;color:var(--muted)">${v.fuel} · ${v.gearbox} · ${parseInt(v.mileage||0).toLocaleString()}mi</div></td>
      <td style="font-size:12px;color:var(--muted)">${v.location||'—'}</td>
      <td style="font-weight:700">${v.price ? formatGBP(v.price) : '<span style="color:var(--muted)">—</span>'}</td>
      <td style="font-size:12px;${motColor}">${v.mot||'—'}</td>
      <td>${statusBadge(v.status)}</td>
    </tr>`;
  }).join('');
  if (filtered.length > 100) {
    tbody.innerHTML += `<tr><td colspan="7" style="text-align:center;color:var(--muted);font-size:12px;padding:12px">Showing 100 of ${filtered.length} — use search to filter</td></tr>`;
  }
}

function filterTable() { buildTable(); }

let makeChart, statusChart, locationChart;
function buildCharts() {
  // Make chart
  const makeCounts = {};
  vehicles.forEach(v => { makeCounts[v.make] = (makeCounts[v.make]||0)+1; });
  const topMakes = Object.entries(makeCounts).sort((a,b)=>b[1]-a[1]).slice(0,8);
  if (makeChart) makeChart.destroy();
  makeChart = new Chart(document.getElementById('makeChart'), {
    type: 'bar',
    data: { labels: topMakes.map(m=>m[0]), datasets: [{ data: topMakes.map(m=>m[1]), backgroundColor: '#3b7ff5', borderRadius: 5 }] },
    options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}},
      scales:{ y:{beginAtZero:true, grid:{color:'rgba(255,255,255,0.05)'}, ticks:{color:'#64748b'}},
               x:{grid:{display:false}, ticks:{color:'#64748b', maxRotation:40, font:{size:11}}} } }
  });

  // Status chart
  const statusCounts = {};
  vehicles.forEach(v => { statusCounts[v.status||'Unknown'] = (statusCounts[v.status||'Unknown']||0)+1; });
  const sColors = {'In Stock':'#22c55e','In Transit':'#f97316','Off-site R':'#ef4444','Subject to':'#e8b84b','Unknown':'#64748b'};
  if (statusChart) statusChart.destroy();
  statusChart = new Chart(document.getElementById('statusChart'), {
    type: 'doughnut',
    data: { labels: Object.keys(statusCounts), datasets: [{ data: Object.values(statusCounts),
      backgroundColor: Object.keys(statusCounts).map(s=>sColors[s]||'#64748b'), borderWidth:0 }] },
    options: { responsive:true, maintainAspectRatio:false, cutout:'65%',
      plugins:{ legend:{ position:'bottom', labels:{color:'#94a3b8', font:{size:11}, padding:10} } } }
  });

  // Location chart
  const locCounts = {};
  vehicles.forEach(v => { const l = v.location||'Unknown'; locCounts[l] = (locCounts[l]||0)+1; });
  const topLocs = Object.entries(locCounts).sort((a,b)=>b[1]-a[1]).slice(0,6);
  const lColors = ['#3b7ff5','#e8b84b','#22c55e','#f97316','#a78bfa','#06b6d4'];
  if (locationChart) locationChart.destroy();
  locationChart = new Chart(document.getElementById('locationChart'), {
    type: 'bar',
    data: { labels: topLocs.map(l=>l[0]), datasets: [{ data: topLocs.map(l=>l[1]),
      backgroundColor: lColors, borderRadius: 5 }] },
    options: { responsive:true, maintainAspectRatio:false, indexAxis:'y',
      plugins:{legend:{display:false}},
      scales:{ x:{beginAtZero:true, grid:{color:'rgba(255,255,255,0.05)'}, ticks:{color:'#64748b'}},
               y:{grid:{display:false}, ticks:{color:'#94a3b8', font:{size:11}}} } }
  });
}

function buildMOT() {
  const soon = vehicles
    .filter(v => { const d = motDays(v.mot); return d !== null && d <= 60; })
    .map(v => ({ ...v, days: motDays(v.mot) }))
    .sort((a,b) => a.days - b.days)
    .slice(0, 15);

  document.getElementById('motCount').textContent = soon.length;
  document.getElementById('motList').innerHTML = soon.map(v => {
    const color = v.days < 0 ? 'var(--red)' : v.days < 30 ? 'var(--orange)' : 'var(--gold)';
    const label = v.days < 0 ? 'EXPIRED' : `${v.days}d`;
    return `<div class="mot-item">
      <span class="reg-plate" style="font-size:11px">${v.registration}</span>
      <div style="flex:1;min-width:0"><div style="font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${v.make} ${v.model}</div><div style="font-size:11px;color:var(--muted)">${v.mot}</div></div>
      <span style="font-weight:800;font-size:13px;color:${color};white-space:nowrap">${label}</span>
    </div>`;
  }).join('') || '<div style="color:var(--muted);font-size:13px;text-align:center;padding:20px">No MOT alerts</div>';
}

function refreshDash() {
  vehicles = getVehicles();
  buildKPIs(); buildAlerts(); buildTable(); buildCharts(); buildMOT();
}

// Init
refreshDash();

// Nav alert badge
function refreshNavBadge(){try{const n=getAlerts().filter(a=>!a.read).length;const b=document.getElementById('navBadge');if(b){if(n>0){b.style.display='flex';b.textContent=n>9?'9+':n;}else b.style.display='none';}}catch(e){}}
refreshNavBadge();setInterval(refreshNavBadge,10000);

</script>



<script>
document.addEventListener('DOMContentLoaded',function(){
  var b=document.getElementById('userBadge');if(b)b.textContent='AUTO CAPITAL';
});
function doLogout(){window.location.href='./login.html';}
</script>

/* ── LAST IMPORT BADGE ── */
(function(){
  try {
    const cd = localStorage.getItem('ac_import_clickdealer_ts');
    const et = localStorage.getItem('ac_import_etrack_ts');
    const ts = [cd,et].filter(Boolean).map(Number).sort((a,b)=>b-a)[0];
    const badge = document.getElementById('lastImportBadge');
    const span  = document.getElementById('lastImportTime');
    if(!ts||!badge||!span) return;
    const age = (Date.now()-ts)/3600000; // hours
    const d = new Date(ts);
    const label = d.toLocaleDateString('en-GB',{day:'2-digit',month:'short'}) + ' ' + d.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
    span.textContent = label;
    badge.title = 'Last import: '+label;
    if(age<24) badge.classList.add('fresh');
    else if(age>48) badge.classList.add('stale');
  } catch(e){}
})();

</body>
</html>
