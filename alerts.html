<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Alerts | Auto Capital</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="./firebase-config.js"></script>
<script src="./ac-data.js"></script>
<style>
:root{--bg:#f4f6f9;--bg2:#fff;--bg3:#f0f2f6;--border:#e2e6ed;--border2:#c8d0dc;--red:#C8102E;--red2:#a00d24;--red-light:rgba(200,16,46,.07);--blue:#003DA5;--blue2:#002d7a;--blue-light:rgba(0,61,165,.07);--gold:#d4980a;--green:#1a7f37;--green-light:rgba(26,127,55,.07);--orange:#d4600a;--text:#0f1923;--text2:#3d4d5c;--muted:#7a8fa6;--shadow:0 1px 3px rgba(0,0,0,.07),0 4px 16px rgba(0,0,0,.04);--shadow-md:0 4px 12px rgba(0,0,0,.1),0 12px 40px rgba(0,0,0,.07);--card-radius:12px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:"DM Sans",sans-serif;background:var(--bg);color:var(--text);min-height:100vh;-webkit-font-smoothing:antialiased}
.header{background:#fff;border-bottom:2px solid var(--border);padding:0 24px;height:68px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:200;box-shadow:0 2px 8px rgba(0,0,0,.06)}
.logo-area{display:flex;align-items:center;gap:14px;flex-shrink:0}
.logo-img{height:40px;width:auto;object-fit:contain}
.logo-divider{width:1px;height:34px;background:var(--border);flex-shrink:0}
.system-name{font-size:11px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:var(--blue);white-space:nowrap}
.nav{display:flex;gap:1px;overflow-x:auto}
.nav a{padding:8px 11px;border-radius:7px;font-size:12px;font-weight:500;color:var(--muted);text-decoration:none;transition:all .18s;display:flex;align-items:center;gap:5px;white-space:nowrap}
.nav a i{font-size:11px}
.nav a:hover{background:var(--bg3);color:var(--text)}
.nav a.active{background:var(--red);color:#fff;font-weight:700}
.header-right{display:flex;align-items:center;gap:10px;flex-shrink:0}
.user-badge{background:var(--blue);color:#fff;font-weight:700;font-size:11px;padding:5px 12px;border-radius:20px;letter-spacing:1px;text-transform:uppercase}
.btn-logout{background:transparent;border:1px solid var(--border2);color:var(--muted);padding:6px 10px;border-radius:7px;cursor:pointer;font-size:12px;font-family:"DM Sans",sans-serif}
.main{max-width:1400px;margin:0 auto;padding:28px}
.page-hdr{margin-bottom:24px;display:flex;align-items:flex-end;justify-content:space-between;flex-wrap:wrap;gap:14px}
.page-hdr h1{font-size:26px;font-weight:800;letter-spacing:-.3px}
.page-hdr h1 .r{color:var(--red)}
.page-hdr p{color:var(--muted);font-size:13px;margin-top:3px}
/* SUMMARY STRIP */
.alert-strip{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:28px}
.as-card{border-radius:var(--card-radius);padding:16px 18px;cursor:pointer;transition:all .2s;border:2px solid transparent}
.as-card:hover{transform:translateY(-2px);box-shadow:var(--shadow-md)}
.as-card.active{border-color:var(--ac)}
.as-count{font-size:32px;font-weight:800;color:var(--ac)}
.as-label{font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;margin-top:4px;color:var(--text2)}
.as-sub{font-size:11px;color:var(--muted);margin-top:2px}
/* ALERT ITEMS */
.section-hdr{display:flex;align-items:center;gap:12px;padding:16px 20px;background:var(--bg3);border-bottom:1px solid var(--border)}
.section-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0}
.section-title{font-size:14px;font-weight:700}
.section-sub{font-size:12px;color:var(--muted);margin-top:1px}
.alert-list{padding:0}
.alert-item{display:flex;align-items:center;gap:16px;padding:14px 20px;border-bottom:1px solid var(--border);transition:background .15s}
.alert-item:last-child{border-bottom:none}
.alert-item:hover{background:var(--bg3)}
.ai-left{display:flex;align-items:center;gap:12px;flex:1;min-width:0}
.ai-icon{width:34px;height:34px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0}
.ai-body{min-width:0}
.ai-title{font-size:13px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ai-sub{font-size:12px;color:var(--muted);margin-top:2px}
.ai-right{text-align:right;flex-shrink:0}
.ai-val{font-size:14px;font-weight:800}
.ai-val-sub{font-size:11px;color:var(--muted);margin-top:2px}
.rp{font-family:"DM Mono",monospace;font-size:11px;background:#fff9db;color:#7a5c00;padding:2px 7px;border-radius:4px;border:1px solid #e6d080;letter-spacing:1.5px;margin-right:6px}
.card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--card-radius);overflow:hidden;box-shadow:var(--shadow);margin-bottom:20px}
.empty{text-align:center;padding:32px;color:var(--muted)}
.empty i{font-size:28px;display:block;margin-bottom:8px;opacity:.2}
.btn{padding:8px 16px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;border:none;font-family:"DM Sans",sans-serif;transition:all .2s;display:inline-flex;align-items:center;gap:6px}
.btn-ghost{background:var(--bg3);border:1px solid var(--border);color:var(--muted)}
.btn-ghost:hover{color:var(--text)}
@media(max-width:900px){.alert-strip{grid-template-columns:1fr 1fr}}

/* ── TOOLBAR ── */
.toolbar{display:flex;gap:4px;align-items:center;flex-shrink:0;border-left:1px solid var(--border);border-right:1px solid var(--border);padding:0 12px;margin:0 8px}
.tlink{padding:6px 10px;border-radius:6px;font-size:11px;font-weight:700;color:var(--muted);text-decoration:none;transition:all .18s;display:flex;align-items:center;gap:5px;white-space:nowrap;border:1px solid transparent}
.tlink:hover{background:var(--blue);color:#fff;border-color:var(--blue)}
.tlink i{font-size:11px}
.last-import{font-size:10px;color:var(--muted);background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:4px 9px;display:flex;align-items:center;gap:5px;white-space:nowrap;cursor:default}
.last-import.fresh{color:var(--green);border-color:var(--green);background:var(--green-light)}
.last-import.stale{color:var(--orange);border-color:var(--orange);background:rgba(212,96,10,.07)}

</style>
</head>
<body>
<header class="header">
  <div class="logo-area">
    <img class="logo-img" src="./auto-capital-logo.png" alt="Auto Capital" onerror="this.style.opacity=0">
    <div class="logo-divider"></div>
    <span class="system-name">Back Office</span>
  </div>
  <nav class="nav">
    <a href="./index.html" class=""><i class="fas fa-th-large"></i> Dashboard</a>
    <a href="./inventory.html" class=""><i class="fas fa-car"></i> Inventory</a>
    <a href="./workflow.html" class=""><i class="fas fa-tasks"></i> Workflow</a>
    <a href="./alerts.html" class="active"><i class="fas fa-bell"></i> Alerts</a>
    <a href="./analytics.html" class=""><i class="fas fa-chart-bar"></i> Analytics</a>
    <a href="./marketing.html" class=""><i class="fas fa-chart-line"></i> Marketing</a>
    <a href="./keys.html" class=""><i class="fas fa-key"></i> Keys</a>
    <a href="./import.html" class=""><i class="fas fa-upload"></i> Import</a>
    <a href="./team.html" class=""><i class="fas fa-users"></i> Team</a>
    <a href="./admin.html" class=""><i class="fas fa-cog"></i> Admin</a>
  </nav>
  <!-- QUICK LINKS TOOLBAR -->
  <div class="toolbar">
    <a href="https://trade.hpi.co.uk/trade/preLogin.do" target="_blank" class="tlink" title="HPI Check"><i class="fas fa-search-dollar"></i> HPI</a>
    <a href="https://www.autocapital.co.uk/" target="_blank" class="tlink" title="Auto Capital Website"><i class="fas fa-globe"></i> Website</a>
    <a href="https://www.autocapital.co.uk/finance.php" target="_blank" class="tlink" title="Finance Application"><i class="fas fa-file-invoice-pound"></i> Finance</a>
  </div>
  <div class="header-right">
    <div class="last-import" id="lastImportBadge" title="Last data import"><i class="fas fa-database"></i> <span id="lastImportTime">No import</span></div>
    <span id="userBadge" class="user-badge">Auto Capital</span>
    <button class="btn-logout" onclick="doLogout()"><i class="fas fa-sign-out-alt"></i></button>
  </div>
</header>

<main class="main">
  <div class="page-hdr">
    <div>
      <h1>Vehicle <span class="r">Alerts</span></h1>
      <p id="alertSub">Checking all vehicles for issues...</p>
    </div>
    <button class="btn btn-ghost" onclick="buildAlerts()"><i class="fas fa-sync-alt"></i> Refresh</button>
  </div>

  <!-- SUMMARY STRIP -->
  <div class="alert-strip">
    <div class="as-card" style="background:var(--red-light);--ac:var(--red)" onclick="scrollTo('sec-mot')">
      <div class="as-count" id="sc-mot">—</div><div class="as-label"><i class="fas fa-calendar-times"></i> MOT Expiry</div><div class="as-sub">Next 30 days</div>
    </div>
    <div class="as-card" style="background:rgba(212,96,10,.07);--ac:var(--orange)" onclick="scrollTo('sec-blocked')">
      <div class="as-count" id="sc-blocked">—</div><div class="as-label"><i class="fas fa-lock"></i> Blocked</div><div class="as-sub">In pipeline</div>
    </div>
    <div class="as-card" style="background:rgba(212,152,10,.07);--ac:var(--gold)" onclick="scrollTo('sec-aged')">
      <div class="as-count" id="sc-aged">—</div><div class="as-label"><i class="fas fa-hourglass-end"></i> Aged Stock</div><div class="as-sub">60+ days</div>
    </div>
    <div class="as-card" style="background:var(--blue-light);--ac:var(--blue)" onclick="scrollTo('sec-price')">
      <div class="as-count" id="sc-price">—</div><div class="as-label"><i class="fas fa-tag"></i> No Price</div><div class="as-sub">Unpriced vehicles</div>
    </div>
    <div class="as-card" style="background:var(--green-light);--ac:var(--green)" onclick="scrollTo('sec-stage')">
      <div class="as-count" id="sc-stage">—</div><div class="as-label"><i class="fas fa-clock"></i> Stage 7d+</div><div class="as-sub">Stuck in dept</div>
    </div>
  </div>

  <!-- MOT -->
  <div class="card" id="sec-mot">
    <div class="section-hdr">
      <div class="section-icon" style="background:var(--red-light);color:var(--red)"><i class="fas fa-calendar-times"></i></div>
      <div><div class="section-title">MOT Expiring Within 30 Days</div><div class="section-sub">Vehicles that need MOT booked urgently</div></div>
    </div>
    <div class="alert-list" id="motList"></div>
  </div>

  <!-- BLOCKED -->
  <div class="card" id="sec-blocked">
    <div class="section-hdr">
      <div class="section-icon" style="background:var(--red-light);color:var(--red)"><i class="fas fa-lock"></i></div>
      <div><div class="section-title">Blocked Vehicles</div><div class="section-sub">These vehicles have a flag — immediate action needed</div></div>
    </div>
    <div class="alert-list" id="blockedList"></div>
  </div>

  <!-- AGED -->
  <div class="card" id="sec-aged">
    <div class="section-hdr">
      <div class="section-icon" style="background:rgba(212,96,10,.1);color:var(--orange)"><i class="fas fa-hourglass-end"></i></div>
      <div><div class="section-title">Aged Stock — 60+ Days Without Sale</div><div class="section-sub">These vehicles have been in stock a long time and need attention</div></div>
    </div>
    <div class="alert-list" id="agedList"></div>
  </div>

  <!-- NO PRICE -->
  <div class="card" id="sec-price">
    <div class="section-hdr">
      <div class="section-icon" style="background:var(--blue-light);color:var(--blue)"><i class="fas fa-tag"></i></div>
      <div><div class="section-title">Vehicles Without a Retail Price</div><div class="section-sub">These cannot be advertised until priced</div></div>
    </div>
    <div class="alert-list" id="priceList"></div>
  </div>

  <!-- STAGE 7D+ -->
  <div class="card" id="sec-stage">
    <div class="section-hdr">
      <div class="section-icon" style="background:var(--green-light);color:var(--green)"><i class="fas fa-clock"></i></div>
      <div><div class="section-title">Vehicles Stuck in Stage 7+ Days</div><div class="section-sub">These have been in the same workflow stage for over a week</div></div>
    </div>
    <div class="alert-list" id="stageList"></div>
  </div>
</main>

<script>
const V=getVehicles();

function motDays(s){if(!s)return null;const p=s.split("/");if(p.length!==3)return null;return Math.ceil((new Date(+p[2],+p[1]-1,+p[0]).getTime()-Date.now())/86400000);}
function fgbp(n){return n?"£"+new Intl.NumberFormat("en-GB",{maximumFractionDigits:0}).format(n):"No price";}

function alertItem(v, icon, iconBg, iconCol, title, sub, valHtml){
  return `<div class=alert-item>
    <div class=ai-left>
      <div class=ai-icon style="background:${iconBg};color:${iconCol}"><i class="fas ${icon}"></i></div>
      <div class=ai-body>
        <div class=ai-title><span class=rp>${v.registration}</span>${v.make} ${v.model}</div>
        <div class=ai-sub>${sub}</div>
      </div>
    </div>
    <div class=ai-right>${valHtml}</div>
  </div>`;
}
function empty(){return "<div class=empty><i class='fas fa-check-circle' style='color:var(--green)'></i>No issues here</div>";}

window.scrollTo=function(id){document.getElementById(id).scrollIntoView({behavior:"smooth",block:"start"});}

function buildAlerts(){
  const mot30=V.filter(x=>{const d=motDays(x.mot);return d!==null&&d<=30;}).map(x=>({...x,motD:motDays(x.mot)})).sort((a,b)=>a.motD-b.motD);
  const blocked=V.filter(x=>x.blocked);
  const aged=V.filter(x=>x.daysInStock>=60).sort((a,b)=>b.daysInStock-a.daysInStock);
  const noPrice=V.filter(x=>(!x.price||x.price===0)&&x.status!=="Sold");
  const longStage=V.filter(x=>x.daysInStage>=7).sort((a,b)=>b.daysInStage-a.daysInStage);
  const total=mot30.length+blocked.length+aged.length+noPrice.length+longStage.length;

  document.getElementById("alertSub").textContent=total+" active alerts across "+V.length+" vehicles · Updated "+new Date().toLocaleTimeString("en-GB");
  document.getElementById("sc-mot").textContent=mot30.length;
  document.getElementById("sc-blocked").textContent=blocked.length;
  document.getElementById("sc-aged").textContent=aged.length;
  document.getElementById("sc-price").textContent=noPrice.length;
  document.getElementById("sc-stage").textContent=longStage.length;

  // MOT
  document.getElementById("motList").innerHTML=mot30.length?mot30.map(x=>{
    const [col,lbl]=x.motD<0?["var(--red)","EXPIRED"]:x.motD<14?["var(--red)",x.motD+"d"]:["var(--orange)",x.motD+"d"];
    return alertItem(x,"fa-calendar-times","var(--red-light)","var(--red)",
      x.registration,
      `MOT: ${x.mot} · ${x.location} · ${x.workflowStage}`,
      `<div class=ai-val style="color:${col}">${lbl}</div><div class=ai-val-sub>${fgbp(x.price)}</div>`);
  }).join(""):empty();

  // BLOCKED
  document.getElementById("blockedList").innerHTML=blocked.length?blocked.map(x=>
    alertItem(x,"fa-lock","var(--red-light)","var(--red)",
      x.registration,
      `Stage: ${x.workflowStage} · Dept: ${x.workflowDept} · ${x.location}`,
      `<div class=ai-val style="color:var(--orange)">${x.daysInStage}d in stage</div><div class=ai-val-sub>${x.daysInStock}d total</div>`)
  ).join(""):empty();

  // AGED
  document.getElementById("agedList").innerHTML=aged.length?aged.map(x=>{
    const col=x.daysInStock>=90?"var(--red)":"var(--orange)";
    return alertItem(x,"fa-hourglass-end","rgba(212,96,10,.1)","var(--orange)",
      x.registration,
      `${x.make} ${x.model} · ${x.workflowStage} · ${x.location}`,
      `<div class=ai-val style="color:${col}">${x.daysInStock}d</div><div class=ai-val-sub>${fgbp(x.price)}</div>`);
  }).join(""):empty();

  // NO PRICE
  document.getElementById("priceList").innerHTML=noPrice.length?noPrice.map(x=>
    alertItem(x,"fa-tag","var(--blue-light)","var(--blue)",
      x.registration,
      `${x.make} ${x.model} · ${x.status} · ${x.workflowStage}`,
      `<div class=ai-val style="color:var(--blue)">${x.daysInStock}d in stock</div><div class=ai-val-sub>Needs pricing</div>`)
  ).join(""):empty();

  // STAGE 7D+
  document.getElementById("stageList").innerHTML=longStage.length?longStage.map(x=>{
    const col=x.daysInStage>=14?"var(--red)":"var(--orange)";
    return alertItem(x,"fa-clock","var(--green-light)","var(--green)",
      x.registration,
      `${x.make} ${x.model} · Dept: ${x.workflowDept} · ${x.location}`,
      `<div class=ai-val style="color:${col}">${x.daysInStage}d in ${x.workflowStage}</div><div class=ai-val-sub>${x.daysInStock}d total</div>`);
  }).join(""):empty();
}
buildAlerts();
</script>
<script>
document.addEventListener("DOMContentLoaded",function(){var b=document.getElementById("userBadge");if(b)b.textContent="AUTO CAPITAL";});
function doLogout(){window.location.href="./login.html";}
</script>

/* ── LAST IMPORT BADGE ── */
(function(){
  try {
    const cd = localStorage.getItem('ac_import_clickdealer_ts');
    const et = localStorage.getItem('ac_import_etrack_ts');
    const ts = [cd,et].filter(Boolean).map(Number).sort((a,b)=>b-a)[0];
    const badge = document.getElementById('lastImportBadge');
    const span  = document.getElementById('lastImportTime');
    if(!ts||!badge||!span) return;
    const age = (Date.now()-ts)/3600000; // hours
    const d = new Date(ts);
    const label = d.toLocaleDateString('en-GB',{day:'2-digit',month:'short'}) + ' ' + d.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
    span.textContent = label;
    badge.title = 'Last import: '+label;
    if(age<24) badge.classList.add('fresh');
    else if(age>48) badge.classList.add('stale');
  } catch(e){}
})();

</body>
</html>