<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Alerts | CapeEye Auto Capital</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow:wght@300;400;500;600;700;800&family=Barlow+Condensed:wght@500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="./firebase-config.js"></script>
<script src="./ac-data.js"></script>
<style>
:root{--bg:#0b0e15;--bg2:#111622;--bg3:#1a2035;--border:rgba(255,255,255,0.07);--accent:#e8b84b;--accent2:#3b7ff5;--green:#22c55e;--red:#ef4444;--orange:#f97316;--text:#f1f5f9;--muted:#64748b;--card-radius:12px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Barlow',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
.header{background:var(--bg2);border-bottom:1px solid var(--border);padding:0 28px;height:64px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
.logo-area{display:flex;align-items:center;gap:14px}
.logo-area img{height:40px;width:auto}
.logo-divider{width:1px;height:32px;background:var(--border)}
.system-name{font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:700;letter-spacing:2px;color:var(--accent)}
.nav{display:flex;gap:4px}
.nav a{padding:8px 16px;border-radius:8px;font-size:14px;font-weight:500;color:var(--muted);text-decoration:none;transition:all .2s;position:relative}
.nav a:hover,.nav a.active{background:var(--bg3);color:var(--text)}
.nav a.active{color:var(--accent)}
.alert-badge{position:absolute;top:5px;right:5px;background:var(--red);color:#fff;font-size:9px;font-weight:800;min-width:16px;height:16px;border-radius:8px;display:none;align-items:center;justify-content:center;padding:0 3px}
.user-badge{background:var(--accent);color:#000;font-weight:700;font-size:12px;padding:4px 12px;border-radius:20px;letter-spacing:1px}
.main{max-width:1600px;margin:0 auto;padding:28px}
.page-title{margin-bottom:24px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
.page-title h1{font-family:'Barlow Condensed',sans-serif;font-size:32px;font-weight:800;letter-spacing:1px}
.btn{padding:9px 18px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;border:none;font-family:'Barlow',sans-serif;transition:all .2s;display:inline-flex;align-items:center;gap:8px}
.btn-ghost{background:var(--bg3);border:1px solid var(--border);color:var(--muted)}.btn-ghost:hover{color:var(--text)}
.btn-primary{background:var(--accent2);color:#fff}
.btn-danger{background:rgba(239,68,68,.15);color:var(--red);border:1px solid rgba(239,68,68,.3)}
/* KPIs */
.kpi-row{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:28px}
.kpi-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--card-radius);padding:20px;position:relative;overflow:hidden}
.kpi-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--kpi-color,var(--accent))}
.kpi-label{font-size:11px;font-weight:700;letter-spacing:1.5px;color:var(--muted);text-transform:uppercase;margin-bottom:10px}
.kpi-val{font-family:'Barlow Condensed',sans-serif;font-size:40px;font-weight:800;line-height:1}
.kpi-sub{font-size:12px;color:var(--muted);margin-top:6px}
.kpi-icon{position:absolute;top:16px;right:16px;font-size:22px;opacity:0.12}
/* FILTERS */
.filters{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap}
.filter-btn{padding:7px 16px;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;border:1px solid var(--border);background:var(--bg3);color:var(--muted);transition:all .2s;letter-spacing:.5px}
.filter-btn.active{border-color:var(--accent2);color:var(--accent2);background:rgba(59,127,245,.08)}
/* CARDS */
.alerts-section{margin-bottom:32px}
.section-title{font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:800;letter-spacing:1px;margin-bottom:14px;padding-bottom:8px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
.alert-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--card-radius);padding:0;overflow:hidden;margin-bottom:10px;transition:border-color .2s}
.alert-card:hover{border-color:rgba(255,255,255,.12)}
.alert-card.unread{border-left:3px solid var(--accent2)}
.alert-card.level-critical{border-left:3px solid var(--red)}
.alert-card.level-warning{border-left:3px solid var(--orange)}
.alert-card.level-info{border-left:3px solid var(--accent2)}
.alert-card.level-success{border-left:3px solid var(--green)}
.ac-inner{padding:14px 18px;display:flex;align-items:flex-start;gap:14px}
.ac-icon{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;margin-top:2px}
.ac-content{flex:1;min-width:0}
.ac-title{font-size:14px;font-weight:700;margin-bottom:3px}
.ac-body{font-size:13px;color:var(--muted);line-height:1.5}
.ac-meta{display:flex;align-items:center;gap:12px;margin-top:6px;flex-wrap:wrap}
.ac-time{font-size:11px;color:var(--muted)}
.ac-badge{display:inline-flex;align-items:center;padding:2px 8px;border-radius:12px;font-size:10px;font-weight:800;letter-spacing:.5px}
.badge-red{background:rgba(239,68,68,.15);color:var(--red)}
.badge-orange{background:rgba(249,115,22,.15);color:var(--orange)}
.badge-blue{background:rgba(59,127,245,.15);color:var(--accent2)}
.badge-green{background:rgba(34,197,94,.15);color:var(--green)}
.badge-yellow{background:rgba(232,184,75,.15);color:var(--accent)}
.ac-actions{display:flex;gap:8px;margin-left:auto;flex-shrink:0}
.ac-btn{padding:5px 12px;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;border:1px solid var(--border);background:var(--bg3);color:var(--muted);transition:all .2s;font-family:'Barlow',sans-serif}
.ac-btn:hover{color:var(--text);border-color:rgba(255,255,255,.2)}
/* MOT table */
.ac-table{width:100%;border-collapse:collapse;font-size:13px}
.ac-table th{padding:10px 14px;text-align:left;font-size:11px;letter-spacing:1px;text-transform:uppercase;color:var(--muted);font-weight:600;border-bottom:1px solid var(--border)}
.ac-table td{padding:11px 14px;border-bottom:1px solid rgba(255,255,255,0.04)}
.ac-table tr:hover td{background:rgba(255,255,255,.02)}
.card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--card-radius);overflow:hidden}
.card-header{padding:14px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.card-title{font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:700;letter-spacing:.5px;text-transform:uppercase}
.reg-plate{font-family:'Barlow Condensed',sans-serif;font-weight:800;font-size:13px;letter-spacing:1px;background:#f5c518;color:#000;padding:2px 8px;border-radius:4px}
.empty-state{text-align:center;padding:48px 20px;color:var(--muted)}
.empty-state i{font-size:40px;margin-bottom:12px;display:block;opacity:.4}
.empty-state p{font-size:14px}
@media(max-width:768px){.kpi-row{grid-template-columns:1fr 1fr}}
</style>
</head>
<body>
<header class="header">
  <div class="logo-area">
    <img src="./autocapital-logo.png" alt="Auto Capital">
    <div class="logo-divider"></div>
    <span class="system-name">CAPEYE</span>
  </div>
      <nav class="nav">
    <a href="./index.html"><i class="fas fa-th-large"></i> Dashboard</a>
    <a href="./inventory.html"><i class="fas fa-car"></i> Inventory</a>
    <a href="./workflow.html"><i class="fas fa-tasks"></i> Workflow</a>
    <a href="./keys.html"><i class="fas fa-key"></i> Keys</a>
    <a href="./alerts.html" class="active"><i class="fas fa-bell"></i> Alerts</a>
    <a href="./marketing.html"><i class="fas fa-chart-line"></i> Marketing</a>
    <a href="./team.html"><i class="fas fa-users"></i> Team</a>
    <a href="./admin.html"><i class="fas fa-cog"></i> Admin</a>
    <a href="./import.html"><i class="fas fa-file-upload"></i> Import</a>
  </nav>
  <div style="display:flex;gap:10px;align-items:center">
    <span class="user-badge">AUTO CAPITAL</span>
  </div>
</header>

<main class="main">
  <div class="page-title">
    <div>
      <h1><i class="fas fa-bell" style="color:var(--red);margin-right:10px"></i>Alerts Dashboard</h1>
      <p style="color:var(--muted);font-size:14px;margin-top:4px">Vehicles stuck in stage 48h+, MOT warnings, handover log &amp; system events</p>
    </div>
    <div style="display:flex;gap:10px">
      <button class="btn btn-ghost" onclick="markAllRead()"><i class="fas fa-check-double"></i> Mark All Read</button>
      <button class="btn btn-ghost" onclick="buildAll()"><i class="fas fa-sync-alt"></i> Refresh</button>
    </div>
  </div>

  <!-- KPIs -->
  <div class="kpi-row">
    <div class="kpi-card" style="--kpi-color:var(--red)">
      <i class="fas fa-hourglass-half kpi-icon"></i>
      <div class="kpi-label">Stuck in Stage 48h+</div>
      <div class="kpi-val" id="kStuck">â€”</div>
      <div class="kpi-sub">Vehicles overdue for progression</div>
    </div>
    <div class="kpi-card" style="--kpi-color:var(--orange)">
      <i class="fas fa-calendar-times kpi-icon"></i>
      <div class="kpi-label">MOT Expiring 30 Days</div>
      <div class="kpi-val" id="kMot">â€”</div>
      <div class="kpi-sub">Require immediate attention</div>
    </div>
    <div class="kpi-card" style="--kpi-color:var(--accent)">
      <i class="fas fa-pound-sign kpi-icon"></i>
      <div class="kpi-label">No Price Set</div>
      <div class="kpi-val" id="kNoPrice">â€”</div>
      <div class="kpi-sub">In-stock vehicles without a price</div>
    </div>
    <div class="kpi-card" style="--kpi-color:var(--accent2)">
      <i class="fas fa-exchange-alt kpi-icon"></i>
      <div class="kpi-label">Handovers Today</div>
      <div class="kpi-val" id="kHandovers">â€”</div>
      <div class="kpi-sub">Stage completions logged</div>
    </div>
  </div>

  <!-- FILTERS -->
  <div class="filters">
    <button class="filter-btn active" id="f_all" onclick="setFilter('all')">All Alerts</button>
    <button class="filter-btn" id="f_stuck" onclick="setFilter('stuck')">âš  Stuck 48h+</button>
    <button class="filter-btn" id="f_mot" onclick="setFilter('mot')">ðŸ“… MOT Expiry</button>
    <button class="filter-btn" id="f_handover" onclick="setFilter('handover')">ðŸ”„ Handovers</button>
    <button class="filter-btn" id="f_price" onclick="setFilter('price')">ðŸ’° No Price</button>
    <button class="filter-btn" id="f_unread" onclick="setFilter('unread')">ðŸ”µ Unread Only</button>
  </div>

  <!-- STUCK VEHICLES -->
  <div class="alerts-section" id="stuckSection">
    <div class="section-title"><i class="fas fa-hourglass-half" style="color:var(--red)"></i> Vehicles Stuck in Stage â€” 48+ Hours</div>
    <div id="stuckList"></div>
  </div>

  <!-- MOT ALERTS -->
  <div class="alerts-section" id="motSection">
    <div class="section-title"><i class="fas fa-calendar-times" style="color:var(--orange)"></i> MOT Expiry Alerts</div>
    <div class="card">
      <div class="card-header">
        <span class="card-title">Expiring within 60 days</span>
        <span id="motBadge" style="background:rgba(249,115,22,.15);color:var(--orange);font-size:11px;font-weight:800;padding:3px 10px;border-radius:12px">0</span>
      </div>
      <div style="overflow-x:auto">
        <table class="ac-table">
          <thead><tr><th>Reg</th><th>Stock No</th><th>Vehicle</th><th>Location</th><th>Status</th><th>MOT Expiry</th><th>Days Remaining</th><th>Action</th></tr></thead>
          <tbody id="motTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- PRICE ALERTS -->
  <div class="alerts-section" id="priceSection">
    <div class="section-title"><i class="fas fa-pound-sign" style="color:var(--accent)"></i> In-Stock Vehicles Without a Price</div>
    <div class="card">
      <div style="overflow-x:auto">
        <table class="ac-table">
          <thead><tr><th>Reg</th><th>Stock No</th><th>Vehicle</th><th>Location</th><th>Days in Stock</th><th>Action</th></tr></thead>
          <tbody id="priceTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- HANDOVER FEED -->
  <div class="alerts-section" id="handoverSection">
    <div class="section-title"><i class="fas fa-exchange-alt" style="color:var(--accent2)"></i> Handover &amp; Activity Feed</div>
    <div id="activityFeed"></div>
  </div>

</main>

<script>
const vehicles = getVehicles();
let currentFilter = 'all';

function motDays(str) {
  if (!str) return null;
  const p = str.split('/');
  if (p.length!==3) return null;
  return Math.ceil((new Date(p[2],p[1]-1,p[0])-Date.now())/86400000);
}

function buildKPIs() {
  // Stuck 48h+
  let stuck = 0;
  vehicles.forEach(v => {
    const wf = getWorkflow(v.stockNo);
    const done = Object.keys(wf).map(Number).filter(n=>wf[n]&&wf[n].completed);
    const cs = done.length?Math.min(Math.max(...done)+1,12):1;
    const hrs = hoursInStage(v.stockNo, cs);
    if (hrs>=48) stuck++;
  });
  document.getElementById('kStuck').textContent = stuck;

  // MOT 30 days
  const mot30 = vehicles.filter(v=>{const d=motDays(v.mot);return d!==null&&d<=30&&d>=0;}).length;
  document.getElementById('kMot').textContent = mot30;

  // No price
  const noPrice = vehicles.filter(v=>!v.price&&v.status==='In Stock').length;
  document.getElementById('kNoPrice').textContent = noPrice;

  // Handovers today
  const today = new Date().toDateString();
  const todayHo = getAlerts().filter(a=>a.type==='handover'&&new Date(a.ts).toDateString()===today).length;
  document.getElementById('kHandovers').textContent = todayHo;

  // Nav badge
  const unread = getAlerts().filter(a=>!a.read).length;
  const badge = document.getElementById('navBadge');
  if(unread>0){badge.style.display='flex';badge.textContent=unread>9?'9+':unread;}else{badge.style.display='none';}
}

function buildStuck() {
  const list = document.getElementById('stuckList');
  const stuckVehicles = [];
  vehicles.forEach(v => {
    const wf = getWorkflow(v.stockNo);
    const done = Object.keys(wf).map(Number).filter(n=>wf[n]&&wf[n].completed);
    const cs = done.length?Math.min(Math.max(...done)+1,12):1;
    const hrs = hoursInStage(v.stockNo, cs);
    if (hrs>=48) stuckVehicles.push({v, cs, hrs, stage:AC_WORKFLOW_STAGES[cs-1]});
  });
  stuckVehicles.sort((a,b)=>b.hrs-a.hrs);
  if (!stuckVehicles.length) {
    list.innerHTML = `<div class="empty-state"><i class="fas fa-check-circle" style="color:var(--green)"></i><p>No vehicles stuck in stage â€” all progressing well!</p></div>`;
    return;
  }
  list.innerHTML = stuckVehicles.map(({v,cs,hrs,stage})=>{
    const level = hrs>=120?'critical':hrs>=72?'warning':'info';
    const lvlColors={critical:'var(--red)',warning:'var(--orange)',info:'var(--accent)'};
    const lvlBg={critical:'rgba(239,68,68,.12)',warning:'rgba(249,115,22,.12)',info:'rgba(232,184,75,.12)'};
    const days = Math.floor(hrs/24), remHrs = hrs%24;
    return `<div class="alert-card level-${level}">
      <div class="ac-inner">
        <div class="ac-icon" style="background:${lvlBg[level]};color:${lvlColors[level]}"><i class="fas fa-hourglass-half"></i></div>
        <div class="ac-content">
          <div class="ac-title">
            <span class="reg-plate" style="font-size:12px;margin-right:8px">${v.registration}</span>
            ${v.make} ${v.model}
            <span class="ac-badge badge-${level==='critical'?'red':level==='warning'?'orange':'yellow'}" style="margin-left:8px">${level.toUpperCase()}</span>
          </div>
          <div class="ac-body">${v.stockNo} Â· Stage ${cs}: <strong>${stage.name}</strong> Â· ${v.location||'â€”'}</div>
          <div class="ac-meta">
            <span class="ac-time" style="color:${lvlColors[level]};font-weight:700"><i class="fas fa-clock"></i> ${days>0?days+'d ':''} ${remHrs}h in stage</span>
            <span class="ac-badge" style="background:${stage.color}22;color:${stage.color}">${stage.dept}</span>
          </div>
        </div>
        <div class="ac-actions">
          <button class="ac-btn" onclick="goWorkflow('${v.stockNo}')">Open Workflow â†’</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

function buildMOT() {
  const soon = vehicles.map(v=>({...v,days:motDays(v.mot)}))
    .filter(v=>v.days!==null&&v.days<=60)
    .sort((a,b)=>a.days-b.days);
  document.getElementById('motBadge').textContent = soon.length;
  document.getElementById('motTable').innerHTML = soon.map(v=>{
    const color = v.days<0?'var(--red)':v.days<14?'var(--red)':v.days<30?'var(--orange)':'var(--accent)';
    const label = v.days<0?'EXPIRED':`${v.days}d`;
    const badgeClass = v.days<0?'badge-red':v.days<30?'badge-orange':'badge-yellow';
    return `<tr>
      <td><span class="reg-plate">${v.registration}</span></td>
      <td style="color:var(--accent2);font-weight:700">${v.stockNo}</td>
      <td>${v.make} ${v.model}<div style="font-size:11px;color:var(--muted)">${v.fuel}Â·${v.gearbox}</div></td>
      <td style="font-size:12px;color:var(--muted)">${v.location||'â€”'}</td>
      <td>${statusBadge(v.status)}</td>
      <td style="font-weight:600">${v.mot||'â€”'}</td>
      <td><span class="ac-badge ${badgeClass}" style="font-size:12px;padding:4px 10px">${label}</span></td>
      <td><button class="ac-btn" onclick="goWorkflow('${v.stockNo}')">Workflow â†’</button></td>
    </tr>`;
  }).join('')||'<tr><td colspan="8" style="text-align:center;color:var(--muted);padding:20px">No MOT alerts within 60 days</td></tr>';
}

function buildPrice() {
  const noPrice = vehicles.filter(v=>!v.price&&v.status==='In Stock');
  document.getElementById('priceTable').innerHTML = noPrice.map(v=>{
    const days = daysSince(v.regDate);
    return `<tr>
      <td><span class="reg-plate">${v.registration}</span></td>
      <td style="color:var(--accent2);font-weight:700">${v.stockNo}</td>
      <td>${v.make} ${v.model}<div style="font-size:11px;color:var(--muted)">${v.fuel}Â·${v.gearbox}</div></td>
      <td style="font-size:12px;color:var(--muted)">${v.location||'â€”'}</td>
      <td style="color:${days>30?'var(--orange)':'var(--muted)'}">${days}d</td>
      <td><button class="ac-btn" onclick="goWorkflow('${v.stockNo}')">Open â†’</button></td>
    </tr>`;
  }).join('')||'<tr><td colspan="6" style="text-align:center;color:var(--muted);padding:20px">All in-stock vehicles have a price set âœ“</td></tr>';
}

function buildActivity() {
  const alerts = getAlerts();
  const feed = document.getElementById('activityFeed');
  if (!alerts.length) {
    feed.innerHTML = `<div class="empty-state"><i class="fas fa-inbox"></i><p>No activity yet â€” handovers and system events will appear here.</p></div>`;
    return;
  }
  const levelIcons = {handover:'fa-exchange-alt',stuck:'fa-hourglass-half',mot:'fa-calendar-times',info:'fa-info-circle'};
  const levelColors = {handover:'var(--accent2)',stuck:'var(--orange)',mot:'var(--red)',info:'var(--muted)'};
  const levelBg = {handover:'rgba(59,127,245,.12)',stuck:'rgba(249,115,22,.12)',mot:'rgba(239,68,68,.12)',info:'rgba(100,116,139,.12)'};
  feed.innerHTML = alerts.slice(0,50).map(a=>{
    const t = a.type||'info';
    const ts = new Date(a.ts);
    const ago = timeAgo(ts);
    return `<div class="alert-card ${!a.read?'unread':''} level-${a.level||'info'}" id="alert_${a.id}">
      <div class="ac-inner">
        <div class="ac-icon" style="background:${levelBg[t]||levelBg.info};color:${levelColors[t]||levelColors.info}">
          <i class="fas ${levelIcons[t]||levelIcons.info}"></i>
        </div>
        <div class="ac-content">
          <div class="ac-title">${a.title||'System Event'}${!a.read?'<span style="display:inline-block;width:7px;height:7px;border-radius:50%;background:var(--accent2);margin-left:8px;vertical-align:middle"></span>':''}</div>
          <div class="ac-body">${a.body||''}</div>
          <div class="ac-meta">
            <span class="ac-time"><i class="fas fa-clock"></i> ${ago} Â· ${ts.toLocaleString('en-GB')}</span>
            ${a.stockNo?`<span class="ac-badge badge-blue">${a.stockNo}</span>`:''}
          </div>
        </div>
        <div class="ac-actions">
          ${!a.read?`<button class="ac-btn" onclick="markOne(${a.id})">Mark Read</button>`:''}
          ${a.stockNo?`<button class="ac-btn" onclick="goWorkflow('${a.stockNo}')">View â†’</button>`:''}
        </div>
      </div>
    </div>`;
  }).join('');
}

function setFilter(f) {
  currentFilter = f;
  document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('f_'+f).classList.add('active');
  const show = (id, vis) => { const el=document.getElementById(id); if(el) el.style.display=vis?'block':'none'; };
  const all = f==='all';
  show('stuckSection',   all||f==='stuck'||f==='unread');
  show('motSection',     all||f==='mot'||f==='unread');
  show('priceSection',   all||f==='price'||f==='unread');
  show('handoverSection',all||f==='handover'||f==='unread');
}

function markAllRead() {
  markAllAlertsRead();
  buildActivity(); buildKPIs();
}
function markOne(id) {
  markAlertRead(id);
  buildActivity(); buildKPIs();
}
function goWorkflow(stockNo) {
  window.location.href=`./workflow.html?stock=${stockNo}`;
}

function statusBadge(s) {
  const m={'In Stock':'badge-green','In Transit':'badge-orange','Off-site R':'badge-red','Subject to':'badge-yellow'};
  return `<span class="ac-badge ${m[s]||''}">${s||'Unknown'}</span>`;
}
function timeAgo(d) {
  const diff = Date.now()-d.getTime();
  const mins = Math.floor(diff/60000);
  if(mins<1) return 'Just now';
  if(mins<60) return `${mins}m ago`;
  const hrs = Math.floor(mins/60);
  if(hrs<24) return `${hrs}h ago`;
  return `${Math.floor(hrs/24)}d ago`;
}

function buildAll() {
  buildKPIs(); buildStuck(); buildMOT(); buildPrice(); buildActivity();
}

buildAll();
setFilter('all');

// Auto-refresh every 60s
setInterval(buildAll, 60000);
</script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
const _fapp = initializeApp(FIREBASE_CONFIG);
const _fauth = getAuth(_fapp);
window.doLogout = () => signOut(_fauth).then(() => location.href = './login.html');
onAuthStateChanged(_fauth, user => {
  if (!user) { location.href = './login.html'; return; }
  const b = document.getElementById('userBadge');
  if (b) b.textContent = user.email.split('@')[0].toUpperCase();
});
</script>
</body>
</html>
