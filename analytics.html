<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Analytics | CapeEye Auto Capital</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow:wght@300;400;500;600;700;800&family=Barlow+Condensed:wght@500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="./firebase-config.js"></script>
<script src="./ac-data.js"></script>
<style>
:root{--bg:#0b0e15;--bg2:#111622;--bg3:#1a2035;--border:rgba(255,255,255,0.07);--accent:#e8b84b;--accent2:#3b7ff5;--green:#22c55e;--red:#ef4444;--orange:#f97316;--text:#f1f5f9;--muted:#64748b;--card-radius:12px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Barlow',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
.header{background:var(--bg2);border-bottom:1px solid var(--border);padding:0 28px;height:64px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
.logo-area{display:flex;align-items:center;gap:14px}
.logo-area img{height:40px;width:auto}
.logo-divider{width:1px;height:32px;background:var(--border)}
.system-name{font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:700;letter-spacing:2px;color:var(--accent)}
.nav{display:flex;gap:4px}
.nav a{padding:8px 16px;border-radius:8px;font-size:14px;font-weight:500;color:var(--muted);text-decoration:none;transition:all .2s}
.nav a:hover,.nav a.active{background:var(--bg3);color:var(--text)}
.nav a.active{color:var(--accent)}
.user-badge{background:var(--accent);color:#000;font-weight:700;font-size:12px;padding:4px 12px;border-radius:20px;letter-spacing:1px}
.main{max-width:1600px;margin:0 auto;padding:28px}
.page-title{margin-bottom:24px}
.page-title h1{font-family:'Barlow Condensed',sans-serif;font-size:32px;font-weight:800;letter-spacing:1px}
.page-title p{color:var(--muted);font-size:14px;margin-top:4px}
.card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--card-radius);overflow:hidden}
.card-header{padding:14px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.card-title{font-family:'Barlow Condensed',sans-serif;font-size:15px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;display:flex;align-items:center;gap:8px}
.card-body{padding:18px}
.chart-h-sm{position:relative;height:180px}
.chart-h-md{position:relative;height:240px}
.chart-h-lg{position:relative;height:300px}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-bottom:18px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:18px;margin-bottom:18px}
.grid-4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:18px;margin-bottom:18px}
.kpi-row{display:grid;grid-template-columns:repeat(5,1fr);gap:14px;margin-bottom:20px}
.kpi{background:var(--bg2);border:1px solid var(--border);border-radius:var(--card-radius);padding:18px;position:relative;overflow:hidden}
.kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--kpi-color,var(--accent))}
.kpi-label{font-size:11px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:8px;font-weight:600}
.kpi-val{font-family:'Barlow Condensed',sans-serif;font-size:34px;font-weight:800;line-height:1}
.kpi-sub{font-size:12px;color:var(--muted);margin-top:5px}
.ac-table{width:100%;border-collapse:collapse;font-size:13px}
.ac-table th{padding:10px 14px;text-align:left;font-size:11px;letter-spacing:1px;text-transform:uppercase;color:var(--muted);font-weight:600;border-bottom:1px solid var(--border)}
.ac-table td{padding:11px 14px;border-bottom:1px solid rgba(255,255,255,0.04)}
.ac-table tr:last-child td{border-bottom:none}
.ac-table tr:hover td{background:rgba(255,255,255,0.02)}
.badge{display:inline-flex;align-items:center;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700}
.badge-green{background:rgba(34,197,94,.15);color:var(--green)}
.badge-red{background:rgba(239,68,68,.15);color:var(--red)}
.badge-orange{background:rgba(249,115,22,.15);color:var(--orange)}
.badge-yellow{background:rgba(232,184,75,.15);color:var(--accent)}
.reg-plate{font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:12px;letter-spacing:1px;background:#f5c518;color:#000;padding:2px 7px;border-radius:3px;display:inline-block}
.section-title{font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:800;letter-spacing:1px;margin:24px 0 14px;padding-bottom:8px;border-bottom:1px solid var(--border);color:var(--accent)}
</style>
</head>
<body>
<header class="header">
  <div class="logo-area">
    <img src="./autocapital-logo.png" alt="Auto Capital">
    <div class="logo-divider"></div>
    <span class="system-name">CAPEYE</span>
  </div>
    <nav class="nav">
    <a href="./index.html"><i class="fas fa-th-large"></i> Dashboard</a>
    <a href="./inventory.html"><i class="fas fa-car"></i> Inventory</a>
    <a href="./workflow.html"><i class="fas fa-tasks"></i> Workflow</a>
    <a href="./alerts.html"><i class="fas fa-bell"></i> Alerts</a>
    <a href="./marketing.html"><i class="fas fa-chart-line"></i> Marketing</a>
    <a href="./team.html"><i class="fas fa-users"></i> Team</a>
    <a href="./admin.html"><i class="fas fa-cog"></i> Admin</a>
  </nav>
  <div><span class="user-badge">AUTO CAPITAL</span></div>
</header>

<main class="main">
  <div class="page-title">
    <h1>Analytics & Intelligence</h1>
    <p id="analyticsSubtitle">Generating insights...</p>
  </div>

  <!-- TOP KPIs -->
  <div class="kpi-row">
    <div class="kpi" style="--kpi-color:var(--accent2)">
      <div class="kpi-label">Total Stock</div>
      <div class="kpi-val" id="aTotal">â€”</div>
      <div class="kpi-sub">Active vehicles</div>
    </div>
    <div class="kpi" style="--kpi-color:var(--green)">
      <div class="kpi-label">Total Value</div>
      <div class="kpi-val" id="aTotalVal" style="font-size:22px">â€”</div>
      <div class="kpi-sub">Retail price total</div>
    </div>
    <div class="kpi" style="--kpi-color:var(--accent)">
      <div class="kpi-label">Average Price</div>
      <div class="kpi-val" id="aAvgPrice" style="font-size:22px">â€”</div>
      <div class="kpi-sub">Per vehicle</div>
    </div>
    <div class="kpi" style="--kpi-color:var(--orange)">
      <div class="kpi-label">Avg Mileage</div>
      <div class="kpi-val" id="aAvgMiles">â€”</div>
      <div class="kpi-sub">Miles per vehicle</div>
    </div>
    <div class="kpi" style="--kpi-color:var(--red)">
      <div class="kpi-label">MOT Alerts</div>
      <div class="kpi-val" id="aMOTAlerts">â€”</div>
      <div class="kpi-sub">Expiring â‰¤ 60 days</div>
    </div>
  </div>

  <!-- STOCK OVERVIEW -->
  <div class="section-title">ðŸ“Š Stock Overview</div>
  <div class="grid-4">
    <div class="card"><div class="card-header"><span class="card-title"><i class="fas fa-circle-notch" style="color:var(--accent2)"></i> Status Split</span></div><div class="card-body"><div class="chart-h-sm"><canvas id="cStatus"></canvas></div></div></div>
    <div class="card"><div class="card-header"><span class="card-title"><i class="fas fa-map-marker-alt" style="color:var(--green)"></i> By Location</span></div><div class="card-body"><div class="chart-h-sm"><canvas id="cLocation"></canvas></div></div></div>
    <div class="card"><div class="card-header"><span class="card-title"><i class="fas fa-gas-pump" style="color:var(--orange)"></i> Fuel Type</span></div><div class="card-body"><div class="chart-h-sm"><canvas id="cFuel"></canvas></div></div></div>
    <div class="card"><div class="card-header"><span class="card-title"><i class="fas fa-cog" style="color:var(--muted)"></i> Gearbox</span></div><div class="card-body"><div class="chart-h-sm"><canvas id="cGearbox"></canvas></div></div></div>
  </div>

  <!-- MAKE & PRICE ANALYSIS -->
  <div class="section-title">ðŸš— Make & Value Analysis</div>
  <div class="grid-2">
    <div class="card"><div class="card-header"><span class="card-title"><i class="fas fa-chart-bar" style="color:var(--accent2)"></i> Top 10 Makes by Volume</span></div><div class="card-body"><div class="chart-h-md"><canvas id="cMakes"></canvas></div></div></div>
    <div class="card"><div class="card-header"><span class="card-title"><i class="fas fa-pound-sign" style="color:var(--accent)"></i> Top Makes by Total Value</span></div><div class="card-body"><div class="chart-h-md"><canvas id="cMakeValue"></canvas></div></div></div>
  </div>

  <!-- PRICE BANDS -->
  <div class="section-title">ðŸ’· Price Distribution</div>
  <div class="grid-2">
    <div class="card"><div class="card-header"><span class="card-title"><i class="fas fa-chart-area" style="color:var(--green)"></i> Stock by Price Band</span></div><div class="card-body"><div class="chart-h-md"><canvas id="cPriceBand"></canvas></div></div></div>
    <div class="card"><div class="card-header"><span class="card-title"><i class="fas fa-tachometer-alt" style="color:var(--orange)"></i> Stock by Mileage Band</span></div><div class="card-body"><div class="chart-h-md"><canvas id="cMileage"></canvas></div></div></div>
  </div>

  <!-- TABLES -->
  <div class="section-title">ðŸ“‹ Business Intelligence Tables</div>
  <div class="grid-2">
    <!-- Top makes table -->
    <div class="card">
      <div class="card-header"><span class="card-title"><i class="fas fa-trophy" style="color:var(--accent)"></i> Makes by Stock Value</span></div>
      <table class="ac-table">
        <thead><tr><th>Make</th><th>Count</th><th>Total Value</th><th>Avg Price</th><th>% of Stock</th></tr></thead>
        <tbody id="tMakes"></tbody>
      </table>
    </div>
    <!-- MOT expiry -->
    <div class="card">
      <div class="card-header"><span class="card-title"><i class="fas fa-calendar-times" style="color:var(--red)"></i> MOT Expiring Next 60 Days</span><span id="motBadge" class="badge badge-red">0</span></div>
      <div style="max-height:320px;overflow-y:auto">
        <table class="ac-table">
          <thead><tr><th>Stock No</th><th>Reg</th><th>Vehicle</th><th>MOT Date</th><th>Days Left</th><th>Location</th></tr></thead>
          <tbody id="tMOT"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="grid-2" style="margin-top:18px">
    <!-- No price vehicles -->
    <div class="card">
      <div class="card-header"><span class="card-title"><i class="fas fa-exclamation-triangle" style="color:var(--orange)"></i> Vehicles Without Price</span><span id="noPriceBadge" class="badge badge-orange">0</span></div>
      <div style="max-height:280px;overflow-y:auto">
        <table class="ac-table">
          <thead><tr><th>Stock No</th><th>Reg</th><th>Vehicle</th><th>Status</th><th>Location</th></tr></thead>
          <tbody id="tNoPrice"></tbody>
        </table>
      </div>
    </div>
    <!-- Location breakdown -->
    <div class="card">
      <div class="card-header"><span class="card-title"><i class="fas fa-warehouse" style="color:var(--accent2)"></i> Stock by Location</span></div>
      <table class="ac-table">
        <thead><tr><th>Location</th><th>Count</th><th>Total Value</th><th>% of Stock</th></tr></thead>
        <tbody id="tLocation"></tbody>
      </table>
    </div>
  </div>

</main>

<script>
const vehicles = getVehicles();

function motDays(s) {
  if (!s) return null;
  const p = s.split('/');
  if (p.length!==3) return null;
  return Math.ceil((new Date(p[2],p[1]-1,p[0]) - Date.now())/86400000);
}

function statusBadge(s) {
  const m={'In Stock':'badge-green','In Transit':'badge-orange','Off-site R':'badge-red','Subject to':'badge-yellow'};
  return `<span class="badge ${m[s]||'badge-gray'}">${s||'?'}</span>`;
}

function buildKPIs() {
  const withPrice = vehicles.filter(v=>v.price>0);
  const totalVal = withPrice.reduce((s,v)=>s+(v.price||0),0);
  const avgMiles = vehicles.filter(v=>parseInt(v.mileage)>0);
  const motAlerts = vehicles.filter(v=>{const d=motDays(v.mot);return d!==null&&d<=60;}).length;
  document.getElementById('aTotal').textContent = vehicles.length;
  document.getElementById('aTotalVal').textContent = formatGBP(totalVal);
  document.getElementById('aAvgPrice').textContent = withPrice.length ? formatGBP(totalVal/withPrice.length) : 'â€”';
  document.getElementById('aAvgMiles').textContent = avgMiles.length ? Math.round(avgMiles.reduce((s,v)=>s+parseInt(v.mileage||0),0)/avgMiles.length).toLocaleString() : 'â€”';
  document.getElementById('aMOTAlerts').textContent = motAlerts;
  document.getElementById('analyticsSubtitle').textContent = `${vehicles.length} vehicles Â· Total value ${formatGBP(totalVal)} Â· Updated ${new Date().toLocaleTimeString('en-GB')}`;
}

const COLORS = ['#3b7ff5','#e8b84b','#22c55e','#ef4444','#f97316','#a78bfa','#06b6d4','#f43f5e','#84cc16','#fb923c'];

function donutChart(id, labels, data, colors) {
  new Chart(document.getElementById(id), {
    type:'doughnut',
    data:{labels,datasets:[{data,backgroundColor:colors||COLORS,borderWidth:0}]},
    options:{responsive:true,maintainAspectRatio:false,cutout:'60%',
      plugins:{legend:{position:'bottom',labels:{color:'#94a3b8',font:{size:10},padding:6,boxWidth:10}}}}
  });
}

function barChart(id, labels, data, colors, horizontal=false) {
  new Chart(document.getElementById(id), {
    type:'bar',
    data:{labels,datasets:[{data,backgroundColor:colors||'#3b7ff5',borderRadius:4}]},
    options:{responsive:true,maintainAspectRatio:false,indexAxis:horizontal?'y':'x',
      plugins:{legend:{display:false}},
      scales:{
        x:{grid:{color:'rgba(255,255,255,0.05)'},ticks:{color:'#64748b',font:{size:11}}},
        y:{beginAtZero:true,grid:{color:'rgba(255,255,255,0.05)'},ticks:{color:'#64748b',font:{size:11}}}
      }}
  });
}

function buildCharts() {
  // Status
  const statusCounts={};
  vehicles.forEach(v=>{statusCounts[v.status||'Unknown']=(statusCounts[v.status||'Unknown']||0)+1});
  const sColors={'In Stock':'#22c55e','In Transit':'#f97316','Off-site R':'#ef4444','Subject to':'#e8b84b','Unknown':'#64748b'};
  donutChart('cStatus',Object.keys(statusCounts),Object.values(statusCounts),Object.keys(statusCounts).map(s=>sColors[s]||'#64748b'));

  // Location
  const locCounts={};
  vehicles.forEach(v=>{const l=v.location||'Unknown';locCounts[l]=(locCounts[l]||0)+1});
  const topLocs=Object.entries(locCounts).sort((a,b)=>b[1]-a[1]).slice(0,6);
  donutChart('cLocation',topLocs.map(l=>l[0]),topLocs.map(l=>l[1]));

  // Fuel
  const fuelCounts={};
  vehicles.forEach(v=>{const f=v.fuel||'Unknown';fuelCounts[f]=(fuelCounts[f]||0)+1});
  donutChart('cFuel',Object.keys(fuelCounts),Object.values(fuelCounts));

  // Gearbox
  const gbCounts={};
  vehicles.forEach(v=>{const g=v.gearbox||'Unknown';gbCounts[g]=(gbCounts[g]||0)+1});
  donutChart('cGearbox',Object.keys(gbCounts),Object.values(gbCounts));

  // Makes volume
  const makeCounts={};
  vehicles.forEach(v=>{makeCounts[v.make]=(makeCounts[v.make]||0)+1});
  const topMakes=Object.entries(makeCounts).sort((a,b)=>b[1]-a[1]).slice(0,10);
  barChart('cMakes',topMakes.map(m=>m[0]),topMakes.map(m=>m[1]),COLORS);

  // Makes value
  const makeVal={};
  vehicles.forEach(v=>{if(v.price)makeVal[v.make]=(makeVal[v.make]||0)+v.price});
  const topMakeVal=Object.entries(makeVal).sort((a,b)=>b[1]-a[1]).slice(0,10);
  new Chart(document.getElementById('cMakeValue'),{
    type:'bar',
    data:{labels:topMakeVal.map(m=>m[0]),datasets:[{data:topMakeVal.map(m=>m[1]),backgroundColor:COLORS,borderRadius:4}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},
      scales:{x:{grid:{color:'rgba(255,255,255,0.05)'},ticks:{color:'#64748b',font:{size:11}}},
              y:{beginAtZero:true,grid:{color:'rgba(255,255,255,0.05)'},ticks:{color:'#64748b',font:{size:11},callback:v=>formatGBP(v)}}}}
  });

  // Price bands
  const bands={'Under Â£5k':0,'Â£5kâ€“Â£10k':0,'Â£10kâ€“Â£15k':0,'Â£15kâ€“Â£20k':0,'Â£20kâ€“Â£30k':0,'Â£30k+':0};
  vehicles.filter(v=>v.price>0).forEach(v=>{
    if(v.price<5000)bands['Under Â£5k']++;
    else if(v.price<10000)bands['Â£5kâ€“Â£10k']++;
    else if(v.price<15000)bands['Â£10kâ€“Â£15k']++;
    else if(v.price<20000)bands['Â£15kâ€“Â£20k']++;
    else if(v.price<30000)bands['Â£20kâ€“Â£30k']++;
    else bands['Â£30k+']++;
  });
  barChart('cPriceBand',Object.keys(bands),Object.values(bands),['#22c55e','#3b7ff5','#a78bfa','#e8b84b','#f97316','#ef4444']);

  // Mileage bands
  const miles={'0â€“10k':0,'10kâ€“30k':0,'30kâ€“50k':0,'50kâ€“80k':0,'80kâ€“120k':0,'120k+':0};
  vehicles.forEach(v=>{
    const m=parseInt(v.mileage||0);
    if(m<10000)miles['0â€“10k']++;
    else if(m<30000)miles['10kâ€“30k']++;
    else if(m<50000)miles['30kâ€“50k']++;
    else if(m<80000)miles['50kâ€“80k']++;
    else if(m<120000)miles['80kâ€“120k']++;
    else miles['120k+']++;
  });
  barChart('cMileage',Object.keys(miles),Object.values(miles),['#22c55e','#3b7ff5','#a78bfa','#e8b84b','#f97316','#ef4444']);
}

function buildTables() {
  // Makes by value
  const makeData={};
  vehicles.forEach(v=>{
    if(!makeData[v.make])makeData[v.make]={count:0,value:0};
    makeData[v.make].count++;
    if(v.price)makeData[v.make].value+=v.price;
  });
  const totalVal=vehicles.reduce((s,v)=>s+(v.price||0),0);
  const sortedMakes=Object.entries(makeData).sort((a,b)=>b[1].value-a[1].value).slice(0,12);
  document.getElementById('tMakes').innerHTML=sortedMakes.map(([make,d])=>`<tr>
    <td style="font-weight:600">${make}</td>
    <td>${d.count}</td>
    <td>${formatGBP(d.value)}</td>
    <td>${d.count?formatGBP(d.value/d.count):'â€”'}</td>
    <td style="color:var(--muted)">${totalVal?((d.value/totalVal)*100).toFixed(1)+'%':'â€”'}</td>
  </tr>`).join('');

  // MOT expiring
  const motSoon=vehicles.filter(v=>{const d=motDays(v.mot);return d!==null&&d<=60;})
    .map(v=>({...v,days:motDays(v.mot)})).sort((a,b)=>a.days-b.days);
  document.getElementById('motBadge').textContent=motSoon.length;
  document.getElementById('tMOT').innerHTML=motSoon.map(v=>`<tr>
    <td style="color:var(--accent2);font-weight:600">${v.stockNo}</td>
    <td><span class="reg-plate">${v.registration}</span></td>
    <td>${v.make} ${v.model}</td>
    <td style="font-size:12px">${v.mot}</td>
    <td style="font-weight:700;color:${v.days<0?'var(--red)':v.days<30?'var(--orange)':'var(--accent)'}">${v.days<0?'EXPIRED':v.days+'d'}</td>
    <td style="font-size:12px;color:var(--muted)">${v.location||'â€”'}</td>
  </tr>`).join('') || '<tr><td colspan="6" style="text-align:center;color:var(--muted);padding:20px">No MOT alerts</td></tr>';

  // No price
  const noPrice=vehicles.filter(v=>!v.price&&v.status!=='Sold');
  document.getElementById('noPriceBadge').textContent=noPrice.length;
  document.getElementById('tNoPrice').innerHTML=noPrice.slice(0,20).map(v=>`<tr>
    <td style="color:var(--accent2);font-weight:600">${v.stockNo}</td>
    <td><span class="reg-plate">${v.registration}</span></td>
    <td>${v.make} ${v.model}</td>
    <td>${statusBadge(v.status)}</td>
    <td style="font-size:12px;color:var(--muted)">${v.location||'â€”'}</td>
  </tr>`).join('') || '<tr><td colspan="5" style="text-align:center;color:var(--green);padding:20px">âœ“ All vehicles have prices</td></tr>';

  // Location breakdown
  const locData={};
  vehicles.forEach(v=>{
    const l=v.location||'Unknown';
    if(!locData[l])locData[l]={count:0,value:0};
    locData[l].count++;
    if(v.price)locData[l].value+=v.price;
  });
  const totalCount=vehicles.length;
  const sortedLocs=Object.entries(locData).sort((a,b)=>b[1].count-a[1].count);
  document.getElementById('tLocation').innerHTML=sortedLocs.map(([loc,d])=>`<tr>
    <td style="font-weight:600">${loc}</td>
    <td>${d.count}</td>
    <td>${formatGBP(d.value)}</td>
    <td style="color:var(--muted)">${((d.count/totalCount)*100).toFixed(1)}%</td>
  </tr>`).join('');
}

buildKPIs();
buildCharts();
buildTables();
</script>


<script>
// â”€â”€ No login required â€” review mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', function() {
  var b = document.getElementById('userBadge');
  if (b) b.textContent = 'AUTO CAPITAL';
});
function doLogout() { window.location.href = './login.html'; }
</script>
</body>
</html>
