<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inventory | CapeEye Auto Capital</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow:wght@300;400;500;600;700;800&family=Barlow+Condensed:wght@500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="./firebase-config.js"></script>
<script src="./ac-data.js"></script>
<style>
:root{--bg:#0b0e15;--bg2:#111622;--bg3:#1a2035;--border:rgba(255,255,255,0.07);--accent:#e8b84b;--accent2:#3b7ff5;--green:#22c55e;--red:#ef4444;--orange:#f97316;--text:#f1f5f9;--muted:#64748b;--card-radius:12px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Barlow',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
.header{background:var(--bg2);border-bottom:1px solid var(--border);padding:0 28px;height:64px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
.logo-area{display:flex;align-items:center;gap:14px}
.logo-area img{height:40px;width:auto}
.logo-divider{width:1px;height:32px;background:var(--border)}
.system-name{font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:700;letter-spacing:2px;color:var(--accent)}
.nav{display:flex;gap:4px}
.nav a{padding:8px 16px;border-radius:8px;font-size:14px;font-weight:500;color:var(--muted);text-decoration:none;transition:all .2s}
.nav a:hover,.nav a.active{background:var(--bg3);color:var(--text)}
.nav a.active{color:var(--accent)}
.header-right{display:flex;align-items:center;gap:12px}
.user-badge{background:var(--accent);color:#000;font-weight:700;font-size:12px;padding:4px 12px;border-radius:20px;letter-spacing:1px}
.main{max-width:1600px;margin:0 auto;padding:28px}
.page-title{margin-bottom:24px;display:flex;align-items:center;justify-content:space-between}
.page-title h1{font-family:'Barlow Condensed',sans-serif;font-size:32px;font-weight:800;letter-spacing:1px}
.card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--card-radius);overflow:hidden}
.card-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.card-title{font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:700;letter-spacing:.5px;text-transform:uppercase}
.filters{display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr auto;gap:10px;padding:16px 20px;background:var(--bg2);border-bottom:1px solid var(--border)}
.filter-input{background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:9px 14px;color:var(--text);font-size:13px;font-family:'Barlow',sans-serif;outline:none;width:100%}
.filter-input:focus{border-color:var(--accent2)}
.filter-input::placeholder{color:var(--muted)}
.btn{padding:9px 18px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;border:none;font-family:'Barlow',sans-serif;transition:all .2s}
.btn-primary{background:var(--accent2);color:#fff}
.btn-primary:hover{background:#2563eb}
.btn-ghost{background:var(--bg3);border:1px solid var(--border);color:var(--muted)}
.btn-ghost:hover{color:var(--text)}
.ac-table{width:100%;border-collapse:collapse;font-size:13px}
.ac-table th{padding:11px 14px;text-align:left;font-size:11px;letter-spacing:1px;text-transform:uppercase;color:var(--muted);font-weight:600;border-bottom:1px solid var(--border);background:var(--bg2);position:sticky;top:0;cursor:pointer;user-select:none;white-space:nowrap}
.ac-table th:hover{color:var(--text)}
.ac-table td{padding:12px 14px;border-bottom:1px solid rgba(255,255,255,0.04)}
.ac-table tr:hover td{background:rgba(255,255,255,0.02)}
.ac-table tr:last-child td{border-bottom:none}
.badge{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700;letter-spacing:.5px}
.badge-green{background:rgba(34,197,94,.15);color:var(--green)}
.badge-red{background:rgba(239,68,68,.15);color:var(--red)}
.badge-orange{background:rgba(249,115,22,.15);color:var(--orange)}
.badge-blue{background:rgba(59,127,245,.15);color:var(--accent2)}
.badge-yellow{background:rgba(232,184,75,.15);color:var(--accent)}
.badge-gray{background:rgba(100,116,139,.15);color:var(--muted)}
.reg-plate{font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:13px;letter-spacing:1px;background:#f5c518;color:#000;padding:2px 8px;border-radius:4px;display:inline-block}
.pager{display:flex;align-items:center;gap:8px;padding:14px 20px;border-top:1px solid var(--border)}
.pager-btn{padding:6px 12px;border-radius:6px;border:1px solid var(--border);background:var(--bg3);color:var(--muted);cursor:pointer;font-size:12px;font-family:'Barlow',sans-serif}
.pager-btn:hover{color:var(--text)}
.pager-btn:disabled{opacity:0.4;cursor:not-allowed}
.pager-info{color:var(--muted);font-size:12px;flex:1;text-align:center}
.kpi-strip{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:20px}
.kpi-mini{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:14px 16px;display:flex;align-items:center;gap:12px}
.kpi-mini-icon{font-size:18px;width:32px;text-align:center}
.kpi-mini-label{font-size:11px;color:var(--muted);font-weight:500}
.kpi-mini-val{font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:800;line-height:1}
</style>
</head>
<body>
<header class="header">
  <div class="logo-area">
    <img src="./autocapital-logo.png" alt="Auto Capital">
    <div class="logo-divider"></div>
    <span class="system-name">CAPEYE</span>
  </div>
    <nav class="nav">
    <a href="./index.html"><i class="fas fa-th-large"></i> Dashboard</a>
    <a href="./inventory.html" class="active"><i class="fas fa-car"></i> Inventory</a>
    <a href="./workflow.html"><i class="fas fa-tasks"></i> Workflow</a>
    <a href="./alerts.html"><i class="fas fa-bell"></i> Alerts</a>
    <a href="./marketing.html"><i class="fas fa-chart-line"></i> Marketing</a>
    <a href="./team.html"><i class="fas fa-users"></i> Team</a>
    <a href="./admin.html"><i class="fas fa-cog"></i> Admin</a>
  </nav>
  <div class="header-right"><span class="user-badge">AUTO CAPITAL</span></div>
</header>

<main class="main">
  <div class="page-title">
    <div>
      <h1>Inventory</h1>
      <p style="color:var(--muted);font-size:14px;margin-top:4px" id="inventorySubtitle">Loading...</p>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-ghost" onclick="exportCSV()"><i class="fas fa-download"></i> Export</button>
    </div>
  </div>

  <!-- KPI STRIP -->
  <div class="kpi-strip">
    <div class="kpi-mini"><div class="kpi-mini-icon" style="color:var(--accent2)">üöó</div><div><div class="kpi-mini-label">Total Vehicles</div><div class="kpi-mini-val" id="sTotal">‚Äî</div></div></div>
    <div class="kpi-mini"><div class="kpi-mini-icon" style="color:var(--green)">‚úÖ</div><div><div class="kpi-mini-label">In Stock</div><div class="kpi-mini-val" id="sInStock">‚Äî</div></div></div>
    <div class="kpi-mini"><div class="kpi-mini-icon" style="color:var(--orange)">üöõ</div><div><div class="kpi-mini-label">In Transit</div><div class="kpi-mini-val" id="sTransit">‚Äî</div></div></div>
    <div class="kpi-mini"><div class="kpi-mini-icon" style="color:var(--accent)">üí∑</div><div><div class="kpi-mini-label">Total Value</div><div class="kpi-mini-val" id="sTotalVal" style="font-size:16px">‚Äî</div></div></div>
    <div class="kpi-mini"><div class="kpi-mini-icon" style="color:var(--accent)">üìä</div><div><div class="kpi-mini-label">Avg Price</div><div class="kpi-mini-val" id="sAvgVal" style="font-size:16px">‚Äî</div></div></div>
  </div>

  <!-- TABLE -->
  <div class="card">
    <div class="filters">
      <input class="filter-input" id="fSearch" placeholder="üîç  Search stock no, reg, make, model, variant..." oninput="applyFilters()">
      <select class="filter-input" id="fStatus" onchange="applyFilters()">
        <option value="">All Status</option>
        <option>In Stock</option>
        <option>In Transit</option>
        <option>Off-site R</option>
        <option>Subject to</option>
      </select>
      <select class="filter-input" id="fMake" onchange="applyFilters()">
        <option value="">All Makes</option>
      </select>
      <select class="filter-input" id="fLocation" onchange="applyFilters()">
        <option value="">All Locations</option>
      </select>
      <select class="filter-input" id="fFuel" onchange="applyFilters()">
        <option value="">All Fuel</option>
        <option>Diesel</option>
        <option>Petrol</option>
        <option>Electric</option>
        <option>Hybrid</option>
      </select>
      <button class="btn btn-ghost" onclick="clearFilters()">Clear</button>
    </div>
    <div style="overflow-x:auto">
      <table class="ac-table">
        <thead>
          <tr>
            <th onclick="sortBy('stockNo')">Stock No ‚Üï</th>
            <th>Reg</th>
            <th onclick="sortBy('make')">Make / Model ‚Üï</th>
            <th>Variant</th>
            <th>Colour</th>
            <th onclick="sortBy('mileage')">Mileage ‚Üï</th>
            <th>Fuel</th>
            <th>Gearbox</th>
            <th onclick="sortBy('price')">Price ‚Üï</th>
            <th>MOT</th>
            <th>Location</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="invBody"></tbody>
      </table>
    </div>
    <div class="pager">
      <button class="pager-btn" id="prevBtn" onclick="changePage(-1)">‚Üê Prev</button>
      <span class="pager-info" id="pagerInfo"></span>
      <button class="pager-btn" id="nextBtn" onclick="changePage(1)">Next ‚Üí</button>
    </div>
  </div>
</main>

<script>
let vehicles = getVehicles();
let filtered = [...vehicles];
let page = 1;
const PAGE_SIZE = 50;
let sortCol = '';
let sortDir = 1;

// Populate filter dropdowns
function populateFilters() {
  const makes = [...new Set(vehicles.map(v=>v.make))].sort();
  const locs = [...new Set(vehicles.map(v=>v.location).filter(Boolean))].sort();
  document.getElementById('fMake').innerHTML = '<option value="">All Makes</option>' + makes.map(m=>`<option>${m}</option>`).join('');
  document.getElementById('fLocation').innerHTML = '<option value="">All Locations</option>' + locs.map(l=>`<option>${l}</option>`).join('');
}

function motDays(motStr) {
  if (!motStr) return null;
  const parts = motStr.split('/');
  if (parts.length !== 3) return null;
  const d = new Date(parts[2], parts[1]-1, parts[0]);
  return Math.ceil((d - Date.now()) / 86400000);
}

function statusBadge(s) {
  const m = {'In Stock':'badge-green','In Transit':'badge-orange','Off-site R':'badge-red','Subject to':'badge-yellow'};
  return `<span class="badge ${m[s]||'badge-gray'}">${s||'Unknown'}</span>`;
}

function applyFilters() {
  const search = document.getElementById('fSearch').value.toLowerCase();
  const status = document.getElementById('fStatus').value;
  const make = document.getElementById('fMake').value;
  const location = document.getElementById('fLocation').value;
  const fuel = document.getElementById('fFuel').value;
  filtered = vehicles.filter(v => {
    if (search && ![v.stockNo,v.registration,v.make,v.model,v.variant,v.colour].some(f=>f&&f.toLowerCase().includes(search))) return false;
    if (status && v.status !== status) return false;
    if (make && v.make !== make) return false;
    if (location && v.location !== location) return false;
    if (fuel && !v.fuel.toLowerCase().includes(fuel.toLowerCase())) return false;
    return true;
  });
  if (sortCol) filtered.sort((a,b) => {
    const av = a[sortCol]||'', bv = b[sortCol]||'';
    return typeof av === 'number' ? (av-bv)*sortDir : String(av).localeCompare(String(bv))*sortDir;
  });
  page = 1;
  render();
}

function clearFilters() {
  ['fSearch','fStatus','fMake','fLocation','fFuel'].forEach(id => document.getElementById(id).value='');
  applyFilters();
}

function sortBy(col) {
  if (sortCol === col) sortDir *= -1;
  else { sortCol = col; sortDir = 1; }
  applyFilters();
}

function changePage(dir) {
  const maxPage = Math.ceil(filtered.length / PAGE_SIZE);
  page = Math.max(1, Math.min(maxPage, page + dir));
  render();
}

function render() {
  const start = (page-1)*PAGE_SIZE;
  const pageVehicles = filtered.slice(start, start+PAGE_SIZE);
  const maxPage = Math.ceil(filtered.length/PAGE_SIZE);

  // KPIs
  document.getElementById('sTotal').textContent = filtered.length;
  document.getElementById('sInStock').textContent = filtered.filter(v=>v.status==='In Stock').length;
  document.getElementById('sTransit').textContent = filtered.filter(v=>v.status==='In Transit').length;
  const total = filtered.reduce((s,v)=>s+(v.price||0),0);
  document.getElementById('sTotalVal').textContent = formatGBP(total);
  const withPrice = filtered.filter(v=>v.price>0);
  document.getElementById('sAvgVal').textContent = withPrice.length ? formatGBP(total/withPrice.length) : '‚Äî';
  document.getElementById('inventorySubtitle').textContent = `${filtered.length} of ${vehicles.length} vehicles ¬∑ Page ${page} of ${maxPage||1}`;

  // Table
  const tbody = document.getElementById('invBody');
  tbody.innerHTML = pageVehicles.map(v => {
    const days = motDays(v.mot);
    const motColor = days === null ? '' : days < 0 ? 'color:var(--red)' : days < 30 ? 'color:var(--orange)' : '';
    return `<tr>
      <td style="font-weight:700;color:var(--accent2);font-family:'Barlow Condensed',sans-serif;font-size:15px">${v.stockNo}</td>
      <td><span class="reg-plate">${v.registration}</span></td>
      <td><div style="font-weight:600">${v.make}</div><div style="font-size:12px;color:var(--muted)">${v.model}</div></td>
      <td style="font-size:12px;color:var(--muted);max-width:200px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${v.variant||'‚Äî'}</td>
      <td style="font-size:12px">${v.colour||'‚Äî'}</td>
      <td style="font-size:13px">${parseInt(v.mileage||0).toLocaleString()}</td>
      <td><span class="badge badge-gray">${v.fuel||'‚Äî'}</span></td>
      <td style="font-size:12px;color:var(--muted)">${v.gearbox||'‚Äî'}</td>
      <td style="font-weight:700;color:${v.price?'var(--text)':'var(--muted)'}">${v.price?formatGBP(v.price):'‚Äî'}</td>
      <td style="font-size:12px;${motColor}">${v.mot||'‚Äî'}</td>
      <td style="font-size:12px;color:var(--muted)">${v.location||'‚Äî'}</td>
      <td>${statusBadge(v.status)}</td>
    </tr>`;
  }).join('');

  // Pager
  document.getElementById('pagerInfo').textContent = `Showing ${start+1}‚Äì${Math.min(start+PAGE_SIZE,filtered.length)} of ${filtered.length} vehicles`;
  document.getElementById('prevBtn').disabled = page <= 1;
  document.getElementById('nextBtn').disabled = page >= maxPage;
}

function exportCSV() {
  const headers = ['Stock No','Registration','Make','Model','Variant','Colour','Mileage','Fuel','Gearbox','Price','MOT','Status','Location'];
  const rows = filtered.map(v => [v.stockNo,v.registration,v.make,v.model,v.variant,v.colour,v.mileage,v.fuel,v.gearbox,v.price,v.mot,v.status,v.location]);
  const csv = [headers, ...rows].map(r => r.map(c => `"${(c||'').toString().replace(/"/g,'""')}"`).join(',')).join('\n');
  const a = document.createElement('a');
  a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
  a.download = 'auto-capital-inventory.csv';
  a.click();
}

populateFilters();
applyFilters();
</script>


<script>
// ‚îÄ‚îÄ No login required ‚Äî review mode ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded', function() {
  var b = document.getElementById('userBadge');
  if (b) b.textContent = 'AUTO CAPITAL';
});
function doLogout() { window.location.href = './login.html'; }
</script>
</body>
</html>
